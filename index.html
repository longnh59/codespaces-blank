<!DOCTYPE html>
<html>
  <head>
    <base target="_self">
    <meta charset="utf-8">
    <title>B√°o c√°o kh√°ch ƒëo√†n 2</title>

    <!-- Font chung cho c·∫£ app + dashboard -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    >

    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      :root {
        /* PALETTE CH√çNH ‚Äì teal gi·ªëng template */
        --green-bg: #edf2f7;          /* n·ªÅn chung */
        --green-main: #0f766e;        /* xanh ch·ªß ƒë·∫°o ƒë·∫≠m h∆°n */
        --green-soft: #a7f3d0;        /* xanh nh·∫°t */
        --border-soft: #e5e7eb;       /* vi·ªÅn nh·∫°t */
        --text-main: #0f172a;         /* m√†u ch·ªØ ch√≠nh */
        --text-muted: #6b7280;        /* ch·ªØ ph·ª• */
        --highlight-num-bg: #fef9c3;  /* √¥ s·ªë n·ªïi b·∫≠t */
        --highlight-num-border: #facc15;

        --danger: #ef4444;
        --danger-soft: #fee2e2;
        --warning-soft: #fef3c7;

        --card-radius: 14px;
        --card-shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
      }

      body {
        font-family: "Hanken Grotesk", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        padding: 20px 28px 32px;
        background:
          radial-gradient(circle at top left, #e0f2fe, #edf2f7 40%, #e5e7eb 85%);
        color: var(--text-main);
        font-size: 16px;
        line-height: 1.5;
        margin: 0;
      }

      h1 {
        margin: 0 0 10px;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      h2 {
        margin: 6px 0 10px;
        font-size: 19px;
        font-weight: 600;
      }

      /* TABS */
      .tab-bar {
        display: inline-flex;
        gap: 8px;
        margin: 14px 0 18px;
        padding: 4px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
      }

      .tab-button {
        padding: 9px 22px;
        border-radius: 999px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 15px;
        color: #4b5563;
        font-weight: 500;
        transition: background 0.15s ease, color 0.15s ease, transform 0.08s ease;
      }

      .tab-button:hover {
        background: #e0f2fe;
        transform: translateY(-1px);
      }

      .tab-button.active {
        background: var(--green-main);
        color: #fff;
        box-shadow: 0 12px 22px rgba(15, 118, 110, 0.35);
      }

      .tab-pane {
        display: none;
      }

      .tab-pane.active {
        display: block;
      }
 /* div cha bao quanh mini-tabs + 2 wrap */
.layout-2col{
  display:flex;
  gap:16px;
  align-items:flex-start;
  flex-wrap: nowrap;
}

.col-left{
  flex: 2;
  min-width: 520px;
}

.hist-box{
  flex: 1.4;
  min-width: 360px;
  max-width: 520px;
  display:flex;
  flex-direction:column;
  position: sticky;
  top: 16px;
}

@media (max-width: 980px){
  .layout-2col{ flex-wrap: wrap; }
  

/* ====== Responsive n√¢ng cao ====== */
.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling: touch; }
.table-wrap table{ min-width: 640px; }

@media (max-width: 680px){
  body{ padding: 10px; }
  .layout-2col{ gap:12px; }
  .col-left{ min-width: 100%; }
  .hist-box{ min-width: 100%; }
  .table-wrap table{ min-width: 520px; }
  .btn{ width: 100%; }
  .btn.btn-sm{ width: auto; }
  .row{ flex-wrap: wrap; }
  .field{ min-width: 100%; }
}

@media (max-width: 420px){
  body{ padding: 8px; font-size: 14px; }
  h1{ font-size: 20px; }
  .card{ padding: 12px; }
  .table-wrap table{ min-width: 460px; }
}

.col-left{ min-width: 100%; }
  .hist-box{ position: relative; top: auto; max-width:none; }
}


.mini-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 8px;
  width: 100%;
}

#histPendingWrap, #histDebtWrap {
  width: 100%;
  flex: 0 0 100%;
}

#tblHistPending, #tblHistShort {
  width: 100%;
}

      /* CARD / LAYOUT */
      .card {
        background: #ffffff;
        border-radius: var(--card-radius);
        padding: 14px 16px 16px;
        margin-bottom: 16px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-soft);
        position: relative;
        overflow: hidden;   /* ƒë·ªÉ v·ªát m√†u ƒÉn theo bo g√≥c card */
      }
      .card.allow-overflow{
        overflow: visible !important;
      }

      .card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        border-radius: 999px;
        background: linear-gradient(to bottom, var(--green-main), #22c55e);
      }

      .card > * {
        position: relative;
        z-index: 1;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 10px;
      }

      .layout-2col {
        display: flex;
        gap: 16px;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      .col-left {
        flex: 2;
        min-width: 520px;
      }

      .col-right {
        flex: 1.5;
        min-width: 360px;
      }

      .field {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      label {
        font-size: 16px;
        margin-bottom: 4px;
        color: var(--text-muted);
        letter-spacing: 0.01em;
      }

      input,
      select {
        padding: 8px 10px;
        font-size: 15px;
        border-radius: 9px;
        border: 1px solid #d1d5db;
        outline: none;
        box-sizing: border-box;
        background: #f9fafb;
        transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      }

      input:focus,
      select:focus {
        border-color: var(--green-main);
        box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.4);
        background: #ffffff;
      }

      input[type="number"],
      input.money-input {
        text-align: right;
      }

      .field > input,
      .field > select,
      .field > button {
        width: 100%;
      }

      .highlight-number {
        background: var(--highlight-num-bg);
        border-color: var(--highlight-num-border);
        font-weight: 600;
      }

      input.error,
      select.error {
        border-color: #ef4444;
        background: #fef2f2;
      }

      /* TABLE */
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 6px;
        border-radius: 10px;
        overflow: hidden;
        background: #ffffff;
      }

      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 7px 8px;
        font-size: 15px;
      }

      th {
        background: #e5f2f7;
        font-weight: 600;
        cursor: pointer;
        color: #374151;
        user-select: none;
        position: relative;
      }

      /* label & icon sort trong th */
      th .th-label {
        display: inline-block;
        vertical-align: middle;
      }

      th .sort-icon {
        display: inline-block;
        margin-left: 4px;
        font-size: 12px;
        opacity: 0.5;
        vertical-align: middle;
        transition: opacity 0.12s ease, transform 0.12s ease;
      }

      th.sortable:hover .sort-icon {
        opacity: 0.9;
      }

      th.sort-asc .sort-icon {
        opacity: 1;
      }

      th.sort-desc .sort-icon {
        opacity: 1;
      }

      th:hover {
        background: #dbeafe;
      }

      td.numeric,
      td.money {
        text-align: right;
      }

      #tblMon tbody tr:nth-child(odd),
      #tblDebtFull tbody tr:nth-child(odd),
      #tblCustomerFull tbody tr:nth-child(odd),
      #tblCustomerHist tbody tr:nth-child(odd),
      #tblHistShort tbody tr:nth-child(odd) {
        background: #f9fafb;
      }
      #tblMon{ overflow: visible !important; }

      #tblMon tbody tr:hover,
      #tblDebtFull tbody tr:hover,
      #tblCustomerFull tbody tr:hover,
      #tblCustomerHist tbody tr:hover,
      #tblHistShort tbody tr:hover {
        background: #ecfdf5;
      }
      .table-wrap{
          border-radius: 10px;
          overflow: hidden;
        }
        .table-wrap table{
          border-radius: 0;
          overflow: visible;
        }


      /* INPUT + ICONS TRONG 1 √î */
      .input-with-icons {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-with-icons input {
        width: 100%;
        padding-right: 60px; /* ch·ª´a ch·ªó cho 2 icon b√™n ph·∫£i */
      }

      .input-with-icons .icon-btn {
        position: absolute;
        right: 32px;
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 0;
        font-size: 17px;
        line-height: 1;
        opacity: 0.75;
        transition: opacity 0.1s ease, transform 0.1s ease;
      }

      .input-with-icons .icon-btn:last-of-type {
        right: 8px;
      }

      .input-with-icons .icon-btn:hover {
        opacity: 1;
        transform: scale(1.1);
      }

      /* BUTTONS */
      button {
        padding: 8px 14px;
        margin: 4px;
        cursor: pointer;
        border-radius: 999px;
        border: none;
        font-size: 15px;
        font-weight: 500;
        transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease, color 0.12s ease;
      }

      button.primary {
        background: var(--green-main);
        color: #fff;
        box-shadow: 0 10px 22px rgba(15, 118, 110, 0.35);
      }

      button.primary:hover {
        background: #115e59;
        transform: translateY(-1px);
      }

      button.secondary {
        background: #e0f2fe;
        color: #0f172a;
      }

      button.secondary:hover {
        background: #bae6fd;
        transform: translateY(-1px);
      }

      button.danger {
        background: var(--danger-soft);
        color: #b91c1c;
      }

      button.danger:hover {
        background: #fecaca;
        transform: translateY(-1px);
      }

      /* STATUS PILL */
      .status-pill {
        display: inline-block;
        padding: 4px 9px;
        border-radius: 999px;
        font-size: 15px;
        font-weight: 500;
      }

      .status-paid {
        background: #dcfce7;
        color: #166534;
      }

      .status-debt {
        background: #fef3c7;
        color: #92400e;
      }

      .status-unpaid {
        background: #fee2e2;
        color: #b91c1c;
      }

      .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
      }

      /* LOADING OVERLAY */
      #loadingOverlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(248, 250, 252, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999;
        backdrop-filter: blur(3px);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 120ms ease;
      }
      #loadingOverlay.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .loader-box {
        background: #ffffff;
        border-radius: 10px;
        padding: 10px 16px;
        border: 1px solid var(--border-soft);
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
        font-size: 14px;
        color: var(--text-main);
      }
    /* AUTOCOMPLETE T√äN M√ìN */
      /* B·∫ÆT BU·ªòC: cho container ch·ª©a autocomplete "cho ph√©p tr√†n" */
.ac-box{
  position: relative !important;
  overflow: visible !important;
  z-index: 30000 !important; /* n√¢ng c·∫£ box l√™n */
}

/* N·∫øu .row / .field / card wrapper ƒëang overflow hidden => s·∫Ω clip dropdown */
.row, .field{
  overflow: visible !important;
}

/* Dropdown list */
.ac-list{
  position: absolute !important;
  left: 0 !important;
  right: 0 !important;

  /* hi·ªán ng∆∞·ª£c l√™n tr√™n input */
  top: auto !important;
  bottom: calc(100% - 27px) !important;

  background: #fff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 10px !important;
  box-shadow: 0 14px 34px rgba(15,23,42,.14) !important;

  max-height: 260px !important;
  overflow: auto !important;

  z-index: 999999 !important;
  display: none;
}

/* (Khuy√™n th√™m) ƒë·ªÉ item kh√¥ng b·ªã ‚Äúd√≠nh‚Äù v√†o layout kh√°c */
.ac-list *{
  position: relative;
  z-index: 1;
}

      .ac-item{
    cursor: pointer;
  position: relative;
padding:10px 12px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  font-size:14px;
  border-left: 3px solid transparent;
  transition: background .12s ease, border-color .12s ease, transform .08s ease;
}
.ac-item + .ac-item{ border-top: 1px solid rgba(229,231,235,.75); }
.ac-item:hover,
.ac-item.active{
  background: rgba(15,118,110,.08);
  border-left-color: var(--green-main);
}

.ac-item:hover::after,
.ac-item.active::after{
  content: "‚Üµ";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
  color: rgba(15,118,110,.9);
}

.ac-item:active{ transform: translateY(1px); }
.ac-left{ min-width:0; }
.ac-name{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ac-sub{ color:#6b7280; font-size:13px; margin-top:2px; }
.ac-price{ white-space:nowrap; font-weight:800; color:#065f46; }

      .spinner {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid var(--green-soft);
        border-top-color: var(--green-main);
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to   { transform: rotate(360deg); }
      }

      /* THANH T·ªîNG H·ª¢P */
      .summary-bar {
        margin: 4px 0 8px;
        padding: 7px 12px;
        background: #ecfdf5;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        font-size: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
      }

      .summary-item {
        white-space: nowrap;
        color: #065f46;
      }

      .hist-row,
      .cust-hist-row {
        cursor: pointer;
      }

      .hist-row:hover,
      .cust-hist-row:hover {
        background: #ecfdf5;
      }

      .hist-row.selected,
      .cust-hist-row.selected,
      #tblCustomerFull tbody tr.selected {
        background: #d1fae5 !important;
      }

      #orderErrors {
        color: #b3261e;
        font-size: 14px;
        margin-top: 6px;
      }

      /* POPUP EDIT / DETAIL / PAYMENT */
      #editPopupOverlay,
      #paymentPopupOverlay,
      #detailPopupOverlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.38);
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding: 0;
        overflow: hidden;
        z-index: 10040;
        backdrop-filter: blur(2px);
      }
      #editPopupOverlay .edit-popup,
      #paymentPopupOverlay .edit-popup,
      #detailPopupOverlay .edit-popup{
        margin: 18px auto;
        max-height: calc(100vh - 36px);
      }
      /* Overlay ƒë·ªïi m·∫≠t kh·∫©u: ·∫©n m·∫∑c ƒë·ªãnh, ph·ªß full m√†n, ƒë√® l√™n c√°c popup kh√°c */
      #changePasswordOverlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 13000; /* cao h∆°n loadingOverlay (9999) v√† c√°c popup kh√°c */
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(2px);
      }

      .edit-popup {
        background: #ffffff;
        border-radius: 14px;
        padding: 14px 16px;
        max-width: 900px;
        width: 95%;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 22px 45px rgba(15, 23, 42, 0.35);
        border: 1px solid var(--border-soft);
        font-size: 15px;
      }

      .edit-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .edit-popup-title {
        font-size: 18px;
        font-weight: 600;
      }

      .edit-popup-close {
        border: none;
        background: transparent;
        font-size: 22px;
        cursor: pointer;
        line-height: 1;
      }

      #editItemsTable th,
      #editItemsTable td {
        border: 1px solid #e5e7eb;
        padding: 4px 6px;
        font-size: 14px;
      }

      .search-row {
        margin-bottom: 6px;
        display: flex;
        justify-content: flex-end;
      }

      .search-row input {
        max-width: 240px;
      }

      /* DASHBOARD OVERLAY ‚Äì full m√†n h√¨nh, ·∫©n ban ƒë·∫ßu */
      #dashboardOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 11000;
      }

      .dashboard-popup {
        background: #ffffff;
        border-radius: 14px;
        padding: 14px 16px;
        max-width: 1100px;
        width: 96%;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 24px 55px rgba(15, 23, 42, 0.4);
        border: 1px solid var(--border-soft);
      }

      .dashboard-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .dashboard-popup-title {
        font-size: 19px;
        font-weight: 600;
      }

      .dashboard-popup-close {
        border: none;
        background: transparent;
        font-size: 22px;
        cursor: pointer;
      }

      /* GPT SLIDER */
      .gpt-slider {
        width: 420px;
        max-width: 90vw;
        height: 100%;
        background: #ffffff;
        box-shadow: -12px 0 30px rgba(15, 23, 42, 0.35);
        border-left: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        padding: 10px 12px;
        box-sizing: border-box;
        font-size: 14px;
        transform: translateX(100%);
        transition: transform 0.25s ease-out;
      }

      #gptSliderOverlay.open .gpt-slider {
        transform: translateX(0);
      }

      .gpt-slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .gpt-slider-title {
        font-size: 16px;
        font-weight: 600;
      }

      .gpt-close-btn {
        border: none;
        background: transparent;
        font-size: 22px;
        cursor: pointer;
        line-height: 1;
      }

      .gpt-chat-history {
        flex: 1;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 6px 8px;
        margin-bottom: 6px;
        overflow-y: auto;
        font-size: 14px;
        background: #f9fafb;
      }

      .gpt-input {
        width: 100%;
        min-height: 70px;
        max-height: 160px;
        resize: vertical;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        padding: 6px 8px;
        font-size: 14px;
        box-sizing: border-box;
        background: #ffffff;
      }

      .gpt-footer {
        margin-top: 6px;
        display: flex;
        justify-content: flex-end;
        gap: 6px;
      }

      .gpt-reset-btn,
      .gpt-send-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 13px;
      }

      .gpt-reset-btn {
        background: #e5e7eb;
        color: #111827;
      }

      .gpt-reset-btn:hover {
        background: #d1d5db;
      }

      .gpt-send-btn {
        background: #16a34a;
        color: #ffffff;
        box-shadow: 0 8px 18px rgba(22, 163, 74, 0.3);
      }

      .gpt-send-btn:hover {
        background: #15803d;
      }

      .gpt-error {
        margin-top: 4px;
        font-size: 13px;
        color: #b91c1c;
      }

      /* PAYMENT */
      .payment-field-label {
        font-size: 16px;
        color: var(--text-muted);
        margin-bottom: 2px;
      }

      .payment-field-value {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .payment-inline {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .payment-inline .field {
        min-width: 180px;
      }

      .payment-error {
        color: #b3261e;
        font-size: 14px;
        margin-top: 6px;
      }

      /* MODAL (l·ªãch s·ª≠ c√¥ng n·ª£) */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.38);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10050;
        backdrop-filter: blur(2px);
      }

      .modal-content {
        background: #ffffff;
        border-radius: 14px;
        padding: 14px 16px;
        max-width: 900px;
        width: 95%;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 22px 45px rgba(15, 23, 42, 0.35);
        border: 1px solid var(--border-soft);
        font-size: 15px;
      }

      .table-compact th,
      .table-compact td {
        font-size: 16px;
        padding: 5px 6px;
      }

  .change-pwd-card {
    background: #ffffff;
    border-radius: 16px;
    padding: 18px 20px 20px;
    max-width: 640px;
    width: 92%;
    box-shadow:
      0 24px 55px rgba(15, 23, 42, 0.40),
      0 0 0 1px rgba(148, 163, 184, 0.5);
    border: 1px solid #e5e7eb;
    font-size: 15px;
  }

  .change-pwd-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .change-pwd-title {
    font-size: 18px;
    font-weight: 600;
  }

  .change-pwd-body .field {
    margin-top: 6px;
  }

  .change-pwd-hint {
    margin-top: 8px;
    font-size: 13px;
    color: #6b7280;
  }

  #changePwdError {
    margin-top: 6px;
    font-size: 14px;
    color: #b3261e;
  }
  .row-actions{display:flex; gap:8px; justify-content:center}

.invoice{font-family:'Hanken Grotesk'; color:#111; line-height:1.25}
.inv-head{position:relative; text-align:center; padding:10px 10px 14px}
.inv-brand{font-weight:900; font-size:18px; letter-spacing:.5px}
.inv-sub{font-size:12px; margin-top:2px}
.inv-stamp{position:absolute; right:8px; top:8px; padding:5px 9px; border-radius:10px; font-weight:900; border:2px solid; font-size:12px}
.inv-stamp.paid{color:#16a34a; border-color:#16a34a}
.inv-stamp.unpaid{color:#ef4444; border-color:#ef4444}
.inv-stamp.debt{color:#f59e0b; border-color:#f59e0b}
.inv-title{font-weight:900; font-size:14px; margin-top:6px}
.inv-no{font-weight:800; margin-top:6px}
.inv-meta{font-size:12px; padding:0 6px 10px; display:grid; gap:4px; text-align:left}
/* Gi·ªØ ƒë·ªß 4 g√≥c vi·ªÅn cho b·∫£ng */
.inv-table-wrap{
  overflow: hidden; /* quan tr·ªçng: gi·ªØ g√≥c bo kh√¥ng b·ªã ‚Äúc·ª•t‚Äù */
  margin-top: 8px;
}


.status-pending { background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }


.inv-table th:last-child, .inv-table td:last-child{ border-right: 0; }
.inv-table tr:last-child td{ border-bottom: 0; }

.inv-table{width:100%; border-collapse:collapse; font-size:12px; border-radius:10px !important;border: 1px solid black;overflow:auto}
.inv-table th,.inv-table td{border:1px solid #111; padding:5px; vertical-align:top}
.inv-table th{text-align:left; font-weight:900}

.inv-total{padding:10px 6px 0; font-size:13px}
.inv-total .line{display:flex; justify-content:space-between; padding:6px 0}
.inv-total .grand{font-weight:900; border-top:2px solid #111; margin-top:6px; padding-top:8px; font-size:15px}
.inv-footer{text-align:center; margin-top:12px; font-size:13px; color:#374151}
@page{
  size: A5 portrait;
  margin: 6mm;
}

@media print{
  .inv-wrap, .inv-meta, .inv-table, .inv-table th, .inv-table td{ line-height:1.2 !important; }
  .inv-table th,.inv-table td{ padding:4px !important; font-size:11px !important; }
  .inv-title{ font-size:14px !important; margin-top:4px !important; }
  .inv-no{ margin-top:2px !important; }
  .inv-meta{ font-size:11px !important; gap:2px !important; }

  html, body{ margin:0 !important; padding:0 !important; height:auto !important; }
  body > *:not(#printInvoiceOverlay){ display:none !important; } /* QUAN TR·ªåNG: kh√¥ng ƒë·ªÉ visibility */

  #printInvoiceOverlay{
    position:static !important;
    inset:auto !important;
    display:block !important;
    background:none !important;
  }

  #printInvoiceOverlay .modal-content{
    box-shadow:none !important;
    border:none !important;
    max-width:none !important;
    width:auto !important;
    max-height:none !important;
    overflow:visible !important;
    padding:0 !important;
    margin:0 !important;
  }

  .print-actions{ display:none !important; }

  /* h·∫°n ch·∫ø b·ªã c·∫Øt b·∫£ng */
  table, tr, td, th{ page-break-inside:avoid !important; }
}




    
/* ==== Right panel tables (ƒê∆°n ch·ªù / L·ªãch s·ª≠ ƒë∆°n) ==== */
.right-panel .table-wrap { border: 1px solid var(--border-soft); border-radius: 14px; overflow: hidden; }
.table-compact th, .table-compact td { padding: 9px 10px; font-size: 16px; }
.table-compact thead th { position: sticky; top: 0; z-index: 1; background: #ffffff; }
.table-compact tbody tr:nth-child(even) { background: rgba(15, 118, 110, 0.03); }
.table-compact tbody tr:hover { background: rgba(15, 118, 110, 0.08); }

.icon-btn {
  border: 1px solid var(--border-soft);
  background: #fff;
  border-radius: 10px;
  padding: 6px 8px;
  cursor: pointer;
  line-height: 1;
}
.icon-btn:hover { background: rgba(15, 118, 110, 0.06); }

.status-pill {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 15px;
  border: 1px solid var(--border-soft);
  background: #fff;
}
.status-pending { border-color: rgba(15,118,110,.25); background: rgba(15,118,110,.08); }
.status-paid    { border-color: rgba(16,185,129,.30); background: rgba(16,185,129,.10); }
.status-debt    { border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }
.status-unpaid  { border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.08); }


      body.modal-open{}
    

      /* === AUTOCOMPLETE (ƒë·∫πp + hover r√µ nh∆∞ ngo√†i phi·∫øu nh·∫≠p) === */
      .ac-box { position: relative !important; overflow: visible !important; }

      .ac-list{
        left: 0 !important;
        right: 0 !important;
        bottom: calc(100% - 27px) !important;  /* x·ªï l√™n tr√™n */
        top: auto !important;
        background: #ffffff !important;
        border: 1px solid var(--border-soft) !important;
        border-radius: 12px !important;
        box-shadow: 0 14px 32px rgba(2, 6, 23, 0.12) !important;
        padding: 6px !important;
        max-height: 320px !important;
        overflow: auto !important;
        z-index: 999999 !important;
      }

      .ac-item{
        cursor: pointer !important;
        user-select: none !important;
        border: 1px solid transparent !important;
        border-radius: 10px !important;
        padding: 10px 12px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 10px !important;
      }

      .ac-item + .ac-item{ margin-top: 4px !important; }

      .ac-item .ac-left{
        display: flex !important;
        flex-direction: column !important;
        gap: 2px !important;
        min-width: 0 !important;
      }
      .ac-item .ac-name{
        font-weight: 600 !important;
        color: #0f172a !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      .ac-item .ac-sub{
        font-size: 12px !important;
        color: #64748b !important;
      }
      .ac-item .ac-price{
        font-weight: 700 !important;
        color: #0f766e !important;
        white-space: nowrap !important;
      }

      .ac-item:hover,
      .ac-item.active{
        background: #ecfdf5 !important;
        border-color: #a7f3d0 !important;
        box-shadow: inset 3px 0 0 #10b981 !important;
      }
      /* ===== Fix b·∫£ng chi ti·∫øt m√≥n trong popup: kh√¥ng scroll ngang ===== */

/* 1) Popup kh√¥ng cho tr√†n ngang */
.edit-popup,
#editPopupOverlay .edit-popup,
#pendingEditOverlay .edit-popup{
  max-width: min(1100px, calc(100vw - 24px));
  width: calc(100vw - 24px);
  overflow-x: hidden;
}

/* 2) V√πng ch·ª©a table trong popup */
.edit-popup .table-wrap,
#editPopupOverlay .table-wrap,
#pendingEditOverlay .table-wrap{
  width: 100%;
  overflow-x: hidden;       /* ch·∫∑n ngang */
}

/* 3) Table lu√¥n fit khung + fixed layout ƒë·ªÉ kh√¥ng ‚Äúph√¨nh‚Äù */
.edit-popup table,
#editPopupOverlay table,
#pendingEditOverlay table{
  width: 100% !important;
  table-layout: fixed;      /* c·ª±c quan tr·ªçng */
  border-collapse: separate;
}

/* 4) √î trong b·∫£ng cho ph√©p co l·∫°i */
.edit-popup th,
.edit-popup td{
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* 5) Input/select trong cell lu√¥n co theo cell */
.edit-popup input,
.edit-popup select{
  width: 100% !important;
  max-width: 100% !important;
  min-width: 0 !important;          /* tr√°nh √©p r·ªông */
  box-sizing: border-box;
}

/* 6) Set width theo c·ªôt (b·∫°n c√≥ th·ªÉ ch·ªânh s·ªë n√†y) */
.edit-popup th.col-name, .edit-popup td.col-name { width: 38%; }
.edit-popup th.col-dvt,  .edit-popup td.col-dvt  { width: 14%; }
.edit-popup th.col-sl,   .edit-popup td.col-sl   { width: 12%; }
.edit-popup th.col-dg,   .edit-popup td.col-dg   { width: 18%; }
.edit-popup th.col-tt,   .edit-popup td.col-tt   { width: 18%; }
.edit-popup th.col-del,  .edit-popup td.col-del  { width: 60px; }

/* 7) N·∫øu t√™n m√≥n d√†i, cho ph√©p wrap ri√™ng c·ªôt t√™n (tu·ª≥ ch·ªçn) */
.edit-popup td.col-name{
  white-space: normal;
  line-height: 1.2;
}

    </style>
  </head>
  <body>
    <datalist id="menuDatalist"></datalist>

    <div style="display:flex; justify-content:space-between; flex-direction:row;">
      <h1>B√°o c√°o kh√°ch ƒëo√†n 2</h1>
      <div style="display:flex; gap:10px">
        <button type="button" class="secondary" style="background:#83bee5 !important" onclick="openGptSlider()">
          ü§ñ Chat GPT 
        </button>
        <div style="display:flex; gap:10px; flex-direction:column">
          <small>ƒêƒÉng nh·∫≠p: <?= displayName ?> </small>
          <!-- üö´ T·∫†M ·∫®N N√öT LOGOUT - ƒê√É T·∫ÆT LOGIN -->
          <!-- <button onclick="logout()">ƒêƒÉng xu·∫•t</button> -->
          <small style="color:#666; font-style:italic;">Login t·∫°m t·∫Øt</small>
        </div>
      </div>
    </div>
    
      <div id="printInvoiceOverlay" class="modal" style="display:none; z-index:10060">
        <div class="modal-content" style="max-width:520px; width:95vw;">
          <div class="print-actions" style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;">
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <label style="font-size:13px; color:#334155;display:none">
                  S·ªë h√≥a ƒë∆°n:
                  <input id="invoiceNoInput" type="text" style="display:none;padding:6px 10px; border-radius:10px; border:1px solid #e5e7eb; min-width:170px;">
                </label>

                <label style="font-size:13px; color:#334155;">
                  <input id="printIncludeTax" type="checkbox" checked onchange="rebuildPrintInvoicePreview_()"> T√≠nh thu·∫ø
                </label>

                <button class="secondary" onclick="doPrintInvoice()">In</button>
                <button class="danger" onclick="closePrintInvoice()">ƒê√≥ng</button>
              </div>
            </div>
          <div id="printInvoiceContent"></div>
        </div>
      </div>


    <div class="tab-bar">
      <button class="tab-button active" data-tab="tab-order" onclick="switchTab('tab-order')">Phi·∫øu nh·∫≠p</button>
      <button class="tab-button" data-tab="tab-debt" onclick="switchTab('tab-debt')">Doanh s·ªë</button>
      <button class="tab-button" data-tab="tab-customer" onclick="switchTab('tab-customer')">C√¥ng n·ª£</button>
      <button class="tab-button" data-tab="tab-menu" onclick="switchTab('tab-menu')">Th·ª±c ƒë∆°n</button>
      <button class="tab-button" data-tab="tab-dashboard" onclick="switchTab('tab-dashboard')">Dashboard</button>
    </div>

    <!-- TAB 1: PHI·∫æU NH·∫¨P -->
    <div id="tab-order" class="tab-pane active">
      <div class="layout-2col">
        <div class="col-left">
          <div class="card">
            <h2>Th√¥ng tin chung</h2>
            <div class="row">
              <div class="field">
                <label>Ng√†y b√°n h√†ng</label>
                <input type="date" id="ngay">
              </div>
              <div class="field">
                <label>Ng∆∞·ªùi l·∫≠p phi·∫øu</label>
                <input type="text" id="nguoiLap" placeholder="VD: th√†nh vinh">
              </div>
              <div class="field" style="max-width: 150px; align-self:flex-end;">
                <label>&nbsp;</label>
                <button type="button" class="secondary" style="margin-top:0;" onclick="resetForm()">üÜï T·∫°o ƒë∆°n m·ªõi</button>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Kh√°ch h√†ng &amp; C√¥ng n·ª£</h2>
            <div class="row">
              <div class="field">
                <label>S·ªë ƒëi·ªán tho·∫°i</label>
                <div style="display:flex; gap:6px; align-items:stretch;">
                  <input type="text" id="sdt" placeholder="VD: 0980000000" style="flex:1;">
                  <button type="button" class="secondary" style="margin-top:0;" onclick="onFindCustomer()">T√¨m</button>
                </div>
              </div>
              <div class="field">
                <label>T√™n kh√°ch h√†ng</label>
                <div class="ac-box" id="khAcBox">
                  <input type="text" id="tenKH" autocomplete="off">
                  <div id="khAcList" class="ac-list" style="display:none;"></div>
                </div>
              </div>
              <div class="field" style="flex: 2;">
                <label>ƒê·ªãa ch·ªâ</label>
                <input type="text" id="diaChi">
              </div>
            </div>

            <div class="row">
              <div class="field" >
                <label>S·ªë m√¢m</label>
                <input type="number" id="soMam" min="1" step="1" value="1" class="highlight-number">
              </div>
              <div class="field" >
                <label>ƒê∆°n gi√° 1 m√¢m</label>
                <input type="text" id="donGiaMam" readonly class="highlight-number money-input">
              </div>
              <div class="field">
                <label>T·ªïng ƒë∆°n</label>
                <input type="text" id="tongDon" readonly class="highlight-number money-input">
              </div>
              <div class="field">
                <label>Tr·∫°ng th√°i c√¥ng n·ª£</label>
                <select id="trangThai">
                  <option value="">(Ch∆∞a ch·ªët)</option>
                  <option value="Ghi n·ª£">Ghi n·ª£</option>
                  <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
                  <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field" style="flex:2">
                <label>N·ªôi dung khuy·∫øn m√£i</label>
                <input type="text" id="kmNoiDung">
              </div>
              <div class="field">
                <label>S·ªë ti·ªÅn khuy·∫øn m√£i</label>
                <input type="text" id="kmSoTien" class="money-input">
              </div>
              <div class="field">
                <label>S·ªë ti·ªÅn ƒë·∫∑t c·ªçc</label>
                <input type="text" id="datCoc" class="money-input" placeholder="Nh·∫≠p ti·ªÅn c·ªçc..." >
              </div>
            </div>
          </div>

        <div class="card allow-overflow">
            <h2>Chi ti·∫øt m√≥n</h2>
                <div class="row">
                  <div class="field ac-box">
                    <label>T√¨m m√≥n (g√µ ƒë·ªÉ l·ªçc, click ƒë·ªÉ th√™m)</label>
                    <input type="text" id="orderMenuSearch" placeholder="VD: g√†, nem..." autocomplete="off" spellcheck="false">
                    <div class="ac-list" id="orderMenuList"></div>
                  </div>
                </div>

            <table id="tblMon">
              <thead>
                <tr>
                  <th style="width:32px;">STT</th>
                  <th style="width:190px;">T√™n m√≥n</th>
                  <th style="width:40px;">ƒêVT</th>
                  <th style="width:40px;">SL</th>
                  <th style="width:100px;">ƒê∆°n gi√°</th>
                  <th style="width:120px;">Th√†nh ti·ªÅn</th>
                  <th style="width:40px;"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button type="button" class="secondary" onclick="addEmptyRow()">+ D√≤ng tr·ªëng</button>

            <div class="flex-between">
              <div>
                <button type="button" class="primary" onclick="onSubmit()">üíæ L∆∞u ƒë∆°n</button>
              </div>
              <div style="font-size:13px; color:#567a67;">
                (ƒê∆°n gi√° 1 m√¢m &amp; T·ªïng ƒë∆°n hi·ªÉn th·ªã ·ªü kh·ªëi ‚ÄúKh√°ch h√†ng &amp; C√¥ng n·ª£‚Äù)
              </div>
            </div>

            <div id="orderErrors"></div>
          </div>
        </div>

      
<div class="col-right">
          <div class="card right-panel">
            <h2>ƒê∆°n ch·ªù / L·ªãch s·ª≠ ƒë∆°n</h2>

            <div class="mini-tabs" style="margin-bottom:10px;">
              <button id="rightTabPendingBtn" class="mini-tab active" onclick="switchRightTab('pending')">ƒê∆°n ch·ªù</button>
              <button id="rightTabHistoryBtn" class="mini-tab" onclick="switchRightTab('history')">L·ªãch s·ª≠ ƒë∆°n</button>
            </div>

            <div id="rightPendingWrap">
              <div class="table-wrap">
                <table id="tblPendingRight" class="table table-compact">
                  <thead>
                    <tr>
                      <th>Ng√†y</th>
                      <th>Th√¥ng tin ti·ªác</th>
                      <th>M√¢m</th>
                      <th>T·ªïng</th>
                      <th>Tr·∫°ng th√°i</th>
                      <th>Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div id="rightHistoryWrap" style="display:none;">
              <div class="hint" id="rightHistoryHint">Nh·∫≠p SƒêT v√† b·∫•m ‚ÄúT√¨m‚Äù ·ªü form b√™n tr√°i ƒë·ªÉ xem l·ªãch s·ª≠ ƒë∆°n c·ªßa kh√°ch.</div>
              <div class="table-wrap">
                <table id="tblHistoryRight" class="table table-compact">
                  <thead>
                    <tr>
                      <th>Ng√†y</th>
                      <th>Th√¥ng tin</th>
                      <th>M√¢m</th>
                      <th>T·ªïng</th>
                      <th>Tr·∫°ng th√°i</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div id="historyDetailRight" class="history-detail" style="margin-top:10px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

<!-- TAB 4: DANH M·ª§C H√ÄNG -->
    

    <!-- TAB 2: C√îNG N·ª¢ / DOANH S·ªê -->
<div id="tab-debt" class="tab-pane">
      <div class="card">
        <h2>C√¥ng n·ª£</h2>
        <div class="row">
          <!-- L·ªçc theo SƒêT -->
          <div class="field" style="max-width: 400px;">
            <label>L·ªçc theo SƒêT (·∫©n c√°c d√≤ng kh√¥ng kh·ªõp)</label>
            <div class="input-with-icons">
              <input type="text" id="debtFilterPhone" />
              <button type="button" class="icon-btn" onclick="applyDebtFilter()" title="L·ªçc">
                üîç
              </button>
              <button type="button" class="icon-btn" onclick="clearDebtFilter()" title="Xo√°">
                ‚úñ
              </button>
            </div>
          </div>

          <!-- L·ªçc theo th√°ng -->
          <div class="field" style="max-width: 180px;">
            <label>L·ªçc theo th√°ng</label>
            <select id="debtFilterMonth">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>

          <!-- L·ªçc theo tr·∫°ng th√°i -->
          <div class="field" style="max-width: 180px;">
            <label>L·ªçc theo tr·∫°ng th√°i</label>
            <select id="debtFilterStatus">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>

          <!-- L·ªçc theo thu ng√¢n -->
          <div class="field" style="max-width: 200px;">
            <label>L·ªçc theo thu ng√¢n</label>
            <select id="debtFilterCashier">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>

          <div style="padding-top: 16px; color: red; font-style: italic;">
            *B·∫•m d√≤ng ƒë·ªÉ xem chi ti·∫øt (popup). X√≥a ƒë∆°n ·ªü c·ªôt h√†nh ƒë·ªông.
          </div>
        </div>

        <div id="debtSummary" class="summary-bar"></div>

        <table id="tblDebtFull">
          <thead></thead>
          <tbody></tbody>
        </table>

        <!-- Kh√¥ng hi·ªÉn th·ªã chi ti·∫øt ph√≠a d∆∞·ªõi n·ªØa -->
        <div id="debtDetail" style="margin-top:8px; font-size:16px; display:none;"></div>
      </div>
    </div>

    <!-- TAB 3: KH√ÅCH H√ÄNG -->
    

    <!-- TAB 3: KH√ÅCH H√ÄNG / C√îNG N·ª¢ -->
<div id="tab-customer" class="tab-pane">
      <div class="layout-2col">
        <div class="col-left">
          <div class="card">
            <h2>Danh s√°ch kh√°ch h√†ng</h2>
            <div class="row">
              <div class="field" style="max-width: 330px;">
                <label>L·ªçc theo SƒêT</label>
                <div class="input-with-icons">
                  <input type="text" id="sdtCustomer" />
                  <button
                    type="button"
                    class="icon-btn"
                    onclick="applyCustomerFilter()"
                    title="L·ªçc"
                  >
                    üîç
                  </button>
                  <button
                    type="button"
                    class="icon-btn"
                    onclick="clearCustomerFilter()"
                    title="Xo√°"
                  >
                    ‚úñ
                  </button>
                </div>
              </div>
              <div class="field" style="max-width: 260px;">
                <label>T√¨m ki·∫øm trong danh s√°ch KH</label>
                <input type="text" id="search_tblCustomerFull">
              </div>
              <p style="padding-top: 16px;color:red;font-style: italic;">
                *Ch·ªçn 1 kh√°ch h√†ng ƒë·ªÉ xem l·ªãch s·ª≠ ƒë·∫∑t & t·ªïng ti·ªÅn
              </p>
            </div>
            <div id="customerSummary" class="summary-bar"></div>
            <table id="tblCustomerFull">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="col-right">
          <div class="card">
            <h2>L·ªãch s·ª≠ ƒë∆°n</h2>

            <div class="search-row">
              <input type="text" id="search_tblCustomerHist" placeholder="T√¨m trong l·ªãch s·ª≠ KH">
            </div>

            <table id="tblCustomerHist">
              <thead>
                <tr>
                  <th style="width:80px;">Ng√†y</th>
                  <th>Th√¥ng tin</th>
                  <th style="width:90px;">S·ªë m√¢m</th>
                  <th style="width:90px;">T·ªïng ƒë∆°n</th>
                  <th style="width:90px;">Tr·∫°ng th√°i</th>
                  <th style="width:100px;">Thu n·ª£</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="customerHistDetail" style="margin-top:8px; font-size:16px;"></div>
            <!-- V√ôNG THU N·ª¢ TO√ÄN B·ªò KH√ÅCH H√ÄNG -->
            <div id="customerFullPaymentArea" style="margin-top:8px; font-size:15px;"></div>
          </div>
        </div>
      </div>
    </div>
  <!-- TAB 4: DANH M·ª§C H√ÄNG -->
    

<div id="tab-menu" class="tab-pane">
      <div class="card">
        <div class="flex-between" style="margin-top:0;">
          <h2 style="margin:0;">Th·ª±c ƒë∆°n</h2>
          <div>
            <button type="button" class="primary" onclick="dmAddRow()">‚ûï Th√™m m√≥n</button>
          </div>
        </div>

        <div style="overflow:auto; margin-top:10px;">
          <table id="tblMenu">
            <thead>
              <tr>
                <th style="width:60px;">Row</th>
                <th>T√™n m√≥n</th>
                <th style="width:140px;">ƒêVT</th>
                <th style="width:160px; text-align:right;">Gi√°</th>
                <th style="width:220px;">Lo·∫°i m√≥n</th>
                <th style="width:160px;">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="dmMsg" style="margin-top:8px; font-size:14px;"></div>
      </div>
    </div>
    <!-- TAB DASHBOARD -->
    <div id="tab-dashboard" class="tab-pane">
      <div class="card">
        <?!= include('dashboard_html'); ?>
      </div>
    </div>

    <!-- POPUP S·ª¨A (KH√îNG D√ôNG, ƒê·ªÇ ƒê√ì) -->
    
    <!-- POPUP S·ª¨A ƒê∆†N CH·ªú -->
    <div id="editPopupOverlay" style="display:none;">
      <div class="edit-popup" style="max-width:980px;">
        <div class="edit-popup-header">
          <div class="edit-popup-title">S·ª≠a ƒë∆°n ch·ªù</div>
          <button type="button" class="edit-popup-close" onclick="closePendingEditPopup()">√ó</button>
        </div>

        <input type="hidden" id="peRowIndex">
        <input type="hidden" id="peOrderId">

        <div class="row">
          <div class="field" style="max-width:200px;">
            <label>Ng√†y</label>
            <input type="date" id="peNgay">
          </div>
          <div class="field" style="max-width:260px;">
            <label>Ng∆∞·ªùi l·∫≠p</label>
            <input type="text" id="peNguoiLap" placeholder="VD: th√†nh vinh">
          </div>
          <div class="field" style="max-width:220px;">
            <label>Tr·∫°ng th√°i</label>
            <select id="peTrangThai">
              <option value="">ƒê∆°n ch·ªù</option>
              <option value="Ghi n·ª£">Ghi n·ª£</option>
              <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
              <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field" style="max-width:220px;">
            <label>SƒêT</label>
            <input type="text" id="peSdt" placeholder="VD: 0980000000">
          </div>
          <div class="field">
            <label>T√™n kh√°ch h√†ng</label>
            <input type="text" id="peTenKH">
          </div>
          <div class="field" style="flex:2;">
            <label>ƒê·ªãa ch·ªâ</label>
            <input type="text" id="peDiaChi">
          </div>
        </div>

        <div class="row">
          <div class="field" style="max-width:200px;">
            <label>S·ªë m√¢m</label>
            <input type="number" id="peSoMam" min="0" step="1">
          </div>
          <div class="field">
            <label>N·ªôi dung khuy·∫øn m√£i</label>
            <input type="text" id="peKmNoiDung">
          </div>
          <div class="field" style="max-width:220px;">
            <label>S·ªë ti·ªÅn khuy·∫øn m√£i</label>
            <input type="text" id="peKmSoTien" class="money-input">
          </div>
        </div>
        <div class="row" style="margin-top:2px;">
          <div class="field" style="max-width:220px;">
            <label>ƒê∆°n gi√° / m√¢m</label>
            <input type="text" id="peDonGiaMam" class="money-input" readonly>
          </div>
          <div class="field" style="max-width:240px;">
            <label>T·ªïng ƒë∆°n</label>
            <input type="text" id="peTongDon" class="money-input" readonly>
          </div>
          <div class="field" style="max-width:240px;">
            <label>Doanh s·ªë</label>
            <input type="text" id="peDoanhSo" class="money-input" readonly>
          </div>
          <div class="field" style="max-width:220px;">
          <label>Ti·ªÅn ƒë·∫∑t c·ªçc</label>
          <input type="text" id="peDatCoc" class="money-input">
        </div>
        </div>

        <div class="card allow-overflow" style="margin-top:10px;">
          <h2 style="margin-top:0;">Chi ti·∫øt m√≥n</h2>

          <div class="row">
            <div class="field ac-box" style="max-width: 420px;">
              <label>T√¨m m√≥n (g√µ ƒë·ªÉ l·ªçc, click ƒë·ªÉ th√™m)</label>
              <input type="text" id="peMenuSearch" placeholder="VD: g√†, nem..." autocomplete="off" spellcheck="false">
              <div class="ac-list" id="peMenuList" style="display:none;"></div>
            </div>
            <div class="field" style="max-width:200px; align-self:flex-end;">
              <button type="button" class="secondary" onclick="peAddEmptyRow()">+ D√≤ng tr·ªëng</button>
            </div>
          </div>

          <table id="peTblMon" class="table table-compact">
            <thead>
              <tr>
                <th style ="width:4%">#</th>
                <th class="col-name">T√™n m√≥n</th>
                <th class="col-dvt">ƒêVT</th>
                <th class="col-sl">SL</th>
                <th class="col-dg">ƒê∆°n gi√°</th>
                <th class="col-tt">Th√†nh ti·ªÅn</th>
                <th class="col-del"></th>

              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="flex-between" style="margin-top:12px;">
          <div style="font-size:13px; color:#567a67;">
            * N·∫øu ƒë·ªïi tr·∫°ng th√°i sang Ghi n·ª£/ƒê√£ thanh to√°n/Ch∆∞a thanh to√°n: ƒë∆°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn t·ª´ <b>doncho</b> sang <b>congno</b>.
          </div>
          <div>
            <button type="button" class="secondary" onclick="closePendingEditPopup()">Hu·ª∑</button>
            <button type="button" class="primary" onclick="savePendingEditPopup()">üíæ L∆∞u</button>
          </div>
        </div>

        <div id="peErrors" style="margin-top:8px;"></div>
      </div>
    </div>

<!-- POPUP XEM CHI TI·∫æT ƒê∆†N (TAB C√îNG N·ª¢) -->
    <div id="detailPopupOverlay">
      <div class="edit-popup">
        <div class="edit-popup-header">
          <div class="edit-popup-title">Chi ti·∫øt ƒë∆°n h√†ng</div>
          <button type="button" class="edit-popup-close" onclick="closeDetailPopup()">√ó</button>
        </div>
        <div id="detailPopupContent"></div>
      </div>
    </div>

    <!-- POPUP THU N·ª¢ -->
    <div id="paymentPopupOverlay">
      <div class="edit-popup">
        <div class="edit-popup-header">
          <div class="edit-popup-title">üí∞ Thu n·ª£ ƒë∆°n h√†ng</div>
          <button type="button" class="edit-popup-close" onclick="closePaymentPopup()">√ó</button>
        </div>

        <div id="payError" class="payment-error"></div>

        <div class="card" style="margin-bottom:8px;">
          <div class="row">
            <div class="field" style="max-width:180px;">
              <div class="payment-field-label">Ng√†y</div>
              <div class="payment-field-value" id="payInfoDate"></div>
            </div>
            <div class="field">
              <div class="payment-field-label">Kh√°ch h√†ng</div>
              <div class="payment-field-value" id="payInfoCustomer"></div>
            </div>
          </div>

          <div class="row">
            <div class="field" style="max-width:200px;">
              <div class="payment-field-label">T·ªïng ƒë∆°n</div>
              <div class="payment-field-value" id="payInfoTotal"></div>
            </div>
            <div class="field" style="max-width:200px;">
              <div class="payment-field-label">C√¥ng n·ª£ hi·ªán t·∫°i</div>
              <div class="payment-field-value" id="payInfoDebt"></div>
            </div>
            <div class="field" style="max-width:200px;">
              <div class="payment-field-label">Tr·∫°ng th√°i hi·ªán t·∫°i</div>
              <div class="payment-field-value" id="payInfoStatus"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 style="margin-top:0;">Nh·∫≠p th√¥ng tin thu n·ª£</h2>
                    <div class="payment-inline">
            <div class="field">
              <label>S·ªë ti·ªÅn thanh to√°n</label>
              <input type="text" id="payAmountInput" class="money-input" placeholder="VD: 500000">
            </div>
            <div class="field">
              <label>Khuy·∫øn m√£i th√™m (n·∫øu c√≥)</label>
              <input type="text" id="payPromoInput" class="money-input" placeholder="VD: 100000">
            </div>
            <div class="field">
              <label>Ng√†y thu n·ª£</label>
              <input type="date" id="payDateInput">
            </div>
          </div>
          <div class="flex-between">
            <button type="button" class="secondary" onclick="closePaymentPopup()">H·ªßy</button>
            <button type="button" class="primary" onclick="submitPayment()">‚úÖ X√°c nh·∫≠n thu n·ª£</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL CHI TI·∫æT C√îNG N·ª¢ KH√ÅCH H√ÄNG (popup l·ªãch s·ª≠) -->
    <div id="customerHistoryDetailModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width:900px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 id="chd-title" style="margin:0;">CHI TI·∫æT C√îNG N·ª¢ KH√ÅCH H√ÄNG</h3>
          <button type="button" class="secondary" onclick="closeCustomerHistoryDetail()">‚úñ</button>
        </div>

        <div id="chd-customer" style="margin-bottom:6px; font-size:14px; font-weight:500;">
          <!-- T√™n kh√°ch + SƒêT s·∫Ω set b·∫±ng JS -->
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
          <label> T·ª´ ng√†y:
            <input type="date" id="chd-from">
          </label>
          <label> ƒê·∫øn ng√†y:
            <input type="date" id="chd-to">
          </label>
          <button type="button" class="secondary" onclick="reloadCustomerHistoryDetail()">L·ªçc</button>

          <div id="chd-loading"
               style="display:none; align-items:center; gap:6px; font-size:13px; margin-left:auto;">
            <span class="spinner"></span> ƒêang t·∫£i l·ªãch s·ª≠ c√¥ng n·ª£...
          </div>
        </div>

        <div style="max-height:420px; overflow:auto;">
          <table class="table-compact" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>Ng√†y</th>
                <th>S·ªë ch·ª©ng t·ª´</th>
                <th>Di·ªÖn gi·∫£i</th>
                <th>S·ªë n·ª£ tƒÉng</th>
                <th>S·ªë n·ª£ gi·∫£m</th>
                <th>C√≤n n·ª£</th>
              </tr>
            </thead>
            <tbody id="chd-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- POPUP ƒê·ªîI M·∫¨T KH·∫®U L·∫¶N ƒê·∫¶U -->
<div id="changePasswordOverlay">
  <div class="edit-popup">
    <div class="edit-popup-header">
      <div class="edit-popup-title">ƒê·ªïi m·∫≠t kh·∫©u</div>
      <!-- KH√îNG cho n√∫t ƒë√≥ng ƒë·ªÉ bu·ªôc user ƒë·ªïi, n·∫øu mu·ªën cho th√¨ th√™m n√∫t t·∫°i ƒë√¢y -->
    </div>

    <div style="font-size:14px; margin-bottom:8px; color:#6b7280;">
      B·∫°n c·∫ßn ƒë·ªïi m·∫≠t kh·∫©u m·ªõi tr∆∞·ªõc khi ti·∫øp t·ª•c s·ª≠ d·ª•ng h·ªá th·ªëng.
    </div>

    <div id="changePwdError" class="payment-error"></div>

    <div class="row">
      <div class="field">
        <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
        <input type="password" id="cp-old">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>M·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="cp-new">
      </div>
      <div class="field">
        <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="cp-new2">
      </div>
    </div>

    <div class="flex-between" style="margin-top:10px;">
      <div style="font-size:13px; color:#6b7280;">
        Sau khi ƒë·ªïi th√†nh c√¥ng, l·∫ßn ƒëƒÉng nh·∫≠p sau b·∫°n d√πng m·∫≠t kh·∫©u m·ªõi.
      </div>
      <div>
        <button type="button" class="primary" onclick="submitChangePassword()">
          L∆∞u m·∫≠t kh·∫©u m·ªõi
        </button>
      </div>
    </div>
  </div>
</div>
<!-- TAX CONFIG OVERLAY -->
<div id="configOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; width:min(520px, calc(100% - 24px)); border-radius:14px; padding:14px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
      <div style="font-weight:700; font-size:16px;">C·∫•u h√¨nh</div>
      <button class="secondary small" type="button" onclick="closeTaxConfigOverlay_()">ƒê√≥ng</button>
    </div>

    <label style="display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none;">
      <input id="cfgEnableTax" type="checkbox" onchange="onToggleTaxConfig_()">
      <span>T√≠nh thu·∫ø khi in ho√° ƒë∆°n</span>
    </label>

    <div style="margin-top:6px; color:#6b7280; font-size:13px; line-height:1.35;">
      T·∫Øt: phi·∫øu in b·ªè ph·∫ßn thu·∫ø, T·ªïng thanh to√°n = t·ªïng th√†nh ti·ªÅn (kh√¥ng c·ªông VAT).
    </div>
  </div>
</div>

    <!-- LOADING -->
    <div id="loadingOverlay">
      <div class="loader-box">
        <div class="spinner"></div>
        <div class="loading-text">ƒêang x·ª≠ l√Ω, vui l√≤ng ch·ªù‚Ä¶</div>
      </div>
    </div>

    <script>
      const DEBUG = false;
      if (!DEBUG) {
        try {
          console.log = function(){};
          console.warn = function(){};
        } catch(e) {}
      }
      window.addEventListener("unhandledrejection", function(e){ try{  }catch(_){} e.preventDefault && e.preventDefault(); });
      const CURRENT_USERNAME = "<?= username ?>";
      window.CURRENT_USERNAME = CURRENT_USERNAME;

      const USER_ROLE = ("<?= role ?>" || "").toLowerCase();
      window.USER_ROLE = USER_ROLE;

      // ƒë·ªÉ c√°c h√†m kh√°c d√πng th·ªëng nh·∫•t
      window.CURRENT_ROLE = USER_ROLE;
      const ROLE = USER_ROLE;

      const CAN_EDIT   = (USER_ROLE === "admin" || USER_ROLE === "cashier");
      const CAN_DELETE = (USER_ROLE === "admin");

      const MUST_CHANGE_PASSWORD = '<?= mustChangePassword ? "true" : "false" ?>' === 'true';
      function closeDashboardPopup() {
          switchTab(LAST_NORMAL_TAB || "tab-order");

      }

      let MENU = [];
      let DEBT_FULL = { headers: [], rows: [], rowIndices: [] };
      let CUSTOMERS_FULL = { headers: [], rows: [], agg: {} };
      let DM_LOAI_OPTIONS = [];

      let CURRENT_EDIT_ROW = null;   // kh√¥ng d√πng
      let EDIT_READONLY = false;     // kh√¥ng d√πng

      let CURRENT_PAYMENT_ROW = null;
      let CURRENT_PAYMENT_PHONE = "";
      let CURRENT_PAYMENT_OLD_STATUS = "";
      let CURRENT_PAYMENT_OLD_DEBT = 0;

      let LAST_NORMAL_TAB = "tab-order";
      let CURRENT_PRINT_HEADER = null;
      let CURRENT_PRINT_ROWINDEX = null;

      let MENU_INDEX = {};
      var ST = window.ST || {};
      window.ST = ST;
      ST.PENDING_EDIT_ROW = null;
      ST.HISTORY_TAB = "pending";

        function buildMenuIndex_(){
          MENU_INDEX = {};
          (MENU || []).forEach(m => {
            const k = normalizeTextClient(m.ten);
            if (k) MENU_INDEX[k] = m;
          });
        }

      function switchTab(tabId) {
        document.querySelectorAll(".tab-button").forEach(btn => {
          btn.classList.toggle("active", btn.getAttribute("data-tab") === tabId);
        });
        document.querySelectorAll(".tab-pane").forEach(pane => {
          pane.classList.toggle("active", pane.id === tabId);
        });

        if (tabId !== "tab-dashboard") LAST_NORMAL_TAB = tabId;

        if (tabId === "tab-dashboard") {
          setTimeout(() => {
            if (typeof initDashboard === "function") initDashboard();
            else if (typeof reloadDashboard === "function") reloadDashboard();
          }, 0);
        }
      }
function buildLoaiSelectHtml(current){
  const cur = String(current || "");
  const opts = [];
  const seen = new Set();

  // lu√¥n c√≥ option ch·ªçn
  let html = `<select class="dm-loai" style="width:100%">`;
  html += `<option value="">(ch·ªçn lo·∫°i m√≥n)</option>`;

  // ∆∞u ti√™n current l√™n tr∆∞·ªõc ƒë·ªÉ kh√¥ng b·ªã m·∫•t khi value l·∫°
  if (cur && !seen.has(cur)) { seen.add(cur); opts.push(cur); }
  (DM_LOAI_OPTIONS || []).forEach(v => {
    v = String(v || "").trim();
    if (!v) return;
    if (!seen.has(v)) { seen.add(v); opts.push(v); }
  });

  html += opts.map(v => {
    const sel = (v === cur) ? " selected" : "";
    return `<option value="${escHtml(v)}"${sel}>${escHtml(v)}</option>`;
  }).join("");

  html += `</select>`;
  return html;
}
function enforceMustChangePassword_() {
  const overlay = document.getElementById('changePasswordOverlay');
  const appWrap = document.getElementById('appWrap'); // n·∫øu b·∫°n c√≥ wrapper app, ƒë·ªïi ƒë√∫ng id
  if (!overlay) return;

  if (MUST_CHANGE_PASSWORD) {
    overlay.style.display = 'flex';

    // kh√≥a thao t√°c b√™n d∆∞·ªõi (ƒë·ªÉ login kh√¥ng d√πng ƒë∆∞·ª£c lu√¥n)
    if (appWrap) appWrap.style.pointerEvents = 'none';
  } else {
    overlay.style.display = 'none';
    if (appWrap) appWrap.style.pointerEvents = 'auto';
  }
}


// ===== TAX CONFIG (persisted) =====
let ENABLE_TAX = true;

function isAdmin_(){
  return String(window.CURRENT_ROLE || window.USER_ROLE || "").toLowerCase() === "admin";
}


function syncTaxConfigUI_(){
  const cb = document.getElementById("cfgEnableTax");
  if (cb) cb.checked = !!ENABLE_TAX;
}

function loadTaxConfig_(){
  try{
    google.script.run
      .withSuccessHandler(function(res){
        if (res && typeof res.enabled !== "undefined") ENABLE_TAX = !!res.enabled;
        else ENABLE_TAX = true;
        syncTaxConfigUI_();
      })
      .withFailureHandler(function(){
        ENABLE_TAX = true;
        syncTaxConfigUI_();
      })
      .ui_getTaxConfig();
  }catch(e){
    ENABLE_TAX = true;
    syncTaxConfigUI_();
  }
}

function openConfigPopup(){
  if (!isAdmin_()) return alert("B·∫°n kh√¥ng c√≥ quy·ªÅn admin.");
  syncTaxConfigUI_();
  const ov = document.getElementById("configOverlay");
  if (ov) ov.style.display = "flex";
}

function closeConfigPopup(){
  const ov = document.getElementById("configOverlay");
  if (ov) ov.style.display = "none";
}

function onToggleTaxConfig_(){
  if (!isAdmin_()) return;
  const cb = document.getElementById("cfgEnableTax");
  if (!cb) return;

  const nextVal = !!cb.checked;
  showLoading();

  google.script.run
    .withSuccessHandler(function(res){
      hideLoading();
      if (res && typeof res.enabled !== "undefined") ENABLE_TAX = !!res.enabled;
      else ENABLE_TAX = nextVal;
      syncTaxConfigUI_();
    })
    .withFailureHandler(function(err){
      hideLoading();
      cb.checked = !!ENABLE_TAX; // revert
      alert((err && err.message) ? err.message : err);
    })
    .ui_setTaxConfig(nextVal, window.CURRENT_USERNAME || "");
}
// ===== END TAX CONFIG =====


// ===== AUTOCOMPLETE KH√ÅCH H√ÄNG (T√™n/SƒêT/ƒê·ªãa ch·ªâ) =====
function initCustomerNameAutocomplete_(){
  const inp = document.getElementById("tenKH");
  const listEl = document.getElementById("khAcList");
  const box = document.getElementById("khAcBox");
  if (!inp || !listEl || !box) return;

  let timer = null;
  let items = [];

  function hide(){
    listEl.style.display = "none";
    listEl.innerHTML = "";
    listEl.dataset.activeIndex = "-1";
    items = [];
  }

  function render(arr){
    items = Array.isArray(arr) ? arr : [];
    if (!items.length) { hide(); return; }

    listEl.innerHTML = "";
    items.forEach((it, i) => {
      const div = document.createElement("div");
      div.className = "ac-item";
      const ten = escHtml(it.ten || "(Kh√¥ng t√™n)");
      const sdt = escHtml(it.phone || "");
      const dc  = escHtml(it.diaChi || "");
      div.innerHTML = `
        <div class="ac-left">
          <div class="ac-name">${ten}</div>
          <div class="ac-sub">${dc || ""}</div>
        </div>
        <div class="ac-price">${sdt}</div>
      `;
      div.addEventListener("mouseenter", () => {
        try{
          Array.from(listEl.querySelectorAll(".ac-item")).forEach(x => x.classList.remove("active"));
          div.classList.add("active");
          listEl.dataset.activeIndex = String(i);
        }catch(e){}
      });
      div.addEventListener("mousedown", (ev) => {
        ev.preventDefault();
        pick(i);
      });
      listEl.appendChild(div);
    });

    listEl.style.display = "block";
    listEl.dataset.activeIndex = "-1";
  }

  function pick(idx){
    idx = Number(idx);
    if (!(idx >= 0 && idx < items.length)) return;

    const it = items[idx] || {};
    inp.value = it.ten || "";

    const sdtEl = document.getElementById("sdt");
    const dcEl  = document.getElementById("diaChi");
    const sdt = String(it.phone || "").trim();

    if (sdtEl) sdtEl.value = sdt;
    if (dcEl)  dcEl.value  = it.diaChi || "";

    hide();

    // auto chuy·ªÉn tab ph·∫£i + load l·ªãch s·ª≠ theo SƒêT (kh√¥ng g·ªçi server l·∫°i)
    try{
      if (sdt) {
        if (typeof switchRightTab === "function") switchRightTab("history");
        if (typeof loadHistoryByPhoneRight === "function") loadHistoryByPhoneRight(sdt);
      }
    }catch(e){}
  }

  inp.addEventListener("input", () => {
    const q = String(inp.value || "").trim();
    if (!q) { hide(); return; }

    clearTimeout(timer);
    timer = setTimeout(() => {
      const qq = String(inp.value || "").trim();
      if (!qq) { hide(); return; }

      google.script.run
        .withSuccessHandler(render)
        .withFailureHandler(() => hide())
        .ui_searchCustomers(qq, 12);
    }, 180);
  });

  inp.addEventListener("keydown", (e) => {
    if (listEl.style.display !== "block") return;

    const els = Array.from(listEl.querySelectorAll(".ac-item"));
    if (!els.length) return;

    let idx = Number(listEl.dataset.activeIndex || "-1");

    if (e.key === "ArrowDown") {
      e.preventDefault();
      idx = Math.min(els.length - 1, idx + 1);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      idx = Math.max(0, idx - 1);
    } else if (e.key === "Enter") {
      if (idx >= 0) { e.preventDefault(); pick(idx); }
      return;
    } else if (e.key === "Escape") {
      hide();
      return;
    } else {
      return;
    }

    listEl.dataset.activeIndex = String(idx);
    els.forEach((el, i) => el.classList.toggle("active", i === idx));
    try { els[idx].scrollIntoView({ block: "nearest" }); } catch(e){}
  });

  // click ngo√†i th√¨ ƒë√≥ng
  document.addEventListener("click", (e) => {
    if (e.target === inp || e.target.closest("#khAcBox")) return;
    hide();
  });
}
// ===== END AUTOCOMPLETE KH√ÅCH H√ÄNG =====



document.addEventListener("DOMContentLoaded", () => {
  initDebtFilters();
  initCustomerNameAutocomplete_();
  enforceMustChangePassword_();
  loadTaxConfig_();
});

      function normalizeTextClient(s){
      return String(s || "")
        .replace(/[\u200B-\u200D\uFEFF]/g, "")
        .replace(/\u00A0/g, " ")
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim()
        .toLowerCase();
    }

function menuName_(m){
  return String((m && (m.name || m.ten || m.tenMon || m.ten_mon)) || "").trim();
}
function menuUnit_(m){
  return String((m && (m.unit || m.dvt || m.donViTinh)) || "").trim();
}
function menuPrice_(m){
  return Number((m && (m.price || m.gia || m.donGia || m.dg)) || 0) || 0;
}
function menuType_(m){
  return String((m && (m.type || m.loaiMon || m.loai)) || "").trim();
}


    function acHide(listEl){
      if (!listEl) return;
      listEl.style.display = "none";
      listEl.innerHTML = "";
    }

    function acRenderForRow(tenInput, tr){
      const listEl = tr.querySelector(".ac-list");
      if (!listEl) return;

      const qRaw = tenInput.value || "";
      const q = normalizeTextClient(qRaw);

      if (!q) { acHide(listEl); return; }

      const matches = (MENU || [])
        .map(m => ({ m, key: normalizeTextClient(m.ten) }))
        .filter(x => x.key.includes(q))
        .slice(0, 10);

      if (!matches.length) { acHide(listEl); return; }

      listEl.innerHTML = "";
      matches.forEach(({m}) => {
        const div = document.createElement("div");
        div.className = "ac-item";
        div.innerHTML = `
          <div class="ac-left">
            <div class="ac-name">${escHtml(m.ten)}</div>
            <div class="ac-sub">${escHtml(m.dvt || "ƒêƒ©a")}</div>
          </div>
          <div class="ac-price">${formatMoney(m.gia || 0)} ƒë</div>
        `;
        div.addEventListener("mouseenter", () => { try{ listEl.querySelectorAll(".ac-item.active").forEach(x=>x.classList.remove("active")); div.classList.add("active"); }catch(e){} });
        div.addEventListener("mousedown", (ev) => {
          ev.preventDefault(); // gi·ªØ focus, tr√°nh blur tr∆∞·ªõc khi click
          tenInput.value = m.ten;
          tr.querySelector(".dvt").value = m.dvt || "ƒêƒ©a";
          tr.querySelector(".dg").value  = formatMoney(m.gia || 0);
          tr.dataset.loaiMon = (m.loaiMon || "");
          acHide(listEl);
          recalcTotals();
        });
        listEl.appendChild(div);
      });

      listEl.style.display = "block";
    }

      function parseMoney(val) {
  if (val === null || val === undefined) return 0;
  if (typeof val === "number") return Math.round(val) || 0;

  let s = String(val || "").trim();
  if (!s) return 0;

  s = s.replace(/\s+/g, "");
  s = s.replace(/(vnƒë|vnd|ƒë)/ig, "");
  s = s.replace(/[^\d\-\.,]/g, "");
  if (!s || s === "-" || s === "," || s === ".") return 0;

  if (/^-?\d+(\.\d+)?$/.test(s)) {
    const n = parseFloat(s);
    return isNaN(n) ? 0 : Math.round(n);
  }

  if (s.indexOf(".") !== -1 && s.indexOf(",") !== -1) {
    const lastDot = s.lastIndexOf(".");
    const lastComma = s.lastIndexOf(",");
    if (lastComma > lastDot) {
      const t = s.replace(/\./g, "").replace(/,/g, ".");
      const n = parseFloat(t);
      return isNaN(n) ? 0 : Math.round(n);
    } else {
      const t = s.replace(/,/g, "");
      const n = parseFloat(t);
      return isNaN(n) ? 0 : Math.round(n);
    }
  }

  if (s.indexOf(".") !== -1) {
    const parts = s.split(".");
    const last = parts[parts.length - 1];
    if (last.length <= 2) {
      const n = parseFloat(s);
      return isNaN(n) ? 0 : Math.round(n);
    }
    const n = parseInt(s.replace(/\./g, ""), 10);
    return isNaN(n) ? 0 : n;
  }

  if (s.indexOf(",") !== -1) {
    const parts = s.split(",");
    const last = parts[parts.length - 1];
    if (last.length <= 2) {
      const n = parseFloat(s.replace(/,/g, "."));
      return isNaN(n) ? 0 : Math.round(n);
    }
    const n = parseInt(s.replace(/,/g, ""), 10);
    return isNaN(n) ? 0 : n;
  }

  const n = parseInt(s, 10);
  return isNaN(n) ? 0 : n;
}


      
function formatDateDMY_(v){
  try{
    if (v === null || v === undefined || v === "") return "";

    if (v instanceof Date) {
      const d = v;
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return dd + "/" + mm + "/" + yy;
    }

    const s = String(v).trim();
    if (!s) return "";

    // yyyy-MM-dd / yyyy-MM-ddTHH:mm...
    const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (iso) return iso[3] + "/" + iso[2] + "/" + iso[1];

    // dd/MM/yyyy ho·∫∑c MM/dd/yyyy (ambiguous) -> ∆∞u ti√™n dd/MM theo VN
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) {
      const a = Number(m[1]); // ph·∫ßn 1
      const b = Number(m[2]); // ph·∫ßn 2
      const y = m[3];

      let dd = a, mm = b;

      // N·∫øu ch·∫Øc ch·∫Øn l√† MM/DD (vd 01/14/2026) => swap
      if (a <= 12 && b > 12) { dd = b; mm = a; }

      // N·∫øu a>12 (vd 14/01/2026) => ch·∫Øc ch·∫Øn dd/MM, gi·ªØ nguy√™n
      return String(dd).padStart(2,"0") + "/" + String(mm).padStart(2,"0") + "/" + y;
    }

    return s;
  }catch(e){
    return String(v||"");
  }
}

function lastNonEmptyHeaderIndex_(headers){
  try{
    for (let i = (headers||[]).length - 1; i >= 0; i--){
      const v = String(headers[i] == null ? "" : headers[i]).trim();
      if (v) return i + 1;
    }
  }catch(e){}
  return (headers||[]).length;
}


function formatMoney(v) {
        if (v === null || v === undefined) return "0";
        if (typeof v === "string") v = parseMoney(v);
        else v = Number(v) || 0;
        return Number(v).toLocaleString("en-US", { maximumFractionDigits: 0 });
      }

function coerceGsResponse_(res) {
  // Apps Script ƒë√¥i khi tr·∫£ v·ªÅ:
  //  - object chu·∫©n
  //  - string JSON (th·∫≠m ch√≠ b·ªçc 2 l·ªõp: '"{...}"')
  //  - string ki·ªÉu Map: {ok=true, header={...}, items=[Ljava...]}
  if (res === null || res === undefined) return res;
  if (typeof res === "object") return res;
  if (typeof res !== "string") return res;

  let s = String(res || "").trim();
  if (!s) return res;

  // 1) JSON parse 1 ho·∫∑c 2 l·ªõp
  try {
    const j = JSON.parse(s);
    if (j && typeof j === "object") return j;
    if (typeof j === "string") {
      const s2 = String(j || "").trim();
      if (s2 && (s2[0] === "{" || s2[0] === "[")) {
        try {
          const j2 = JSON.parse(s2);
          if (j2 && typeof j2 === "object") return j2;
        } catch (e2) {}
      }
    }
  } catch (e) {}

  // 2) map-style: {ok=true, invoiceNo=..., includeTax=true, html=..., header={...}}
  if (s[0] === "{" && s.indexOf("=") !== -1) {
    const out = {};
    // ok=true/false
    const okm = s.match(/\bok\s*=\s*(true|false)\b/i);
    if (okm) out.ok = okm[1].toLowerCase() === "true";

    const inv = s.match(/\binvoiceNo\s*=\s*([^,}]+)/i);
    if (inv) out.invoiceNo = String(inv[1] || "").trim();

    const tax = s.match(/\bincludeTax\s*=\s*(true|false)\b/i);
    if (tax) out.includeTax = tax[1].toLowerCase() === "true";

    const err = s.match(/\b(error|message)\s*=\s*([^,}]+)/i);
    if (err) out.error = String(err[2] || "").trim();

    const hStart = s.indexOf("header=");
    if (hStart !== -1) {
      // l·∫•y substring t·ª´ header= t·ªõi tr∆∞·ªõc ', html=' ho·∫∑c cu·ªëi
      const sub = s.substring(hStart);
      const htmlPos = sub.indexOf(", html=");
      const hPart = (htmlPos !== -1) ? sub.substring(0, htmlPos) : sub;
      // parse m·ªôt v√†i field ph·ªï bi·∫øn
      const getField = (k) => {
        const mm = hPart.match(new RegExp(k + "\\s*=\\s*([^,}]+)", "i"));
        return mm ? String(mm[1] || "").trim() : "";
      };
      out.header = {
        date: getField("date"),
        tenKH: getField("tenKH"),
        sdt: getField("sdt"),
        diaChi: getField("diaChi"),
        soMam: getField("soMam"),
        tongDon: getField("tongDon"),
        trangThai: getField("trangThai"),
        status: getField("status"),
        thungan: getField("thungan"),
        orderId: getField("orderId")
      };
    }

    // html=... (c√≥ th·ªÉ ch·ª©a nhi·ªÅu d·∫•u , => l·∫•y t·ª´ 'html=' ƒë·∫øn cu·ªëi)
    const htmlIdx = s.indexOf("html=");
    if (htmlIdx !== -1) {
      out.html = s.substring(htmlIdx + 5);
    }

    return out;
  }

  return res;
}





      function escHtml(str) {
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }
    function initOrderMenuSearch() {
  const inp = document.getElementById("orderMenuSearch");
  const listEl = document.getElementById("orderMenuList");
  if (!inp || !listEl) return;

  function hide() {
    listEl.style.display = "none";
    listEl.innerHTML = "";
  }

  function render() {
    const qRaw = inp.value || "";
    const q = normalizeTextClient(qRaw);
    if (!q) { hide(); return; }

    const matches = (MENU || [])
      .map(m => ({ m, key: normalizeTextClient(m.ten) }))
      .filter(x => x.key.includes(q))
      .slice(0, 12);

    if (!matches.length) { hide(); return; }

    listEl.innerHTML = "";
    matches.forEach(({m}) => {
      const div = document.createElement("div");
      div.className = "ac-item";
      div.innerHTML = `
        <div class="ac-left">
          <div class="ac-name">${escHtml(m.ten)}</div>
          <div class="ac-sub">${escHtml(m.dvt || "ƒêƒ©a")}</div>
        </div>
        <div class="ac-price">${formatMoney(m.gia || 0)} ƒë</div>
      `;

      div.addEventListener("mouseenter", () => { try{ listEl.querySelectorAll(".ac-item.active").forEach(x=>x.classList.remove("active")); div.classList.add("active"); }catch(e){} });
        div.addEventListener("mousedown", (ev) => {
        ev.preventDefault();
        addEmptyRow({ ten: m.ten, dvt: m.dvt, sl: 1, gia: m.gia, loaiMon: (m.loaiMon || "") });
        // KH√îNG auto nh·∫£y v√†o t√™n m√≥n, ch·ªâ add d√≤ng
        // n·∫øu mu·ªën gi·ªØ nguy√™n text ƒëang g√µ: kh√¥ng l√†m g√¨
        // n·∫øu mu·ªën clear sau khi add: inp.value = "";
        hide();
        inp.focus();
      });

      listEl.appendChild(div);
    });

    listEl.style.display = "block";
  }

  inp.addEventListener("input", render);
  inp.addEventListener("focus", render);
  inp.addEventListener("keydown", (e) => { if (e.key === "Escape") hide(); });
  inp.addEventListener("blur", () => setTimeout(hide, 150));
}

  let __LOADING_COUNT = 0;

  function confirmDelete(msg){
  const text = (msg ? String(msg) : "B·∫°n c√≥ ch·∫Øc mu·ªën xo√°?") + "\n\nNh·∫≠p DELETE ƒë·ªÉ x√°c nh·∫≠n.";
  const v = prompt(text, "");
  if (v === null) return false;
  return String(v).trim().toLowerCase() === "delete";
}

let __REFRESH_TIMER = null;
let __REFRESH_PENDING = {};

function scheduleRefreshAll_(opts){
  opts = opts || {};
  try { __REFRESH_PENDING = Object.assign(__REFRESH_PENDING, opts); } catch(e) { __REFRESH_PENDING = opts; }
  if (__REFRESH_TIMER) clearTimeout(__REFRESH_TIMER);
  __REFRESH_TIMER = setTimeout(() => {
    const o = __REFRESH_PENDING || {};
    __REFRESH_PENDING = {};
    __REFRESH_TIMER = null;

    try { if (o.pendingRight && typeof loadPendingAllRight === "function") loadPendingAllRight(); } catch(e) {}
    try { if (o.historyRightSdt && typeof loadHistoryByPhoneRight === "function") loadHistoryByPhoneRight(o.historyRightSdt); } catch(e) {}
    try { if (o.debt && typeof loadDebtFull === "function") loadDebtFull(); } catch(e) {}
    try { if (o.customers && typeof loadCustomersFull === "function") loadCustomersFull(); } catch(e) {}
    try {
      if (o.dashboard) {
        if (typeof loadDashboardData === "function") loadDashboardData();
        else if (typeof reloadDashboard === "function") reloadDashboard();
      }
    } catch(e) {}
  }, 120);
}


function setDisplay_(idOrEl, displayVal){
  const el = (typeof idOrEl === "string") ? document.getElementById(idOrEl) : idOrEl;
  if (el && el.style) el.style.display = displayVal;
  return el;
}

function __getActivePopupBox_(){
    const ov =
      document.getElementById("editPopupOverlay") ||
      document.getElementById("pendingEditOverlay") ||
      document.getElementById("detailPopupOverlay") ||
      document.getElementById("paymentPopupOverlay");
    if (!ov) return null;
    return ov.querySelector(".edit-popup") || null;
  }

  let __LOADING_SNAP = null;

  function __snapScroll_(){
    try{
      const box = __getActivePopupBox_();
      __LOADING_SNAP = {
        x: window.scrollX || 0,
        y: window.scrollY || 0,
        boxY: box ? box.scrollTop : null,
        activeId: (document.activeElement && document.activeElement.id) ? document.activeElement.id : null
      };
    }catch(e){
      __LOADING_SNAP = {x:0,y:0,boxY:null,activeId:null};
    }
  }

  function __restoreScroll_(){
    try{
      if(!__LOADING_SNAP) return;
      window.scrollTo(__LOADING_SNAP.x, __LOADING_SNAP.y);
      const box = __getActivePopupBox_();
      if (box && __LOADING_SNAP.boxY != null) box.scrollTop = __LOADING_SNAP.boxY;
      if (__LOADING_SNAP.activeId) {
        const el = document.getElementById(__LOADING_SNAP.activeId);
        if (el && el.focus) el.focus({ preventScroll: true });
      }
    }catch(e){}
  }

  function showLoading(msg) {
    if(__LOADING_COUNT === 0) __snapScroll_();
    __LOADING_COUNT++;

    const overlay = document.getElementById("loadingOverlay");
    if (!overlay) return;

    const text = overlay.querySelector(".loading-text");
    if (text) text.textContent = msg || "ƒêang x·ª≠ l√Ω...";

    overlay.classList.add("show");

    requestAnimationFrame(__restoreScroll_);
    setTimeout(__restoreScroll_, 0);
  }

  function hideLoading() {
    __LOADING_COUNT = Math.max(0, __LOADING_COUNT - 1);
    if (__LOADING_COUNT > 0) return;

    const overlay = document.getElementById("loadingOverlay");
    if (!overlay) return;

    overlay.classList.remove("show");

    requestAnimationFrame(__restoreScroll_);
    setTimeout(__restoreScroll_, 0);

    __LOADING_SNAP = null;
  }
function hideAnyPopupOverlay_() {
  const ids = ["editPopupOverlay","pendingEditOverlay","detailPopupOverlay","paymentPopupOverlay"];
  for (let i=0;i<ids.length;i++){
    const el = document.getElementById(ids[i]);
    if (el && el.style && (el.style.display === "flex" || el.style.display === "")) {
      el.style.display = "none";
    }
  }
  // fallback: hide any overlay-like node
  const nodes = document.querySelectorAll(".popup-overlay, .modal-overlay, .overlay");
  nodes.forEach(n => { if (n && n.style && n.style.display === "flex") n.style.display = "none"; });

  refreshModalOpenState_();
}
function setModalOpen_(on){ /* keep page scroll; no-op */ }
function refreshModalOpenState_(){
  try{
    const anyOpen = ["editPopupOverlay","pendingEditOverlay","detailPopupOverlay","paymentPopupOverlay"]
      .some(id => {
        const el = document.getElementById(id);
        return el && el.style && el.style.display === "flex";
      });
    setModalOpen_(anyOpen);
  }catch(e){}
}


function setSectionLoading_(hostEl, on, label) {
    if (!hostEl) return;
    hostEl.style.position = hostEl.style.position || "relative";
    let ovs = hostEl.querySelectorAll(".sectionLoadingOverlay");
    let ov = (ovs && ovs.length) ? ovs[0] : null;
    if (ovs && ovs.length > 1) { for (let i = 1; i < ovs.length; i++) { try { ovs[i].remove(); } catch(e) {} } }
    if (!ov) {
      ov = document.createElement("div");
      ov.className = "sectionLoadingOverlay";
      ov.style.cssText = "position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.75);z-index:50;border-radius:8px";
      ov.innerHTML = `<div style="display:flex;gap:8px;align-items:center;font-size:13px">
        <div class="spinner" style="width:16px;height:16px;border:2px solid #999;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div>
        <div class="lbl"></div>
      </div>`;
      hostEl.appendChild(ov);
    }    const lbl = ov.querySelector(".lbl");
    if (lbl && on) lbl.textContent = label || "ƒêang t·∫£i...";

    // ‚úÖ ref-count theo section ƒë·ªÉ tr√°nh ch·ªìng ch√©o (hide s·ªõm khi c√≤n request kh√°c)
    let c = Number(hostEl.dataset.loadingCount || "0") || 0;
    if (on) c += 1;
    else c = Math.max(0, c - 1);
    hostEl.dataset.loadingCount = String(c);

    ov.style.display = (c > 0) ? "flex" : "none";
}

 function gasCallPromise_(fnName, ...args) {
  return new Promise((resolve, reject) => {
    try {
      const runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(reject);
      if (!runner[fnName]) return reject(new Error("GAS function not found: " + fnName));
      runner[fnName](...args);
    } catch (e) {
      reject(e);
    }
  });
}
function _normRows_(res) {
  if (Array.isArray(res)) return res;
  if (res && Array.isArray(res.rows)) return res.rows;
  return [];
}
function _normOk_(res) {
  if (res && typeof res.ok === "boolean") return res.ok;
  // n·∫øu l√† array th√¨ coi nh∆∞ ok
  if (Array.isArray(res)) return true;
  return !!res;
}

  
  function setVal_(id, v){
    try{
      const el = document.getElementById(id);
      if (!el) return;
      el.value = (v == null) ? "" : String(v);
    }catch(e){}
  }

function ymdFromAnyDate_(v) {
    if (!v) return "";
    const s = String(v).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
      const [dd, mm, yyyy] = s.split("/");
      return `${yyyy}-${mm}-${dd}`;
    }
    const d = new Date(s);
    if (!isNaN(d.getTime())) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }
    return "";
  }

function injectPendingPopupStyles_() {
  if (document.getElementById("peStyleInjected")) return;
  const st = document.createElement("style");
  st.id = "peStyleInjected";
  st.textContent = `
    #editPopupOverlay{display:none;align-items:center;justify-content:center;}
    #editPopupOverlay .edit-popup{width:min(1180px,96vw);max-height:92vh;overflow:auto;}
    #editPopupOverlay .table-wrap{overflow-x:hidden;}
    #editPopupOverlay table{width:100%;table-layout:fixed;}
    #editPopupOverlay th,#editPopupOverlay td{word-wrap:break-word;white-space:normal;}
    #editPopupOverlay .row{display:flex;gap:10px;flex-wrap:wrap;}
    #editPopupOverlay .row .field{flex:1;min-width:220px;}
    #editPopupOverlay .footer-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px;position:sticky;bottom:0;background:#fff;padding:10px 0;}
  `;
  document.head.appendChild(st);
}


      function recalcTotals() {
        const tbody = document.querySelector("#tblMon tbody");
        let sum1Mam = 0;
        Array.from(tbody.rows).forEach(tr => {
          const sl = Number(tr.querySelector(".sl").value || 0);
          const dg = parseMoney(tr.querySelector(".dg").value || 0);
          const tt = sl * dg;
          tr.querySelector(".tt").textContent = formatMoney(tt);
          sum1Mam += tt;
        });
        const soMam = Number(document.getElementById("soMam").value || 0);
        const datCocVal = parseMoney(document.getElementById("datCoc").value || "0"); // L·∫•y gi√° tr·ªã c·ªçc
        const donGiaEl = document.getElementById("donGiaMam");
        const tongDonEl = document.getElementById("tongDon");
        const donGiaVal = formatMoney(sum1Mam);
        const tongVal   = formatMoney(sum1Mam * soMam);

        if (donGiaEl) donGiaEl.value = donGiaVal;
        if (tongDonEl) tongDonEl.value = tongVal;
      }

      function attachRowEvents(tr) {
        const tenMonInput = tr.querySelector(".tenMon");
        const slInput     = tr.querySelector(".sl");
        const dgInput     = tr.querySelector(".dg");
        const listEl      = tr.querySelector(".ac-list");

        if (tenMonInput) {
          tenMonInput.addEventListener("input", () => acRenderForRow(tenMonInput, tr));
          tenMonInput.addEventListener("focus", () => acRenderForRow(tenMonInput, tr));
          tenMonInput.addEventListener("keydown", (e) => {
            if (e.key === "Escape") acHide(listEl);
          });
          tenMonInput.addEventListener("blur", () => setTimeout(() => acHide(listEl), 150));
        }

        if (slInput) slInput.addEventListener("input", recalcTotals);

        if (dgInput) {
          dgInput.addEventListener("input", recalcTotals);
          dgInput.addEventListener("blur", () => {
            dgInput.value = formatMoney(parseMoney(dgInput.value));
            recalcTotals();
          });
        }
      }


      function addEmptyRow(item) {
        const tbody = document.querySelector("#tblMon tbody");
        const tr = document.createElement("tr");
        const idx = tbody.rows.length + 1;

        tr.innerHTML = `
          <td class="idx" style="text-align:center;">${idx}</td>

          <td class="ac-box" style="width:190px;">
            <input type="text" class="tenMon" autocomplete="off" spellcheck="false" style="width:100%;">
            <div class="ac-list"></div>
          </td>

          <td><input type="text" class="dvt" style="width:70px"></td>
          <td><input type="number" class="sl" min="1" step="1" style="width:65px" value="1"></td>
          <td><input type="text" class="dg money-input" style="width:95px"></td>
          <td class="tt money" style="text-align:right;">0</td>
          <td style="text-align:center;">
            <button type="button" class="danger" onclick="removeRow(this)">X</button>
          </td>
        `;

        tbody.appendChild(tr);
        tr.dataset.loaiMon = (item && item.loaiMon) ? String(item.loaiMon) : "";

        if (item) {
          tr.querySelector(".tenMon").value = item.ten || "";
          tr.querySelector(".dvt").value    = item.dvt || "ƒêƒ©a";
          tr.querySelector(".sl").value     = item.sl  || 1;
          tr.querySelector(".dg").value     = formatMoney(item.gia || 0);
        } else {
          // n·∫øu kh√¥ng truy·ªÅn item th√¨ ƒë·ªÉ dg = 0 cho r√µ
          tr.querySelector(".dg").value = "0";
        }

        attachRowEvents(tr);
        recalcTotals();
      }


      function removeRow(btn) {
        const tr = btn.closest("tr");
        tr.parentNode.removeChild(tr);
        const tbody = document.querySelector("#tblMon tbody");
        Array.from(tbody.rows).forEach((row, i) => {
          row.querySelector(".idx").textContent = i + 1;
        });
        recalcTotals();
      }

      function onAddItemFromMenu() {
        const sel = document.getElementById("selectMon");
        const idx = sel.value;
        if (!idx) return;
        const item = MENU[Number(idx)];
        addEmptyRow({ ten: item.ten, dvt: item.dvt, sl: 1, gia: item.gia, loaiMon: (item.loaiMon || "") });
        sel.value = "";
      }

function onFindCustomer() {
  const sdt = (document.getElementById("sdt")?.value || "").trim();
  if (!sdt) return alert("Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i tr∆∞·ªõc.");

  showLoading();
  google.script.run
    .withSuccessHandler(cus => {
      hideLoading();

      // ‚úÖ fill t√™n/ƒë·ªãa ch·ªâ ·ªü phi·∫øu nh·∫≠p
      if (cus) {
        const tenEl = document.getElementById("tenKH");
        const dcEl  = document.getElementById("diaChi");
        if (tenEl) tenEl.value = cus.ten || "";
        if (dcEl)  dcEl.value  = cus.diaChi || "";
      }

      // ‚úÖ ch·ªâ l·ªçc l·ªãch s·ª≠ tab ph·∫£i
      switchRightTab("history");
      loadHistoryByPhoneRight(sdt);
    })
    .withFailureHandler(err => {
      hideLoading();
      // v·∫´n cho xem l·ªãch s·ª≠
      switchRightTab("history");
      loadHistoryByPhoneRight(sdt);
    })
    .findCustomerByPhone(sdt);
}





function loadPendingHistory(phone){
  var tbody = document.querySelector("#tblHistPending tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  var p = (phone || "").trim();

  const wrap = document.getElementById('histPendingWrap') || document.getElementById('histPendingWrap') || document.body;
  setSectionLoading_(wrap, true, 'ƒêang t·∫£i ƒë∆°n ch·ªù...');

  var runner = google.script.run
    .withSuccessHandler(function(rows){
      setSectionLoading_(wrap, false);
      if (!rows || !rows.length){
        tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Kh√¥ng c√≥ ƒë∆°n ch·ªù</td></tr>";
        return;
      }

      rows.forEach(function(r){
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>"+ (r.dateStr||r.date||r.ngay||"") +"</td>"+
          "<td class='money'>"+ (r.soMam||0) +"</td>"+
          "<td class='money'>"+ formatMoney(r.tongDon||0) +"</td>"+
          "<td style='white-space:nowrap; text-align:right;'>" +
            "<button type='button' class='secondary' onclick='openPendingEditPopup("+(r.row!=null?r.row:r.rowIndex)+")'>S·ª≠a</button> " +
            "<button type='button' class='secondary' onclick='openPrintPending("+(r.row!=null?r.row:r.rowIndex)+")'>In</button>" +
          "</td>";
        tbody.appendChild(tr);
      });
    })
    .withFailureHandler(function(e){
      setSectionLoading_(wrap, false);
      alert((e && e.message) ? e.message : e);
      tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>L·ªói t·∫£i ƒë∆°n ch·ªù</td></tr>";
    });

  if (p) runner.listPendingByPhone(p);
  else runner.listPendingRecent(50);
}


function savePendingEdit(payload) {
  if (!ST.PENDING_EDIT_ROW) return;

  showLoading("ƒêang l∆∞u...");

  google.script.run
    .withSuccessHandler(function(res){
      hideLoading();
      if (!res || !res.ok) {
        alert((res && res.error) || "L·ªói");
        return;
      }

      closePendingEditPopup();

      // lu√¥n reload danh s√°ch "t·∫•t c·∫£" ƒë·ªÉ admin/cashier th·∫•y ngay
      loadPendingHistory("");

      // l·ªãch s·ª≠: ch·ªâ l·ªçc khi user ƒëang search SƒêT (n·∫øu b·∫°n c√≥ state)
      var phone = (payload && payload.header && payload.header.sdt) ? String(payload.header.sdt).trim() : "";
      if (phone) {
        loadInlineHistory(phone);
      } else {
        loadInlineHistory("");
      }

      if (res.moved) switchHistoryTab("debt");
    })
    .withFailureHandler(function(e){
      hideLoading();
      alert((e && e.message) ? e.message : e);
    })
    console.log(payload)
    .updatePendingOrder(ST.PENDING_EDIT_ROW, payload);
}

function openPrintPending(rowIndex){
  showLoading();
  google.script.run
    .withSuccessHandler(function(res){
      hideLoading();
      if (!res || !res.ok) { alert((res&&res.error)||"L·ªói"); return; }
      // d√πng c√πng render/print nh∆∞ openPrintInvoice hi·ªán t·∫°i
      openInvoicePrintFromDetail(res.header, res.items);
    })
    .withFailureHandler(function(e){ hideLoading(); alert(e.message||e); })
    .getOrderDetailByPendingRow(rowIndex);
}

      function resetForm() {
        document.getElementById("ngay").value = "";
        // lu√¥n set m·∫∑c ƒë·ªãnh = user ƒëang ƒëƒÉng nh·∫≠p
        var nguoiLapEl = document.getElementById("nguoiLap");
        if (nguoiLapEl) {
          nguoiLapEl.value = "<?= displayName ?>";
        }

        document.getElementById("sdt").value = "";
        document.getElementById("tenKH").value = "";
        document.getElementById("diaChi").value = "";
        document.getElementById("soMam").value = 1;
        document.getElementById("trangThai").value = "";
        document.getElementById("orderErrors").innerHTML = "";
        document.getElementById("donGiaMam").value = "";
        document.getElementById("tongDon").value = "";
        const kmNoiDungEl = document.getElementById("kmNoiDung");
        const kmSoTienEl  = document.getElementById("kmSoTien");
        if (kmNoiDungEl) kmNoiDungEl.value = "";
        if (kmSoTienEl)  kmSoTienEl.value  = "";

        document.querySelector("#tblMon tbody").innerHTML = "";
        recalcTotals();

        document.querySelector("#tblHistShort tbody").innerHTML = "";
        document.getElementById("histDetail").innerHTML = "";

        ["ngay", "tenKH", "sdt", "diaChi", "soMam"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("error");
        });
      }

      function clearOrderErrors() {
        document.getElementById("orderErrors").innerHTML = "";
        ["ngay", "tenKH", "sdt", "diaChi", "soMam"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("error");
        });
        document.querySelectorAll("#tblMon tbody .tenMon, #tblMon tbody .sl").forEach(el => {
          el.classList.remove("error");
        });
      }

      function validatePhoneLocal(s) {
        const digits = (s || "").replace(/[^\d]/g, "");
        const stripped = digits.replace(/^84/, "").replace(/^0/, "");
        const len = stripped.length;
        return len >= 6 && len <= 12;
      }

      function validateOrderForm() {
        clearOrderErrors();
        const errors = [];

        const ngay   = document.getElementById("ngay").value;
        const tenKH  = document.getElementById("tenKH").value.trim();
        const sdt    = document.getElementById("sdt").value.trim();
        const diaChi = document.getElementById("diaChi").value.trim();
        const soMam  = Number(document.getElementById("soMam").value || 0);
        const datCocVal = parseMoney(document.getElementById("datCoc").value || "0");
        if (!ngay) {
          errors.push("Thi·∫øu ng√†y b√°n h√†ng.");
          document.getElementById("ngay").classList.add("error");
        }

        if (!tenKH) {
          errors.push("Thi·∫øu t√™n kh√°ch h√†ng.");
          document.getElementById("tenKH").classList.add("error");
        }

        if (!validatePhoneLocal(sdt)) {
          errors.push("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (6‚Äì12 s·ªë, c√≥ th·ªÉ +84).");
          document.getElementById("sdt").classList.add("error");
        }

        if (!diaChi) {
          errors.push("Thi·∫øu ƒë·ªãa ch·ªâ.");
          document.getElementById("diaChi").classList.add("error");
        }

        if (!Number.isFinite(soMam) || soMam <= 0 || Math.floor(soMam) !== soMam) {
          errors.push("S·ªë m√¢m ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng (1, 2, 3, ‚Ä¶).");
          document.getElementById("soMam").classList.add("error");
        }

        const tbody = document.querySelector("#tblMon tbody");
        const rows = Array.from(tbody.rows);
        let hasItem = false;

        rows.forEach((tr, index) => {
          const tenMonEl = tr.querySelector(".tenMon");
          const slEl     = tr.querySelector(".sl");
          const tenMon   = tenMonEl.value.trim();
          const sl       = Number(slEl.value || 0);
          const rowIdx   = index + 1;

          if (!tenMon && !sl) return;
          hasItem = true;

          if (!tenMon) {
            errors.push(`D√≤ng m√≥n #${rowIdx}: thi·∫øu t√™n m√≥n.`);
            tenMonEl.classList.add("error");
          }
          if (!Number.isFinite(sl) || sl <= 0) {
            errors.push(`D√≤ng m√≥n #${rowIdx}: s·ªë l∆∞·ª£ng ph·∫£i > 0.`);
            slEl.classList.add("error");
          }
        });

        if (!hasItem && datCocVal <= 0) {
            errors.push("ƒê∆°n h√†ng ph·∫£i c√≥ √≠t nh·∫•t 1 m√≥n ƒÉn HO·∫∂C c√≥ s·ªë ti·ªÅn ƒë·∫∑t c·ªçc.");
            document.querySelectorAll("#tblMon tbody .tenMon").forEach(el => el.classList.add("error"));
          }

        if (errors.length) {
          document.getElementById("orderErrors").innerHTML =
            errors.map(e => "‚Ä¢ " + e).join("<br>");
          alert("‚ö†Ô∏è L·ªói d·ªØ li·ªáu:\n\n" + errors.join("\n"));
          return { ok: false, errors };
        }
        return { ok: true };
      }


 function collectOrderPayload_() {
  const readText = (id) => {
    const el = document.getElementById(id);
    if (!el) return "";
    const v = ("value" in el) ? el.value : el.textContent;
    return String(v || "").trim();
  };

  const header = {
    ngay: readText("ngay"),
    nguoiLap: readText("nguoiLap"),
    sdt: readText("sdt"),
    tenKH: readText("tenKH"),
    diaChi: readText("diaChi"),
    soMam: (function () {
      const v = readText("soMam");
      const n = parseInt(v, 10);
      return isNaN(n) ? 0 : n;
    })(),
    trangThai: readText("trangThai"),
    kmNoiDung: readText("kmNoiDung"),
    kmSoTien: parseMoney(readText("kmSoTien") || 0),
    datCoc: parseMoney(readText("datCoc") || 0),
    // 2 field n√†y kh√¥ng b·∫Øt bu·ªôc (server ƒëang t·ª± t√≠nh), gi·ªØ c≈©ng ƒë∆∞·ª£c
    donGiaMam: parseMoney(readText("donGiaMam") || 0),
    tongDon: parseMoney(readText("tongDon") || 0)
  };

  // ‚úÖ always store cashier as login username (not display name/email)
  header.nguoiLap = String((window.CURRENT_USERNAME || header.nguoiLap || "")).trim();


  const items = [];
  const tbody = document.querySelector("#tblMon tbody");
  if (tbody) {
    Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
      const ten = String((tr.querySelector(".tenMon") || {}).value || "").trim();
      if (!ten) return;

      const dvt = String((tr.querySelector(".dvt") || {}).value || "").trim();
      const slRaw = (tr.querySelector(".sl") || {}).value;
      const sl = (() => {
        const n = parseFloat(String(slRaw || "").trim());
        return isNaN(n) ? 0 : n;
      })();
      const dg = parseMoney((tr.querySelector(".dg") || {}).value || 0);
      const ttCell = tr.querySelector(".tt");
      const tt = ttCell ? parseMoney(ttCell.textContent || 0) : (Math.round(sl * dg) || 0);

      items.push({
        ten,
        dvt,
        sl,
        dg,
        thanhTien: tt,
        loaiMon: tr.dataset && tr.dataset.loaiMon ? String(tr.dataset.loaiMon) : ""
      });
    });
  }

  // ‚úÖ tr·∫£ ƒë√∫ng format server mong ƒë·ª£i
  // g·∫Øn user login ƒë·ªÉ server l∆∞u ƒë√∫ng thu ng√¢n (kh√¥ng d√πng email)
  header.thungan = (typeof CURRENT_USERNAME !== "undefined" && CURRENT_USERNAME) ? String(CURRENT_USERNAME) : (header.thungan || "");
  if (!header.nguoiLap) header.nguoiLap = header.thungan;
  return { header, items, meta: { username: header.thungan } };
}

function renderPendingEditItems_(items) {
  if (typeof peRenderItems === "function") return peRenderItems(items || []);
}

function saveOrderToServer() {
  const payload = collectOrderPayload_();

  // ‚úÖ ch·ªëng b·∫•m l∆∞u 2 l·∫ßn + gi√∫p server bi·∫øt ƒëang s·ª≠a ƒë∆°n ch·ªù (update theo rowIndex, kh√¥ng append)
  payload.meta = payload.meta || {};
  if (typeof ST !== "undefined" && ST) {
    if (ST.SAVING_ORDER) return;
    ST.SAVING_ORDER = true;
  }

  showLoading("ƒêang l∆∞u ƒë∆°n...");

  google.script.run
    .withSuccessHandler(async res => {
      hideLoading();
      if (typeof ST !== "undefined" && ST) ST.SAVING_ORDER = false;

      if (!res || !res.ok) {
        alert("L∆∞u th·∫•t b·∫°i: " + ((res && res.error) || "Kh√¥ng x√°c ƒë·ªãnh"));
        return;
      }

      // ‚úÖ l∆∞u OK th√¨ reset tr·∫°ng th√°i edit ƒë·ªÉ l·∫ßn sau kh√¥ng b·ªã hi·ªÉu nh·∫ßm l√† ƒëang s·ª≠a
      if (typeof ST !== "undefined" && ST) ST.PENDING_EDIT_ROW = null;

      // ‚úÖ l·∫•y ƒë√∫ng sdt
      const sdt = String((payload.header && payload.header.sdt) || payload.sdt || "").trim();
      try {
        await Promise.all([
          loadPendingAllRight(),
          sdt ? loadHistoryByPhoneRight(sdt) : Promise.resolve()
        ]);
      } catch (e) {  }

      // ‚úÖ auto refresh c√°c tab li√™n quan (Doanh s·ªë/C√¥ng n·ª£/Dashboard/Kh√°ch h√†ng)
      scheduleRefreshAll_({ debt:true, customers:true, dashboard:true });

      alert(res.message || "ƒê√£ l∆∞u.");
    })
    .withFailureHandler(err => {
      hideLoading();
      if (typeof ST !== "undefined" && ST) ST.SAVING_ORDER = false;
      alert("L·ªói l∆∞u ƒë∆°n: " + (err && err.message ? err.message : err));
    })
    .saveOrder(payload);
}

function lockAppForMustChange_(lock) {
    const overlay = document.getElementById("changePasswordOverlay");
    if (!overlay) return;

    overlay.style.zIndex = "999999";
    overlay.style.display = lock ? "flex" : "none";

    const panes = document.querySelectorAll(".tab-pane, .tab-bar, .container, .main, #app");
    panes.forEach(el => {
      if (!el) return;
      if (lock) {
        el.dataset._pe = el.style.pointerEvents || "";
        el.style.pointerEvents = "none";
      } else {
        el.style.pointerEvents = el.dataset._pe || "";
      }
    });
  }

      function onSubmit() {
        const v = validateOrderForm();
        if (!v.ok) return;

        const ngay     = document.getElementById("ngay").value;
        const nguoiLap = document.getElementById("nguoiLap").value.trim();
        const soMam    = Number(document.getElementById("soMam").value || 0);
        const trangThai= document.getElementById("trangThai").value;

        const sdt      = document.getElementById("sdt").value.trim();
        const tenKH    = document.getElementById("tenKH").value.trim();
        const diaChi   = document.getElementById("diaChi").value.trim();
        const kmNoiDung = (document.getElementById("kmNoiDung")?.value || "").trim();
        const kmSoTien  = parseMoney(document.getElementById("kmSoTien")?.value || 0);

        const tbody = document.querySelector("#tblMon tbody");
        const items = [];
        Array.from(tbody.rows).forEach(tr => {
          const tenMon = tr.querySelector(".tenMon").value.trim();
          const dvt    = tr.querySelector(".dvt").value.trim();
          const sl     = Number(tr.querySelector(".sl").value || 0);
          const dg     = parseMoney(tr.querySelector(".dg").value || 0);
          if (!tenMon || !sl) return;
          const key = normalizeTextClient(tenMon);
          const menuHit = MENU_INDEX[key];
          const loaiMon =
            (tr.dataset.loaiMon || "") ||
            (menuHit && menuHit.loaiMon ? menuHit.loaiMon : "");

          items.push({ tenMon, dvt: dvt || "ƒêƒ©a", sl, donGia: dg, loaiMon });

        });

        const payload = {
          header: { ngay, tenKH, sdt, diaChi, soMam, nguoiLap, trangThai, kmNoiDung, kmSoTien },
          items
        };

        showLoading();
        google.script.run
          .withSuccessHandler(res => {
      hideLoading();
      res = coerceGsResponse_(res);
            if (!res || res.ok === false) {
              const msg = res && res.error
                ? "L·ªói ki·ªÉm tra ƒë∆°n tr√πng: " + res.error
                : "Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c ƒë∆°n tr√πng.";
              const cont = confirm(msg + "\n\nB·∫°n v·∫´n mu·ªën l∆∞u ƒë∆°n n√†y?");
              if (!cont) return;
              return saveOrderToServer(payload, sdt);
            }

            const count = Number(res.count || 0);
            if (count > 0) {
              const cont = confirm(
                `Kh√°ch h√†ng n√†y ƒë√£ c√≥ ${count} ƒë∆°n trong ng√†y ${ngay}.\n` +
                "B·∫°n v·∫´n mu·ªën th√™m ƒë∆°n m·ªõi?"
              );
              if (!cont) return;
            }
            saveOrderToServer(payload, sdt);
          })
          .withFailureHandler(err => {
            hideLoading();
            const msg = err && err.message ? err.message : err;
            const cont = confirm(
              "L·ªói h·ªá th·ªëng khi ki·ªÉm tra ƒë∆°n tr√πng: " + msg + "\n\nB·∫°n v·∫´n mu·ªën l∆∞u ƒë∆°n n√†y?"
            );
            if (!cont) return;
            saveOrderToServer(payload, sdt);
          })
          .countOrdersByDateAndPhone(ngay, sdt);
      }

function loadInlineHistory(phone) {
  const p = String(phone || "").trim();
  const wrap = document.getElementById("rightHistoryWrap");
  const tbody = document.querySelector("#tblHistoryRight tbody");
  const hint = document.getElementById("rightHistoryHint");

  if (!wrap || !tbody) return;

  if (!p) {
    tbody.innerHTML = "";
    if (hint) hint.style.display = "";
    return;
  }

  if (hint) hint.style.display = "none";
  setSectionLoading_(wrap, true, "ƒêang t·∫£i l·ªãch s·ª≠...");
  tbody.innerHTML = "";

  gasCallPromise_("listDebtByPhone", p)
    .then((rows) => {
      const list = Array.isArray(rows) ? rows : [];
      tbody.innerHTML = "";

      if (!list.length) {
        if (hint) {
          hint.textContent = "Kh√¥ng c√≥ l·ªãch s·ª≠ ƒë∆°n cho SƒêT n√†y.";
          hint.style.display = "";
        }
        setSectionLoading_(wrap, false);
        return;
      }

      if (hint) hint.style.display = "none";

      list.forEach((r) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escHtml(r.date || "")}</td>
          <td>${escHtml(r.info || "")}</td>
          <td style="text-align:right;">${escHtml(r.soMam || "")}</td>
          <td style="text-align:right;">${formatMoney(r.tongDon || 0)}</td>
          <td>${escHtml(r.trangThai || "")}</td>
        `;
        // Open detail popup on click (row = rowIndex in sheet congno)
        const rowIndex = r.row || r.rowIndex || r.metaRow || 0;
        if (rowIndex) {
          tr.style.cursor = "pointer";
          tr.addEventListener("click", () => openDetailPopup(rowIndex));
        }
        tbody.appendChild(tr);
      });

      setSectionLoading_(wrap, false);
    })
    .catch((e) => {
      setSectionLoading_(wrap, false);
      alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠: " + (e && e.message ? e.message : e));
    });
}
function buildDebtDetailHtml_(h, items){
  h = h || {};
  items = Array.isArray(items) ? items : [];

  const esc = (s) => escHtml(String(s == null ? "" : s));
  const money = (n) => formatMoney(Number(n || 0) || 0);

  let sum = 0;
  const rows = items.map((it, idx) => {
    const sl = Number(it.sl || 0) || 0;
    const dg = Number(it.donGia || 0) || 0;
    const tt = Number(it.thanhTien || (sl * dg) || 0) || 0;
    sum += tt;

    return `
      <tr>
        <td style="text-align:center;">${idx + 1}</td>
        <td>${esc(it.tenMon || "")}</td>
        <td style="text-align:center;">${esc(it.dvt || "")}</td>
        <td style="text-align:right;">${sl ? sl : ""}</td>
        <td style="text-align:right;">${dg ? money(dg) : ""}</td>
        <td style="text-align:right;">${tt ? money(tt) : ""}</td>
      </tr>
    `;
  }).join("");

  return `
    <div style="padding:10px 12px;">
      <div style="font-weight:700;font-size:14px;margin-bottom:6px;">Chi ti·∫øt ƒë∆°n</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;font-size:13px;margin-bottom:10px;">
        <div><b>Ng√†y:</b> ${esc(h.ngay || h.date || "")}</div>
        <div><b>Tr·∫°ng th√°i:</b> ${esc(h.trangThai || h.status || "")}</div>
        <div><b>Kh√°ch:</b> ${esc(h.tenKH || "")}</div>
        <div><b>SƒêT:</b> ${esc(h.sdt || "")}</div>
        <div style="grid-column:1 / span 2;"><b>ƒê·ªãa ch·ªâ:</b> ${esc(h.diaChi || "")}</div>
        <div><b>S·ªë m√¢m:</b> ${esc(h.soMam || "")}</div>
        <div><b>T·ªïng ƒë∆°n:</b> ${money(h.tongDon || 0)} ƒë</div>
      </div>

      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead>
          <tr>
            <th style="border:1px solid #e5e7eb;padding:6px;">#</th>
            <th style="border:1px solid #e5e7eb;padding:6px;text-align:left;">M√≥n</th>
            <th style="border:1px solid #e5e7eb;padding:6px;">ƒêVT</th>
            <th style="border:1px solid #e5e7eb;padding:6px;text-align:right;">SL</th>
            <th style="border:1px solid #e5e7eb;padding:6px;text-align:right;">ƒê∆°n gi√°</th>
            <th style="border:1px solid #e5e7eb;padding:6px;text-align:right;">Th√†nh ti·ªÅn</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="6" style="padding:8px;color:#6b7280;">Kh√¥ng c√≥ m√≥n.</td></tr>`}</tbody>
      </table>

      <div style="margin-top:10px;text-align:right;font-weight:800;">
        T·ªïng m√≥n: ${money(sum)} ƒë
      </div>
    </div>
  `;
}

function loadOrderDetailRow(rowIndex, tab, detailBoxEl){
  if (!detailBoxEl) return;

  showLoading();
  const runner = google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      res = coerceGsResponse_(res);
      if (!res || res.ok === false) {
        detailBoxEl.innerHTML = "";
        alert(res && res.error ? res.error : "Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt ƒë∆°n.");
        return;
      }
      detailBoxEl.innerHTML = buildDebtDetailHtml_(res.header || {}, res.items || []);

      // N·∫øu b·∫°n ƒë√£ c√≥ h√†m render s·∫µn th√¨ g·ªçi n√≥ ·ªü ƒë√¢y.
      // T·∫°m th·ªùi: gi·ªØ nguy√™n HTML c≈© b·∫°n ƒëang d√πng => ch·ªâ inject n√∫t In.
      // N·∫øu detailBoxEl hi·ªán ƒëang ƒë∆∞·ª£c code kh√°c set innerHTML, b·∫°n c√≥ th·ªÉ b·ªè ph·∫ßn render d∆∞·ªõi v√† ch·ªâ inject n√∫t In.

      // inject n√∫t In ·ªü ƒë·∫ßu box
      injectPrintButton_(detailBoxEl, rowIndex, tab);
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói t·∫£i chi ti·∫øt: " + (err && err.message ? err.message : err));
    });

  if (tab === "pending") runner.getOrderDetailByPendingRow(rowIndex);
  else runner.getOrderDetailByDebtRow(rowIndex);
}

function injectPrintButton_(detailBoxEl, rowIndex, tab){
  let btn = detailBoxEl.querySelector(".btn-print-invoice");
  if (!btn) {
    btn = document.createElement("button");
    btn.className = "btn-print-invoice";
    btn.textContent = "In h√≥a ƒë∆°n";
    btn.style.marginBottom = "10px";
    btn.addEventListener("click", (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      printInvoice_(rowIndex, tab);
    });
    detailBoxEl.prepend(btn);
  } else {
    btn.onclick = (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      printInvoice_(rowIndex, tab);
    };
  }
}
function activateTab(tabKey, forceLoad) {
  // 1) set UI active
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tabKey);
  });
  document.querySelectorAll('[data-panel]').forEach(p => {
    p.style.display = (p.dataset.panel === tabKey) ? '' : 'none';
  });

  // 2) load data cho tab (forceLoad ƒë·ªÉ load ngay c·∫£ l·∫ßn ƒë·∫ßu)
  if (tabKey === 'pending') {
    loadPendingRecent(forceLoad);
  } else if (tabKey === 'history') {
    loadHistory(forceLoad);
  } else if (tabKey === 'sales') {
    loadSales(forceLoad);
  }
}
function initTabsAndInitialLoad() {
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tab, true));
  });

  // tab m·∫∑c ƒë·ªãnh: ∆∞u ti√™n c√°i ƒëang .active, n·∫øu kh√¥ng c√≥ th√¨ pending
  const defaultTab = document.querySelector('[data-tab].active')?.dataset.tab || 'pending';
  activateTab(defaultTab, true); // <<< QUAN TR·ªåNG: load ngay
}

function printInvoice_(rowIndex, tab){
  showLoading();

  const fn = (tab === "pending") ? "getInvoiceHtmlByPendingRow" : "getInvoiceHtmlByDebtRow";
  const cb = document.getElementById("printIncludeTax");
  const includeTax = cb ? !!cb.checked : !!ENABLE_TAX;

  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if (!res || res.ok === false) {
        alert(res && res.error ? res.error : "Kh√¥ng t·∫°o ƒë∆∞·ª£c h√≥a ƒë∆°n.");
        return;
      }
      const w = window.open("", "_blank");
      w.document.open();
      try{
        w.document.write(sanitizeHtmlForPrint_(res.html || ""));
      }catch(e){
        try{
          w.document.write("<pre style=\"white-space:pre-wrap;font-size:12px\">" + escHtml(String(res && res.html ? res.html : "")) + "</pre>");
        }catch(_){}
      }
      w.document.close();
      w.focus();
      w.print();
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói in: " + (err && err.message ? err.message : err));
    })[fn](rowIndex, (ST && (ST.username || ST.displayName)) ? (ST.username || ST.displayName) : "", includeTax);
}




      function buildOrderDetailHtml(h, items) {
        let html = "";
        html += `<div><b>Ng√†y:</b> ${h.date} &nbsp; | &nbsp; <b>Tr·∫°ng th√°i:</b> ${h.trangThai}</div>`;
        const soMonText = items && items.length ? ` (${items.length} m√≥n)` : "";
        html += `<div><b>KH:</b> ${h.tenKH} - ${h.sdt}</div>`;
        html += `<div><b>ƒê·ªãa ch·ªâ:</b> ${h.diaChi}</div>`;
        html += `<div><b>S·ªë m√¢m:</b> ${h.soMam}${soMonText} &nbsp; | &nbsp; <b>ƒê∆°n gi√°/m√¢m:</b> ${formatMoney(h.donGiaMam)} ƒë &nbsp; | &nbsp; <b>T·ªïng ƒë∆°n:</b> ${formatMoney(h.tongDon)} ƒë</div>`;
        html += `<div><b>KM:</b> ${h.kmNoiDung || "(kh√¥ng)"} &nbsp; | &nbsp; <b>S·ªë ti·ªÅn KM:</b> ${formatMoney(h.kmSoTien || 0)} ƒë &nbsp; | &nbsp; <b>Doanh s·ªë:</b> ${formatMoney(h.doanhSo || h.tongDon || 0)} ƒë</div>`;
        html += `<div><b>C√¥ng n·ª£:</b> ${formatMoney(h.congNo || 0)} ƒë</div>`;
        if (h.ngayThanhToan) {
          html += `<div><b>Ng√†y thanh to√°n:</b> ${h.ngayThanhToan}</div>`;
        }

        if (!items.length) {
          html += `<div style="margin-top:4px;">Kh√¥ng t√¨m th·∫•y chi ti·∫øt m√≥n trong sheet "Th√¥ng tin ƒë·∫∑t h√†ng".</div>`;
        } else {
          html += `<div style="margin-top:4px;">Chi ti·∫øt m√≥n:</div>`;
          html += `<table style="margin-top:2px; width:100%; border-collapse:collapse;">
                    <thead>
                      <tr>
                        <th style="border:1px solid #e1ebdf; padding:3px; font-size:13px;">M√≥n</th>
                        <th style="border:1px solid #e1ebdf; padding:3px; font-size:13px;">ƒêVT</th>
                        <th style="border:1px solid #e1ebdf; padding:3px; font-size:13px; text-align:right;">SL</th>
                        <th style="border:1px solid #e1ebdf; padding:3px; font-size:13px; text-align:right;">ƒê∆°n gi√°</th>
                        <th style="border:1px solid #e1ebdf; padding:3px; font-size:13px; text-align:right;">Th√†nh ti·ªÅn</th>
                      </tr>
                    </thead>
                    <tbody>`;
          items.forEach(it => {
            html += `<tr>
              <td style="border:1px solid #e1ebdf; padding:3px; font-size:13px;">${it.tenMon}</td>
              <td style="border:1px solid #e1ebdf; padding:3px; font-size:13px;">${it.dvt}</td>
              <td style="border:1px solid #e1ebdf; padding:3px; font-size:13px; text-align:right;">${it.sl}</td>
              <td style="border:1px solid #e1ebdf; padding:3px; font-size:13px; text-align:right;">${formatMoney(it.donGia)}</td>
              <td style="border:1px solid #e1ebdf; padding:3px; font-size:13px; text-align:right;">${formatMoney(it.thanhTien)}</td>
            </tr>`;
          });
          html += `</tbody></table>`;
        }
        return html;
      }

   function loadOrderDetailByDebtRow(rowIndex, targetId) {
  showLoading();

  google.script.run
    .withSuccessHandler(function(res) {
      hideLoading();

      // ‚úÖ QUAN TR·ªåNG: parse JSON string / double-encoded string
      res = coerceGsResponse_(res);

      const box = document.getElementById(targetId);
      if (!box) return;

      if (!res || res.ok !== true) {
        box.innerHTML = `<div style="color:#b91c1c;">Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c chi ti·∫øt ƒë∆°n.</div>`;
        return;
      }

      const h = res.header || {};
      const items = Array.isArray(res.items) ? res.items : [];

      // buildOrderDetailHtml ƒë√£ c√≥ s·∫µn trong file :contentReference[oaicite:1]{index=1}
      let html = buildOrderDetailHtml(h, items);

      box.innerHTML = html;
    })
    .withFailureHandler(function(err) {
      hideLoading();
      const box = document.getElementById(targetId);
      if (box) {
        box.innerHTML = `<div style="color:#b91c1c;">L·ªói t·∫£i chi ti·∫øt: ${escHtml(err && err.message ? err.message : err)}</div>`;
      } else {
        alert("L·ªói t·∫£i chi ti·∫øt: " + (err && err.message ? err.message : err));
      }
    })
    .getOrderDetailByDebtRow(rowIndex);
}


      function loadDebtFull() {
        showLoading();
        google.script.run
          .withSuccessHandler(data => {
            DEBT_FULL = data || { headers: [], rows: [], rowIndices: [] };
            renderDebtFull();
            hideLoading();
          })
          .withFailureHandler(err => {
            hideLoading();
            alert("L·ªói load C√¥ng n·ª£: " + (err && err.message ? err.message : err));
          })
          .ui_getDebtFullFast();
      }

      function renderDebtFull(filteredPhone) {
        const thead = document.querySelector("#tblDebtFull thead");
        const tbody = document.querySelector("#tblDebtFull tbody");
        thead.innerHTML = "";
        tbody.innerHTML = "";

        const summaryBox = document.getElementById("debtSummary");
        if (summaryBox) summaryBox.innerHTML = "";

        if (!DEBT_FULL || !DEBT_FULL.headers || !DEBT_FULL.headers.length) {
          return;
        }

        const headers    = DEBT_FULL.headers;
        const rows       = DEBT_FULL.rows || [];
        const rowIndices = DEBT_FULL.rowIndices || [];

        // ======== L·∫•y filter hi·ªán t·∫°i t·ª´ DOM ========
        const phoneFilterInput = document.getElementById("debtFilterPhone");
        const phoneFilter =
          typeof filteredPhone === "string"
            ? filteredPhone
            : (phoneFilterInput ? phoneFilterInput.value.trim() : "");

        const monthSelect  = document.getElementById("debtFilterMonth");
        const statusSelect = document.getElementById("debtFilterStatus");
        const cashierSelect = document.getElementById("debtFilterCashier");

        const currentMonthFilter  = monthSelect  ? monthSelect.value  : "";
        const currentStatusFilter = statusSelect ? statusSelect.value : "";
        const currentCashierFilter = cashierSelect ? cashierSelect.value : "";

        // ======== X√°c ƒë·ªãnh index c√°c c·ªôt c·∫ßn d√πng ========
        let idxTongDon   = -1;
        let idxDoanhSo   = -1;
        let idxCongNo    = -1;
        let idxDate      = -1;
        let idxStatusCol = -1;
        let idxCashier   = -1;

        headers.forEach((h, i) => {
          const t = String(h || "").toLowerCase();

          if (t.includes("th√†nh ti·ªÅn") && idxTongDon === -1) idxTongDon = i;
          if (t.includes("doanh s·ªë")   && idxDoanhSo === -1) idxDoanhSo = i;
          if (t.includes("c√¥ng n·ª£")    && idxCongNo  === -1) idxCongNo  = i;

          if ((t.includes("ng√†y") || t.includes("date")) && idxDate === -1) {
            idxDate = i;
          }
          if (t.includes("tr·∫°ng th√°i") && idxStatusCol === -1) {
            idxStatusCol = i;
          }
          if ((t.includes("thu ng√¢n") || t.includes("nh√¢n vi√™n") || t.includes("ng∆∞·ªùi t·∫°o")) && idxCashier === -1) {
            idxCashier = i;
          }
        });

        // fallback status n·∫øu kh√¥ng detect ƒë∆∞·ª£c t·ª´ header
        if (idxStatusCol === -1 && headers.length > 9) {
          idxStatusCol = 9;
        }

        let displayCols = lastNonEmptyHeaderIndex_(headers);
        // n·∫øu c√≥ c·ªôt "M√£ ƒë∆°n"/orderId th√¨ ·∫©n c·ªôt ƒë√≥
        const idxOrder = headers.findIndex(h => String(h||"").toLowerCase().includes("m√£ ƒë∆°n") || String(h||"").toLowerCase().includes("order"));
        if (idxOrder >= 0) displayCols = Math.min(displayCols, idxOrder);
        displayCols = Math.max(displayCols, 1);

        const trHead = document.createElement("tr");
        headers.slice(0, displayCols).forEach(h => {
          const th = document.createElement("th");
          th.textContent = h;
          trHead.appendChild(th);
        });
        const thAct = document.createElement("th");
        thAct.textContent = "H√†nh ƒë·ªông";
        trHead.appendChild(thAct);
        thead.appendChild(trHead);

        // ======== Bi·∫øn t·ªïng + t·∫≠p gi√° tr·ªã filter ========
        let countRows   = 0;
        let sumTongDon  = 0;
        let sumDoanhSo  = 0;
        let sumCongNo   = 0;

        const monthMap   = new Map(); // key: YYYY-MM, value: MM/YYYY
        const statusSet  = new Set();
        const cashierSet = new Set();

        rows.forEach((r, idx) => {
          const tr = document.createElement("tr");
          const sheetRow = rowIndices[idx] || (idx + 2);
          const info = String(r[1] || "");
          const rowIndex = rowIndices[idx]; // ‚úÖ D√íNG QUAN TR·ªåNG

          // Thu th·∫≠p gi√° tr·ªã cho filter
          if (idxDate >= 0 && r[idxDate] != null) {
            const { key, label } = getMonthKeyAndLabel(r[idxDate]);
            if (key && label && !monthMap.has(key)) {
              monthMap.set(key, label);
            }
          }
          if (idxStatusCol >= 0 && r[idxStatusCol] != null) {
            statusSet.add(String(r[idxStatusCol]));
          }
          if (idxCashier >= 0 && r[idxCashier] != null) {
            cashierSet.add(String(r[idxCashier]));
          }

          // √Åp d·ª•ng filter
          let match = true;

          // L·ªçc theo SƒêT
          if (phoneFilter) {
            if (!info.includes(phoneFilter)) {
              match = false;
            }
          }

          // L·ªçc theo th√°ng
          if (match && currentMonthFilter && idxDate >= 0 && r[idxDate] != null) {
            const { key } = getMonthKeyAndLabel(r[idxDate]);
            if (!key || key !== currentMonthFilter) {
              match = false;
            }
          }

          // L·ªçc theo tr·∫°ng th√°i
          if (match && currentStatusFilter && idxStatusCol >= 0) {
            const st = String(r[idxStatusCol] || "");
            if (st !== currentStatusFilter) {
              match = false;
            }
          }

          // L·ªçc theo thu ng√¢n
          if (match && currentCashierFilter && idxCashier >= 0) {
            const cs = String(r[idxCashier] || "");
            if (cs !== currentCashierFilter) {
              match = false;
            }
          }

          if (!match) {
            tr.style.display = "none";
          } else {
            countRows++;
            if (idxTongDon >= 0 && r[idxTongDon] != null) {
              sumTongDon += parseMoney(r[idxTongDon]);
            }
            if (idxDoanhSo >= 0 && r[idxDoanhSo] != null) {
              sumDoanhSo += parseMoney(r[idxDoanhSo]);
            }
            if (idxCongNo >= 0 && r[idxCongNo] != null) {
              sumCongNo += parseMoney(r[idxCongNo]);
            }
          }

          // Render √¥ d·ªØ li·ªáu
          r.slice(0, displayCols).forEach((cell, cIdx) => {
            const td = document.createElement("td");
            if (cIdx === 9) {
              const v = String(cell || "");
              let cls = "status-unpaid";
              if (v === "ƒê√£ thanh to√°n") cls = "status-paid";
              else if (v === "Ghi n·ª£") cls = "status-debt";
              td.innerHTML = `<span class="status-pill ${cls}">${v}</span>`;
              td.style.textAlign = "center";
            } else if ([3, 4, 6, 7, 8].indexOf(cIdx) !== -1) {
              td.textContent = formatMoney(cell || 0);
              td.classList.add("money");
            } else if (cIdx === 2) {
              td.textContent = cell;
              td.classList.add("numeric");
            } else {
              td.textContent = cell;
            }
            tr.appendChild(td);
          });

          const tdAct = document.createElement("td");
          tdAct.style.textAlign = "center";
          tdAct.innerHTML = `
  <div class="row-actions">
    <button class="secondary small" onclick="openPrintInvoice(${rowIndex})">üßæ In</button>
    ${CAN_DELETE ? `<button class="danger small" onclick="openDeleteConfirm(${rowIndex})">üóë X√≥a</button>` : ''}
  </div>
`;
          tr.appendChild(tdAct);
          // ‚úÖ ch·∫∑n click ·ªü c·ªôt h√†nh ƒë·ªông kh√¥ng m·ªü popup chi ti·∫øt
          tdAct.addEventListener('click', function(e){ e.stopPropagation(); });

          tr.addEventListener("click", (e) => {
          // Click v√†o n√∫t In/X√≥a (trong .row-actions) th√¨ KH√îNG m·ªü popup chi ti·∫øt
          if (e && e.target && e.target.closest && (e.target.closest(".row-actions") || e.target.closest("button"))) return;

          document.querySelectorAll("#tblDebtFull tbody tr.selected").forEach(function(x){ x.classList.remove("selected"); });
          tr.classList.add("selected");
          openDetailPopup(sheetRow);
        });

          tbody.appendChild(tr);
        });

        // ======== C·∫≠p nh·∫≠t dropdown filter (kh√¥ng m·∫•t l·ª±a ch·ªçn c≈©) ========
        if (monthSelect) {
          const prev = currentMonthFilter;
          monthSelect.innerHTML = "";
          const optAll = document.createElement("option");
          optAll.value = "";
          optAll.textContent = "T·∫•t c·∫£";
          monthSelect.appendChild(optAll);

          const monthArr = Array.from(monthMap.entries())
            .sort((a, b) => a[0].localeCompare(b[0])); // sort theo key YYYY-MM

          monthArr.forEach(([key, label]) => {
            const opt = document.createElement("option");
            opt.value = key;
            opt.textContent = label;
            if (key === prev) opt.selected = true;
            monthSelect.appendChild(opt);
          });
        }

        if (statusSelect) {
          const prev = currentStatusFilter;
          statusSelect.innerHTML = "";
          const optAll = document.createElement("option");
          optAll.value = "";
          optAll.textContent = "T·∫•t c·∫£";
          statusSelect.appendChild(optAll);

          Array.from(statusSet).forEach(st => {
            const opt = document.createElement("option");
            opt.value = st;
            opt.textContent = st;
            if (st === prev) opt.selected = true;
            statusSelect.appendChild(opt);
          });
        }

        if (cashierSelect) {
          const prev = currentCashierFilter;
          cashierSelect.innerHTML = "";
          const optAll = document.createElement("option");
          optAll.value = "";
          optAll.textContent = "T·∫•t c·∫£";
          cashierSelect.appendChild(optAll);

          Array.from(cashierSet).forEach(cs => {
            const opt = document.createElement("option");
            opt.value = cs;
            opt.textContent = cs;
            if (cs === prev) opt.selected = true;
            cashierSelect.appendChild(opt);
          });
        }

        // ======== Render d√≤ng t·ªïng ph√≠a tr√™n b·∫£ng ========
        if (summaryBox) {
          summaryBox.innerHTML = `
            <div class="summary-item">
              <b>S·ªë ƒë∆°n:</b> ${countRows}
                ||   <b>T·ªïng ƒë∆°n:</b> ${formatMoney(sumTongDon)} ƒë
                ||   <b>Doanh s·ªë:</b> ${formatMoney(sumDoanhSo)} ƒë
                ||   <b>T·ªïng c√¥ng n·ª£:</b> ${formatMoney(sumCongNo)} ƒë
            </div>
          `;
        }

        makeTableSortable("tblDebtFull");
      }

      function getMonthKeyAndLabel(dateStr) {
        if (!dateStr) return { key: "", label: "" };
        const s = String(dateStr).trim();
        if (!s) return { key: "", label: "" };

        // Th·ª≠ t√°ch b·∫±ng / ho·∫∑c -
        const parts = s.split(/[\/\-]/);
        if (parts.length >= 3) {
          let y, m, d;
          // Tr∆∞·ªùng h·ª£p yyyy-MM-dd ho·∫∑c yyyy/MM/dd
          if (parts[0].length === 4) {
            y = parts[0];
            m = parts[1].padStart(2, "0");
            d = parts[2].padStart(2, "0");
          } else {
            // Tr∆∞·ªùng h·ª£p dd/MM/yyyy ho·∫∑c dd-MM-yyyy
            d = parts[0].padStart(2, "0");
            m = parts[1].padStart(2, "0");
            y = parts[2].length === 2 ? ("20" + parts[2]) : parts[2];
          }
          const key = `${y}-${m}`;
          const label = `${m}/${y}`;
          return { key, label };
        }

        // fallback: c·ªë g·∫Øng parse b·∫±ng Date
        const dt = new Date(s);
        if (!isNaN(dt.getTime())) {
          const y = dt.getFullYear();
          const m = String(dt.getMonth() + 1).padStart(2, "0");
          const key = `${y}-${m}`;
          const label = `${m}/${y}`;
          return { key, label };
        }

        return { key: "", label: "" };
      }

      function applyDebtFilter() {
        const input = document.getElementById("debtFilterPhone");
        const val = input ? input.value.trim() : "";
        renderDebtFull(val);
      }

      function clearDebtFilter() {
        const input = document.getElementById("debtFilterPhone");
        if (input) input.value = "";
        // Xo√° filter SƒêT nh∆∞ng gi·ªØ filter th√°ng/tr·∫°ng th√°i/thu ng√¢n
        renderDebtFull("");
      }

      function closeEditPopup() {
  CURRENT_EDIT_ROW = null;
  EDIT_READONLY = false;
  setDisplay_(document.getElementById("editPopupOverlay") || document.getElementById("pendingEditOverlay") || document.getElementById("pendingEditOverlay"), "none");

  refreshModalOpenState_();
}

      function openDeleteConfirm(rowIndex) {
        if (!rowIndex) return;

        showLoading();
        google.script.run
          .withSuccessHandler(res => {
            hideLoading();
            res = coerceGsResponse_(res);
            if (!res || res.ok === false) {
              alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin ƒë∆°n ƒë·ªÉ xo√°: " + (res && res.error ? res.error : "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
              return;
            }
            const h = res.header || {};
        try { const oidEl=document.getElementById("peOrderId"); if(oidEl) oidEl.value=String(h.orderId||""); } catch(e) {}
            const msg =
              "B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA ƒë∆°n n√†y?\n\n" +
              `Ng√†y: ${h.date || ""}\n` +
              `Kh√°ch: ${h.tenKH || ""} - ${h.sdt || ""}\n` +
              `Tr·∫°ng th√°i: ${h.trangThai || ""}\n` +
              `T·ªïng ƒë∆°n: ${formatMoney(h.tongDon || 0)} ƒë\n\n` +
              "Thao t√°c n√†y s·∫Ω xo√° d√≤ng C√¥ng n·ª£ v√† to√†n b·ªô chi ti·∫øt m√≥n li√™n quan.\n" +
              "H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.\n\n" +
              "B·∫°n v·∫´n mu·ªën ti·∫øp t·ª•c?";
            if (!confirmDelete(msg)) {
              return;
            }

            showLoading();
            google.script.run
              .withSuccessHandler(delRes => {
                hideLoading();
                if (!delRes || !delRes.ok) {
                  alert("L·ªói khi xo√° ƒë∆°n: " + (delRes && delRes.error ? delRes.error : "Kh√¥ng x√°c ƒë·ªãnh"));
                  return;
                }
                alert(delRes.message || "ƒê√£ xo√° ƒë∆°n. Vui l√≤ng l·∫≠p ƒë∆°n m·ªõi n·∫øu c·∫ßn b√π.");
                const sdt = h.sdt || "";
                loadDebtFull();
                loadCustomersFull();
                if (sdt) {
                  loadInlineHistory(sdt);
                  loadCustomerHistory(sdt);
                }
                const editOverlay = document.getElementById("editPopupOverlay");
                if (editOverlay) editOverlay.style.display = "none";
                closeDetailPopup();
              })
              .withFailureHandler(err => {
                hideLoading();
                alert("L·ªói h·ªá th·ªëng khi xo√° ƒë∆°n: " + (err && err.message ? err.message : err));
              })
              .deleteOrderByDebtRow(rowIndex, "<?= username ?>");
          })
          .withFailureHandler(err => {
            hideLoading();
            alert("L·ªói khi ƒë·ªçc th√¥ng tin ƒë∆°n: " + (err && err.message ? err.message : err));
          })
          .getOrderDetailByDebtRow(rowIndex);
      }

      function loadCustomersFull() {
        showLoading();
        google.script.run
          .withSuccessHandler(data => {
            CUSTOMERS_FULL = data || { headers: [], rows: [], agg: {} };
            renderCustomersFull();
            hideLoading();
          })
          .withFailureHandler(err => {
            hideLoading();
            alert("L·ªói load Kh√°ch h√†ng: " + (err && err.message ? err.message : err));
          })
          .ui_getCustomersFullFast();
      }
   

 function switchHistoryTab(tab){
  // Backward-compatible wrapper. The current UI uses the right-panel tabs.
  tab = tab || "pending";
  if (typeof switchRightTab === "function") {
    // "debt" means show history tab (orders already saved)
    switchRightTab(tab === "pending" ? "pending" : "history");
  }
  const phone = (ST && ST.CURRENT_PHONE) ? String(ST.CURRENT_PHONE).trim() : "";
  if (phone) loadInlineHistory(phone);
}



    function loadPendingHistory(phone) {
  const tbody = document.querySelector("#tblPending tbody");
  if (!tbody) return;

  tbody.innerHTML = "";
  showLoading();

  const runner = google.script.run
    .withSuccessHandler(rows => {
      try {
        tbody.innerHTML = "";

        (rows || []).forEach(r => {
          const tr = document.createElement("tr");
          tr.classList.add("pending-row");
          tr.dataset.row = r.row;

          const soMonText = r.soMon ? ` (${r.soMon} m√≥n)` : "";
          const pill = `<span class="status-pill status-pending">ƒê∆°n ch·ªù</span>`;

          tr.innerHTML = `
            <td>${r.date || ""}</td>
            <td>${r.info || ""}</td>
            <td class="numeric">${(r.soMam ?? "")}${soMonText}</td>
            <td class="money">${formatMoney(r.tongDon)}</td>
            <td style="text-align:center;">${pill}</td>
            <td style="text-align:center; white-space:nowrap;">
              <button type="button" class="btn-mini" onclick="openPendingEditPopup(${r.row}); event.stopPropagation();">S·ª≠a</button>
              <button type="button" class="btn-mini" onclick="openPrintPending(${r.row}); event.stopPropagation();">In</button>
            </td>
          `;

          // Click c·∫£ d√≤ng th√¨ c≈©ng coi nh∆∞ "S·ª≠a" (ti·ªán)
          tr.addEventListener("click", () => openPendingEditPopup(r.row));

          tbody.appendChild(tr);
        });
      } catch (e) {
      } finally {
        hideLoading();
      }
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói t·∫£i ƒë∆°n ch·ªù: " + (err && err.message ? err.message : err));
    });

  // N·∫øu c√≥ phone th√¨ l·ªçc theo phone, kh√¥ng th√¨ load recent
  if (phone) runner.listPendingByPhone(phone);
  else runner.listPendingRecent();
}
ST.PENDING_EDIT_ROW = null;

function openPendingEdit(rowIndex){
  if (!rowIndex) return;
  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      try {
        if (!res || !res.ok) {
          alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c ƒë∆°n ch·ªù: " + (res?.error || "unknown"));
          return;
        }
        ST.PENDING_EDIT_ROW = rowIndex;
        applyPendingToForm(res.header, res.items);
        // chuy·ªÉn v·ªÅ tab nh·∫≠p ƒë·ªÉ th·∫•y form (n·∫øu b·∫°n c√≥ tab)
        // switchMainTab?.("order");  // n·∫øu app b·∫°n c√≥ h√†m switch tab ch√≠nh
      } finally {
        hideLoading();
      }
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói t·∫£i ƒë∆°n ch·ªù: " + (err && err.message ? err.message : err));
    })
    .getPendingOrderByRow(rowIndex);
}

function applyPendingToForm(header) {
    header = header || {};
    setVal_("ngay", ymdFromAnyDate_(header.ngay || header.date || header.dateStr || header.ngayStr));
    setVal_("tenKH", header.tenKH || header.tenKh || "");   // FIX id
    setVal_("sdt", header.sdt || "");
    setVal_("diaChi", header.diaChi || "");
    setVal_("soMam", header.soMam || "");
    setVal_("kmNoiDung", header.kmNoiDung || "");
    setVal_("kmSoTien", formatMoney(header.kmSoTien || 0));
    setVal_("trangThai", header.trangThai || "");
    recalcTotals();
  }
function fillOrderFormFromDetail(detail) {
    if (!detail) return;
    const h = detail.header || {};
    document.getElementById("ngay").value = ymdFromAnyDate_(h.date || h.ngay || h.dateStr);
    document.getElementById("tenKH").value = h.tenKH || h.tenKh || "";  // FIX id
    document.getElementById("sdt").value = h.sdt || "";
    document.getElementById("diaChi").value = h.diaChi || "";
    document.getElementById("soMam").value = h.soMam || "";
    document.getElementById("kmNoiDung").value = h.kmNoiDung || "";
    document.getElementById("kmSoTien").value = formatMoney(h.kmSoTien || 0);
    document.getElementById("trangThai").value = h.trangThai || "";
    recalcTotals();
  }
function openPrintPending(rowIndex){
  if (!rowIndex) return;
  showLoading();
  google.script.run
    .withSuccessHandler(html => {
      hideLoading();
      if (!html) { alert("Kh√¥ng t·∫°o ƒë∆∞·ª£c phi·∫øu in."); return; }
      openPrintHtml(html); // h√†m n√†y b·∫°n ƒëang c√≥ (m·ªü popup in/iframe). N·∫øu t√™n kh√°c th√¨ ƒë·ªïi.
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói in ƒë∆°n ch·ªù: " + (err && err.message ? err.message : err));
    })
    .getPendingInvoiceHtml(rowIndex);
}
function sanitizeHtmlForPrint_(html){
  try{
    let s = String(html == null ? "" : html);
    // remove any <script> blocks to prevent syntax errors in print window
    s = s.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");
    return s;
  }catch(e){
    return String(html == null ? "" : html);
  }
}
function openPrintHtml(html){
  const w = window.open("", "_blank");
  w.document.open();
  try{
    w.document.write(sanitizeHtmlForPrint_(html));
  }catch(e){
    // fallback: show as plain text if html contains broken scripts
    try{
      w.document.write("<pre style=\"white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;\">" + escHtml(String(html||"")) + "</pre>");
    }catch(_){}
  }
  w.document.close();
  w.focus();
  w.print();
}

      function normalizePhoneClient(s) {
        const digits = (s || "").replace(/[^\d]/g, "");
        return digits.replace(/^84/, "").replace(/^0/, "");
      }

      function renderCustomersFull(filteredPhone) {
        const thead = document.querySelector("#tblCustomerFull thead");
        const tbody = document.querySelector("#tblCustomerFull tbody");
        if (!thead || !tbody) {
          return;
        }
        thead.innerHTML = "";
        tbody.innerHTML = "";

        const summaryBox = document.getElementById("customerSummary");
        if (summaryBox) summaryBox.innerHTML = "";

        const headers = CUSTOMERS_FULL.headers || [];
        const rows    = CUSTOMERS_FULL.rows || [];
        const agg     = CUSTOMERS_FULL.agg || {};

        if (!headers.length) {
          return;
        }

        // T√¨m c·ªôt "Ghi ch√∫", n·∫øu c√≥ th√¨ b·ªè kh·ªèi UI
        const ghiChuIndex = headers.findIndex(h => {
          const t = String(h || "").toLowerCase();
          return t.includes("ghi ch√∫") || t.includes("ghichu") || t.includes("ghi chu");
        });

        const trHead = document.createElement("tr");
        headers.forEach((h, idx) => {
          if (idx === ghiChuIndex) return; // kh√¥ng hi·ªÉn th·ªã c·ªôt Ghi ch√∫
          const th = document.createElement("th");
          th.textContent = h;
          trHead.appendChild(th);
        });

        // 3 c·ªôt t·ªïng + 1 c·ªôt h√†nh ƒë·ªông "L·ªãch s·ª≠ chi ti·∫øt"
        ["T·ªïng ƒë·∫∑t", "Ghi n·ª£", "ƒê√£ thanh to√°n", "Chi ti·∫øt c√¥ng n·ª£"].forEach(title => {
          const th = document.createElement("th");
          th.textContent = title;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        // Bi·∫øn t·ªïng
        let totalCustomers   = 0;
        let sumTotalOrdered  = 0;
        let sumTotalDebt     = 0;
        let sumTotalPaid     = 0;

        // chu·∫©n ho√° s·ªë ƒëi·ªán tho·∫°i filter
        const filterNorm = filteredPhone
          ? normalizePhoneClient(filteredPhone)
          : "";

        rows.forEach(r => {
          const tr = document.createElement("tr");

          const phoneCell = String(r[0] || "");   // gi·∫£ ƒë·ªãnh c·ªôt 1 l√† SƒêT
          const nameCell  = String(r[1] || "");   // gi·∫£ ƒë·ªãnh c·ªôt 2 l√† T√™n KH

          const phoneKey  = normalizePhoneClient(phoneCell);
          const summary   = agg[phoneKey] || { totalOrdered: 0, totalDebt: 0 };
          const totalOrdered = summary.totalOrdered || 0;
          const totalDebt    = summary.totalDebt || 0;
          const totalPaid    = totalOrdered - totalDebt;

          // match theo SƒêT ƒë√£ chu·∫©n ho√° (b·ªè 0, b·ªè 84)
          const matchPhone = filterNorm
            ? (phoneKey && phoneKey.indexOf(filterNorm) !== -1)
            : true;

          if (!matchPhone) {
            tr.style.display = "none";
          } else {
            totalCustomers++;
            sumTotalOrdered += totalOrdered;
            sumTotalDebt    += totalDebt;
            sumTotalPaid    += totalPaid;
          }

          // C√°c c·ªôt g·ªëc
          r.forEach((cell, cIdx) => {
            if (cIdx === ghiChuIndex) return; // b·ªè c·ªôt Ghi ch√∫
            const td = document.createElement("td");
            td.textContent = cell;
            tr.appendChild(td);
          });

          // T·ªïng ƒë·∫∑t
          const tdTotal = document.createElement("td");
          tdTotal.classList.add("money");
          tdTotal.textContent = formatMoney(totalOrdered);
          tr.appendChild(tdTotal);

          // Ghi n·ª£
          const tdDebt = document.createElement("td");
          tdDebt.classList.add("money");
          tdDebt.textContent = formatMoney(totalDebt);
          tr.appendChild(tdDebt);

          // ƒê√£ thanh to√°n
          const tdPaid = document.createElement("td");
          tdPaid.classList.add("money");
          tdPaid.textContent = formatMoney(totalPaid);
          tr.appendChild(tdPaid);

          // N√∫t xem l·ªãch s·ª≠ chi ti·∫øt (popup)
          const tdAction = document.createElement("td");
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "secondary small";
          btn.textContent = "Chi ti·∫øt";
          btn.addEventListener("click", (ev) => {
            ev.stopPropagation(); // tr√°nh trigger click c·∫£ d√≤ng
            openCustomerHistoryDetail(phoneCell, nameCell);
          });
          tdAction.appendChild(btn);
          tr.appendChild(tdAction);

          // Click c·∫£ d√≤ng v·∫´n gi·ªØ behaviour c≈©: set SƒêT & load l·ªãch s·ª≠ ƒë∆°n (list ƒë∆°n)
          tr.addEventListener("click", () => {
            document
              .querySelectorAll("#tblCustomerFull tbody tr")
              .forEach(x => x.classList.remove("selected"));

            tr.classList.add("selected");
            document.getElementById("sdtCustomer").value = phoneCell;
            loadCustomerHistory(phoneCell);
          });

          tbody.appendChild(tr);
        });

        // Render d√≤ng t·ªïng ph√≠a tr√™n b·∫£ng
        if (summaryBox) {
          summaryBox.innerHTML = `
            <div class="summary-item">
              <b>S·ªë kh√°ch:</b> ${totalCustomers}
                ||   <b>T·ªïng ƒë·∫∑t:</b> ${formatMoney(sumTotalOrdered)} ƒë
                ||   <b>T·ªïng ghi n·ª£:</b> ${formatMoney(sumTotalDebt)} ƒë
                ||   <b>ƒê√£ thanh to√°n:</b> ${formatMoney(sumTotalPaid)} ƒë
            </div>
          `;
        }
      }

      function applyCustomerFilter() {
        const phone = document.getElementById("sdtCustomer").value.trim();
        renderCustomersFull(phone || undefined);
      }

      function clearCustomerFilter() {
        document.getElementById("sdtCustomer").value = "";
        renderCustomersFull();
        document.querySelector("#tblCustomerHist tbody").innerHTML = "";
        document.getElementById("customerHistDetail").innerHTML = "";
        const fullArea = document.getElementById("customerFullPaymentArea");
        if (fullArea) {
          fullArea.innerHTML = "";
          fullArea.style.display = "none";
        }
      }
      function loadDanhMucHang() {
  google.script.run
    .withSuccessHandler(function(items){
      // items ƒë√£ ƒë∆∞·ª£c filter status=1 ·ªü server
      renderDanhMuc(items); // h√†m render c·ªßa b·∫°n
    })
    .withFailureHandler(function(err){
      alert(err.message || err);
    })
    .dm_listActiveItems();
}
 /*********** IN H√ìA ƒê∆†N ***********/
function closePrintInvoice(){
  const ov = document.getElementById("printInvoiceOverlay");
  if (ov) if (ov && ov.style) ov.style.display = "none";
  CURRENT_PRINT_HEADER = null;
  CURRENT_PRINT_ROWINDEX = null;
}

function openPrintInvoice(rowIndex){
  if (!rowIndex) return;
  CURRENT_PRINT_ROWINDEX = rowIndex;

  const ov = document.getElementById("printInvoiceOverlay");
  const content = document.getElementById("printInvoiceContent");
  const inp = document.getElementById("invoiceNoInput");
  if (!ov || !content || !inp) return;

  content.innerHTML = "";
  inp.value = "";
  inp.style.display = "inline-block";

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      res = coerceGsResponse_(res);
      if (!res || !res.ok) {
        hideLoading();
        alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c chi ti·∫øt ƒë∆°n ƒë·ªÉ in: " + (res && res.error ? res.error : "Unknown"));
        return;
      }
      CURRENT_PRINT_HEADER = res;
      const cb = document.getElementById('printIncludeTax');
      if (cb) cb.checked = !!ENABLE_TAX;

      const orderId = (res.header && res.header.orderId) ? String(res.header.orderId) : "";
      const tagRow = "ORDER:" + orderId;
      CURRENT_PRINT_TAGROW = tagRow;

      google.script.run
        .withSuccessHandler(invRes => {
          const existed = invRes && invRes.ok ? (invRes.invoiceNo || "") : "";
          if (existed) {
            inp.value = existed;
            content.innerHTML = buildInvoiceHtml(res.header, res.items || [], existed, (document.getElementById('printIncludeTax')?document.getElementById('printIncludeTax').checked:true));
            if (ov && ov.style) ov.style.display = "flex";
            hideLoading();
          } else {
            google.script.run
              .withSuccessHandler(nextRes => {
                const inv = nextRes && nextRes.ok ? nextRes.invoiceNo : "";
                inp.value = inv || "";
                content.innerHTML = buildInvoiceHtml(res.header, res.items || [], inp.value, (document.getElementById('printIncludeTax')?document.getElementById('printIncludeTax').checked:true));
                if (ov && ov.style) ov.style.display = "flex";
                hideLoading();
              })
              .withFailureHandler(err => { hideLoading(); alert("L·ªói l·∫•y s·ªë ho√° ƒë∆°n: " + (err && err.message ? err.message : err)); })
              .getNextInvoiceNo();
          }
        })
        .withFailureHandler(err => { hideLoading(); alert("L·ªói ƒë·ªçc log ho√° ƒë∆°n: " + (err && err.message ? err.message : err)); })
        .getInvoiceNoByDebtRow(tagRow);
    })
    .withFailureHandler(err => { hideLoading(); alert("L·ªói ƒë·ªçc ƒë∆°n: " + (err && err.message ? err.message : err)); })
    .getOrderDetailByDebtRow(rowIndex);
}

function rebuildPrintInvoicePreview_(){
  try{
    const content = document.getElementById("printInvoiceContent");
    if (!content || !CURRENT_PRINT_HEADER) return;
    const cb = document.getElementById("printIncludeTax");
    // Checkbox "kh√¥ng thu·∫ø" - n·∫øu tick th√¨ KH√îNG c√≥ thu·∫ø (enableTax = false)
    const includeTax = cb ? !!cb.checked : true;
    const invNoEl = document.getElementById("invoiceNoInput");
    const invNo = invNoEl ? String(invNoEl.value || "") : "";
    content.innerHTML = buildInvoiceHtml(CURRENT_PRINT_HEADER.header || {}, CURRENT_PRINT_HEADER.items || [], invNo, includeTax);
  }catch(e){}
}


function doPrintInvoice(){
  const tagRow = CURRENT_PRINT_TAGROW;
  if (!tagRow || !CURRENT_PRINT_HEADER || !CURRENT_PRINT_HEADER.ok) return;

  const inp = document.getElementById("invoiceNoInput");
  let invoiceNo = String(inp ? inp.value : "").trim();
  if (!invoiceNo) {
    alert("Thi·∫øu s·ªë ho√° ƒë∆°n.");
    return;
  }

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if (!res || !res.ok) {
        alert("Kh√¥ng reserve ƒë∆∞·ª£c s·ªë ho√° ƒë∆°n: " + (res && res.error ? res.error : "Unknown"));
        return;
      }
      invoiceNo = res.invoiceNo || invoiceNo;

      const content = document.getElementById("printInvoiceContent");
      const cb = document.getElementById('printIncludeTax');
      const includeTax = cb ? !!cb.checked : !!ENABLE_TAX;

      content.innerHTML = buildInvoiceHtml(CURRENT_PRINT_HEADER.header, CURRENT_PRINT_HEADER.items || [], invoiceNo, includeTax);

      setTimeout(() => window.print(), 0);
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói ghi log ho√° ƒë∆°n: " + (err && err.message ? err.message : err));
    })
    .reserveInvoiceNo(invoiceNo, CURRENT_USERNAME || "", String(tagRow));
}
function bindPhoneAutofill_() {
  const sdtEl = document.getElementById("sdt");
  const tenEl = document.getElementById("tenKH");
  const dcEl  = document.getElementById("diaChi");
  if (!sdtEl || !tenEl || !dcEl) return;

  let t = null;
  sdtEl.addEventListener("input", () => {
    const sdt = String(sdtEl.value || "").trim();
    if (t) clearTimeout(t);

    // ch·ªâ auto-fill khi ƒë·ªß d√†i (tr√°nh spam call)
    if (!sdt || sdt.length < 6) return;

    t = setTimeout(() => {
      google.script.run
        .withSuccessHandler(res => {
          if (!res || res.ok === false) return;
          if (res.tenKH !== undefined && !tenEl.value) tenEl.value = res.tenKH || "";
          if (res.diaChi !== undefined && !dcEl.value)  dcEl.value  = res.diaChi || "";
        })
        .withFailureHandler(() => {})
        .findCustomerByPhone(sdt);
    }, 350);
  });
}

/*********** HTML h√≥a ƒë∆°n + VAT 10% cho "ƒê·ªì u·ªëng c√≥ c·ªìn" ***********/
function isAlcoholLoaiMon_(loaiMon){
  const t = normalizeTextClient(loaiMon || "");
  return t === "do uong co con" || t.includes("co con");
}

function buildInvoiceHtml(h, items, invoiceNo, enableTax){
  h = h || {};
  items = Array.isArray(items) ? items : [];
  invoiceNo = String(invoiceNo || "").trim();
  enableTax = (enableTax === undefined || enableTax === null) ? true : !!enableTax;
const trangThai = String(h.trangThai || h.status || "").trim();
  let stampCls = "unpaid";
  let stampText = "Ch∆∞a thanh to√°n";
  if (trangThai === "ƒê√£ thanh to√°n") {
    stampCls = "paid";
    stampText = "ƒê√£ thu ti·ªÅn";
  } else if (trangThai === "Ghi n·ª£") {
    stampCls = "debt";
    stampText = "Ghi n·ª£";
  }

  enableTax = (enableTax !== false);

  // KM
  const km = Number(h.soTienKm || h.amountKm || h.kmAmount || 0) || 0;

  // Subtotal t·ª´ items (∆∞u ti√™n thanhTien)
  const rawSubTotal = items.reduce((s, it) => {
    const sl = Number(it.sl || 0) || 0;
    const dg = Number(it.donGia || 0) || 0;
    const tt = Number(it.thanhTien || (sl * dg) || 0) || 0;
    return s + Math.max(0, tt);
  }, 0);

  const subTotal = Math.round(rawSubTotal);
  const kmApplied = Math.min(Math.max(0, km), rawSubTotal);
  const datCoc = Number(h.datCoc || 0);
  const soMam = Number(h.soMam || 1) || 1;
  // Ph√¢n b·ªï KM theo t·ª∑ l·ªá t·ª´ng d√≤ng, t√°ch base 10% / 8%
  let base10 = 0, base8 = 0;
  items.forEach(it => {
    const sl = Number(it.sl || 0) || 0;
    const dg = Number(it.donGia || 0) || 0;
    const line = Math.max(0, Number(it.thanhTien || (sl * dg)) || 0);

    const ratio = rawSubTotal > 0 ? (line / rawSubTotal) : 0;
    const kmShare = kmApplied * ratio;
    const base = Math.max(0, line - kmShare);

    const loai = String(it.loaiMon || "").trim();
    const is10 = isAlcoholLoaiMon_(loai); // true => 10%, false => 8%

    if (is10) base10 += base;
    else base8 += base;
  });

  base10 = Math.round(base10);
  base8  = Math.round(base8);

  const tienChuaThue = Math.round(base10 + base8)*soMam;
  const vat10 = Math.round(base10 * 0.10)*soMam;
  const vat8  = Math.round(base8  * 0.08)*soMam;
  const tienThue = Math.round(vat10 + vat8)*soMam;

  // T·ªïng: c√≥ thu·∫ø / kh√¥ng thu·∫ø
  const grandWithTax = Math.round(tienChuaThue + tienThue)*soMam -datCoc;
  const grandNoTax   = Math.round(Math.max(0, rawSubTotal - kmApplied))*soMam-datCoc;
  const finalGrand   = enableTax ? grandWithTax : grandNoTax;

  const fmt = (n) => formatMoney(Number(n) || 0);

  const dateStr = String(h.date || h.ngay || "").trim();
  const tenKH = String(h.tenKH || "").trim();
  const sdt = String(h.sdt || "").trim();
  const diaChi = String(h.diaChi || "").trim();
 

  let html = "";
  html += `<div class="invoice">`;

  html += `<div class="inv-head">
    <div class="inv-brand">T·∫†I GIA SEN QU√ä</div>
    <div class="inv-sub">H√ìA ƒê∆†N B√ÅN H√ÄNG</div>
    <div class="inv-stamp ${stampCls}">${escHtml(stampText)}</div>
    <div class="inv-title">H√ìA ƒê∆†N</div>
    <div class="inv-no">S·ªë h√≥a ƒë∆°n: <b>${escHtml(invoiceNo || "(ch∆∞a c√≥)")}</b></div>
  </div>`;

  html += `<div class="inv-meta">
    <div><b>Ng√†y:</b> ${escHtml(dateStr || "")}</div>
    ${soMam ? `<div><b>S·ªë m√¢m:</b> ${soMam}</div>` : ""}
    ${tenKH ? `<div><b>Kh√°ch:</b> ${escHtml(tenKH)}</div>` : ""}
    ${sdt ? `<div><b>SƒêT:</b> ${escHtml(sdt)}</div>` : ""}
    ${diaChi ? `<div><b>ƒê/c:</b> ${escHtml(diaChi)}</div>` : ""}
  </div>`;

  // Items
  html += `<table class="inv-table" style="width:100%; border-collapse:collapse; font-size:12px; margin-top:6px;">
    <thead>
      <tr>
        <th style="text-align:left; border-bottom:1px solid #111; padding:4px 2px;">M√≥n</th>
        <th style="text-align:right; border-bottom:1px solid #111; padding:4px 2px; width:44px;">SL</th>
        <th style="text-align:right; border-bottom:1px solid #111; padding:4px 2px; width:74px;">ƒê∆°n gi√°</th>
        <th style="text-align:right; border-bottom:1px solid #111; padding:4px 2px; width:84px;">Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody>`;

  items.forEach(it => {
    const ten = String(it.tenMon || it.ten || it.name || "").trim();
    const sl = Number(it.sl || 0) || 0;
    const dg = Number(it.donGia || 0) || 0;
    const tt = Math.max(0, Number(it.thanhTien || (sl * dg)) || 0);

    if (!ten) return;
    html += `<tr>
      <td style="padding:3px 2px; border-bottom:1px dashed #bbb;">${escHtml(ten)}</td>
      <td style="padding:3px 2px; text-align:right; border-bottom:1px dashed #bbb;">${sl}</td>
      <td style="padding:3px 2px; text-align:right; border-bottom:1px dashed #bbb;">${fmt(dg)} ƒë</td>
      <td style="padding:3px 2px; text-align:right; border-bottom:1px dashed #bbb;">${fmt(tt)} ƒë</td>
    </tr>`;
  });

  html += `</tbody></table>`;

  // Totals
  let taxHtml = "";
    if (enableTax) {
    html += "<div class='inv-total' style='padding:8px 6px 0; font-size:12px; line-height:1.15;'>" +
          "<div class='line major' style='display:flex;justify-content:space-between;padding:3px 0;'><span><strong>Ti·ªÅn h√†ng</strong></span><span>" + fmt(subTotal) + "ƒë</span></div>" +
          "<div class='line major' style='display:flex;justify-content:space-between;padding:3px 0;'><span><strong>Ti·ªÅn ch∆∞a thu·∫ø</strong></span><span>" + fmt(tienChuaThue) + "ƒë</span></div>" +
          "<div class='line minor' style='display:flex;justify-content:space-between;padding:2px 0;'><span>Tr∆∞·ªõc thu·∫ø (10%)</span><span>" + fmt(base10) + "ƒë</span></div>" +
          "<div class='line minor' style='display:flex;justify-content:space-between;padding:2px 0;'><span>Tr∆∞·ªõc thu·∫ø (8%)</span><span>" + fmt(base8) + "ƒë</span></div>" +
          "<div class='line major' style='display:flex;justify-content:space-between;padding:3px 0;'><span><strong>Ti·ªÅn thu·∫ø</strong></span><span>" + fmt(tienThue) + "ƒë</span></div>" +
          "<div class='line minor' style='display:flex;justify-content:space-between;padding:2px 0;'><span>Thu·∫ø (10%)</span><span>" + fmt(vat10) + "ƒë</span></div>" +
          "<div class='line minor' style='display:flex;justify-content:space-between;padding:2px 0;'><span>Thu·∫ø (8%)</span><span>" + fmt(vat8) + "ƒë</span></div>" +
          "<div class='line grand' style='display:flex;justify-content:space-between;padding:6px 0 0;border-top:2px solid #111;margin-top:4px;font-size:14px;font-weight:900;'>" +
          ${datCoc > 0 ? `
  <div class="line major" style="display:flex;justify-content:space-between;padding:3px 0;">
    <span><strong>Ti·ªÅn ƒë·∫∑t c·ªçc</strong></span><span>- ${formatMoney(datCoc)}ƒë</span>
  </div>` : ""} +
            "<span><strong>T·ªïng thanh to√°n</strong></span><span class='amt'>" + fmt(grandWithTax) + "ƒë</span></div>" +
        "</div>";
  } else{

  html += `<div class="inv-total" style="padding:8px 6px 0; font-size:12px; line-height:1.15;">
    <div class="line major" style="display:flex;justify-content:space-between;margin:2px 0;">
      <span><strong>Ti·ªÅn h√†ng</strong></span><span>${fmt(subTotal)}ƒë</span>
    </div>
    ${kmApplied > 0 ? `<div class="line minor" style="display:flex;justify-content:space-between;margin:1px 0;">
      <span>Khuy·∫øn m√£i</span><span>- ${fmt(kmApplied)}ƒë</span>
    </div>` : ""}
    ${taxHtml}
    ${datCoc > 0 ? `<div class="line major" style="display:flex;justify-content:space-between;padding:3px 0;"><span><strong>Ti·ªÅn ƒë·∫∑t c·ªçc</strong></span><span>- ${formatMoney(datCoc)}ƒë</span></div>` : ""}
    <div class="line grand" style="display:flex;justify-content:space-between;border-top:2px solid #111;margin-top:4px;padding-top:4px;font-size:14px;font-weight:900;">
      <span><strong>T·ªïng thanh to√°n</strong></span><span class="amt">${fmt(finalGrand)}ƒë</span>
    </div>
  </div>`;}

  html += `</div>`;
  return html;
}


function loadCustomerHistory(phone) {
  const tbody = document.querySelector("#tblCustomerHist tbody");
  const detailBox = document.getElementById("customerHistDetail");
  const fullArea = document.getElementById("customerFullPaymentArea");

  if (tbody) tbody.innerHTML = "";
  if (detailBox) detailBox.innerHTML = "";
  if (fullArea) {
    fullArea.innerHTML = "";
    fullArea.style.display = "none";
  }

  if (!phone) return;

  showLoading();
  google.script.run
    .withSuccessHandler(rows => {
      try {
        if (!tbody) return;
        tbody.innerHTML = "";

        (rows || []).forEach(r => {
          const tr = document.createElement("tr");
          tr.classList.add("cust-hist-row");
          tr.dataset.row = r.row;

          let cls = "status-unpaid";
          if (r.trangThai === "ƒê√£ thanh to√°n") cls = "status-paid";
          else if (r.trangThai === "Ghi n·ª£")   cls = "status-debt";

          const soMonText = r.soMon ? ` (${r.soMon} m√≥n)` : "";

          const canPay = (r.trangThai !== "ƒê√£ thanh to√°n");
          const payCellHtml = canPay
            ? `<button type="button" class="primary"
                onclick="event.stopPropagation(); openPaymentPopup(${r.row})">Thu n·ª£</button>`
            : "";

          tr.innerHTML = `
            <td>${r.date || ""}</td>
            <td>${r.info || ""}</td>
            <td class="numeric">${r.soMam}${soMonText}</td>
            <td class="money">${formatMoney(r.tongDon)}</td>
            <td style="text-align:center;">
              <span class="status-pill ${cls}">${r.trangThai}</span>
            </td>
            <td style="text-align:center;">${payCellHtml}</td>
          `;

          tr.addEventListener("click", () => {
            document.querySelectorAll(".cust-hist-row").forEach(x => x.classList.remove("selected"));
            tr.classList.add("selected");
            loadOrderDetailByDebtRow(r.row, "customerHistDetail");
          });

          tbody.appendChild(tr);
        });

        // ƒê·ªÉ chi ti·∫øt tr·ªëng, ch·ªâ hi·ªÉn th·ªã khi b·∫•m 1 d√≤ng
        if (detailBox) {
          detailBox.innerHTML = "";
        }

        // V√πng thu n·ª£ to√†n b·ªô v·∫´n gi·ªØ logic c≈©
        if (fullArea) {
          if (rows && rows.length) {
            const phoneKey = normalizePhoneClient(phone);
            const agg = (CUSTOMERS_FULL && CUSTOMERS_FULL.agg) ? CUSTOMERS_FULL.agg : {};
            const summary = agg[phoneKey] || { totalDebt: 0 };
            const totalDebt = summary.totalDebt || 0;

            if (totalDebt > 0) {
              const safePhone = String(phone).replace(/'/g, "\\'");
              fullArea.innerHTML = `
                <div style="font-size:15px;">
                  üí≥ T·ªïng c√¥ng n·ª£ c√≤n l·∫°i c·ªßa kh√°ch n√†y: <b>${formatMoney(totalDebt)} ƒë</b>
                </div>
                <div>
                  <button type="button" class="primary"
                          onclick="openCustomerFullPayment('${safePhone}')">
                    Thu n·ª£ to√†n b·ªô
                  </button>
                </div>
              `;
              fullArea.style.display = "flex";
              fullArea.style.justifyContent = "space-between";
              fullArea.style.alignItems   = "center";
            } else {
              fullArea.innerHTML = `
                <div style="font-size:14px; color:#6b7280;">
                  Kh√°ch n√†y kh√¥ng c√≤n c√¥ng n·ª£.
                </div>
              `;
              fullArea.style.display = "block";
            }
          } else {
            fullArea.innerHTML = "";
            fullArea.style.display = "none";
          }
        }
      } catch (e) {
      } finally {
        hideLoading();
      }
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói t·∫£i l·ªãch s·ª≠ kh√°ch h√†ng: " + (err && err.message ? err.message : err));
    })
    .listDebtByPhone(phone);
}

function isAlcoholLoaiMon(loaiMon){
  const t = normalizeTextClient(loaiMon);
  // match ƒë√∫ng ‚Äúƒê·ªì u·ªëng c√≥ c·ªìn‚Äù ho·∫∑c ch·ªâ c·∫ßn ch·ª©a ‚Äúco con‚Äù
  return t === "do uong co con" || t.includes("co con");
}

      function setupTableSearch(inputId, tableId) {
        const inp = document.getElementById(inputId);
        const table = document.getElementById(tableId);
        if (!inp || !table || !table.tBodies.length) return;

        inp.addEventListener("input", () => {
          const q = (inp.value || "").toLowerCase().trim();
          const rows = table.tBodies[0].rows;

          Array.from(rows).forEach(row => {
            // l·∫•y c·∫£ text + value c·ªßa input/select trong row
            const texts = [];
            texts.push((row.innerText || "").toLowerCase());

            row.querySelectorAll("input, select, textarea").forEach(el => {
              texts.push(String(el.value || "").toLowerCase());
            });

            const hay = texts.join(" ");
            row.style.display = hay.includes(q) ? "" : "none";
          });
        });
      }


      function makeTableSortable(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const thead = table.querySelector("thead");
        if (!thead) return;

        const ths = thead.querySelectorAll("th");
        ths.forEach((th, colIndex) => {
          const label = th.getAttribute("data-label") || th.textContent.trim();
          th.setAttribute("data-label", label);

          th.classList.add("sortable");
          th.innerHTML =
            `<span class="th-label">${label}</span>` +
            `<span class="sort-icon">‚Üï</span>`;

          // G·∫Øn 1 handler duy nh·∫•t
          th.onclick = () => sortTableByColumn(table, colIndex);
        });
      }

      function sortTableByColumn(table, colIndex) {
        const tbody = table.tBodies[0];
        if (!tbody) return;

        const rowsArr = Array.from(tbody.rows);
        const sortKey = "sort_dir_" + colIndex;
        const currentDir = table.getAttribute(sortKey) || "asc";
        const newDir = currentDir === "asc" ? "desc" : "asc";

        // S·∫Øp x·∫øp theo gi√° tr·ªã trong √¥ (∆∞u ti√™n s·ªë, fallback string)
        rowsArr.sort((a, b) => {
          const aText = a.cells[colIndex]?.innerText?.trim() || "";
          const bText = b.cells[colIndex]?.innerText?.trim() || "";
          const aNum = parseMoney(aText);
          const bNum = parseMoney(bText);

          if (!isNaN(aNum) && !isNaN(bNum) && (aText !== "" || bText !== "")) {
            return newDir === "asc" ? aNum - bNum : bNum - aNum;
          }
          return newDir === "asc"
            ? aText.localeCompare(bText)
            : bText.localeCompare(aText);
        });

        // G·∫Øn l·∫°i c√°c d√≤ng ƒë√£ sort
        rowsArr.forEach(row => tbody.appendChild(row));
        table.setAttribute(sortKey, newDir);

        // C·∫≠p nh·∫≠t icon & class tr√™n header
        const ths = table.querySelectorAll("thead th");
        ths.forEach((th, index) => {
          th.classList.remove("sort-asc", "sort-desc");
          const icon = th.querySelector(".sort-icon");
          if (!icon) return;

          if (index === colIndex) {
            if (newDir === "asc") {
              th.classList.add("sort-asc");
              icon.textContent = "‚ñ≤";
            } else {
              th.classList.add("sort-desc");
              icon.textContent = "‚ñº";
            }
          } else {
            icon.textContent = "‚Üï";
          }
        });
      }

      function init() {
        // m·∫∑c ƒë·ªãnh ng∆∞·ªùi l·∫≠p phi·∫øu = user ƒëƒÉng nh·∫≠p (displayName)
        applyRolePermissions_();
        var nguoiLapEl = document.getElementById("nguoiLap");
        if (nguoiLapEl && !nguoiLapEl.value) {
          nguoiLapEl.value = "<?= displayName ?>";
        }
        showLoading();
        google.script.run
          .withSuccessHandler(data => {
            if (!data) return;

            MENU = (data.menu || []).map(m => Object.assign({}, m, { name: menuName_(m), unit: menuUnit_(m), price: menuPrice_(m), type: menuType_(m) }));
            buildMenuIndex_();
            const sel = document.getElementById("selectMon");
            const selEdit = document.getElementById("editSelectMon");
            if (sel) sel.innerHTML = '<option value="">-- Ch·ªçn m√≥n --</option>';
            if (selEdit) selEdit.innerHTML = '<option value="">-- Ch·ªçn m√≥n --</option>';

            MENU.forEach((m, idx) => {
              const label = `${m.ten} (${m.dvt || "ƒêƒ©a"}) - ${formatMoney(m.gia)} ƒë`;
              if (sel) {
                const opt = document.createElement("option");
                opt.value = String(idx);
                opt.textContent = label;
                sel.appendChild(opt);
              }
              if (selEdit) {
                const opt2 = document.createElement("option");
                opt2.value = String(idx);
                opt2.textContent = label;
                selEdit.appendChild(opt2);
              }
            });
            const dl = document.getElementById("menuDatalist");
              if (dl) {
                dl.innerHTML = "";
                MENU.forEach(m => {
                  const opt = document.createElement("option");
                  opt.value = m.ten; // ƒë·ªÉ search theo t√™n m√≥n
                  dl.appendChild(opt);
                });
              }

            if (data.today) {
              document.getElementById("ngay").value = data.today;
            }

            hideLoading();
          })
          .withFailureHandler(err => {
            hideLoading();
            alert("L·ªói kh·ªüi t·∫°o d·ªØ li·ªáu: " + (err && err.message ? err.message : err));
          })
          .getInitData();

        loadDebtFull();
        loadCustomersFull();

        document.getElementById("soMam").addEventListener("input", recalcTotals);
        const kmSoTienEl = document.getElementById("kmSoTien");
        if (kmSoTienEl) kmSoTienEl.addEventListener("blur", () => {
          kmSoTienEl.value = formatMoney(parseMoney(kmSoTienEl.value));
        });
        recalcTotals();

        setupTableSearch("search_tblMon", "tblMon");
        setupTableSearch("search_tblHistShort", "tblHistShort");
        setupTableSearch("search_tblDebtFull", "tblDebtFull");
        setupTableSearch("search_tblCustomerFull", "tblCustomerFull");
        setupTableSearch("search_tblCustomerHist", "tblCustomerHist");
        setupTableSearch("search_editItemsTable", "editItemsTable");

        makeTableSortable("tblMon");
        makeTableSortable("tblHistShort");
        makeTableSortable("tblDebtFull");
        makeTableSortable("tblCustomerFull");
        makeTableSortable("tblCustomerHist");
        makeTableSortable("editItemsTable");
        dmReload();
        initOrderMenuSearch();
        // Right panel: lu√¥n load danh s√°ch ƒë∆°n ch·ªù khi v·ª´a v√†o app
        try {
          if (typeof switchRightTab === "function") switchRightTab("pending");
          if (typeof loadPendingAllRight === "function") loadPendingAllRight();
        } catch(e) {  }

        google.script.run
          .withSuccessHandler(res => {
          })
          .debugPing();
      }

      function initDebtFilters() {
        const monthSelect   = document.getElementById("debtFilterMonth");
        const statusSelect  = document.getElementById("debtFilterStatus");
        const cashierSelect = document.getElementById("debtFilterCashier");

        [monthSelect, statusSelect, cashierSelect].forEach(sel => {
          if (sel) {
            sel.addEventListener("change", () => {
              renderDebtFull();
            });
          }
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        initDebtFilters();

        const overlay = document.getElementById('changePasswordOverlay');
        if (!overlay) return;

        if (MUST_CHANGE_PASSWORD) {
          overlay.style.display = 'flex';
        } else {
          overlay.style.display = 'none';
        }
      });



      /*********** POPUP XEM CHI TI·∫æT (TAB C√îNG N·ª¢) ************/
      function openDetailPopup(rowIndex) {
        if (!rowIndex) return;
        showLoading();
        google.script.run
          .withSuccessHandler(res => {
            hideLoading();
            res = coerceGsResponse_(res);
            if (!res || res.ok === false) {
              alert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c chi ti·∫øt ƒë∆°n: " +
                (res && res.error ? res.error : "Kh√¥ng x√°c ƒë·ªãnh"));
              return;
            }
            const h = res.header || {};
            const items = res.items || [];
            const contentBox = document.getElementById("detailPopupContent");

            const dateStr = escHtml(h.date || "");
            const customerStr = escHtml((h.tenKH || "") + (h.sdt ? " - " + h.sdt : ""));
            const addrStr = escHtml(h.diaChi || "");
            const statusStr = escHtml(h.trangThai || "");
            const payDateStr = escHtml(h.ngayThanhToan || "");
            const kmNoteStr = escHtml(h.kmNoiDung || "");

            let html = "";

            html += `
              <div class="card" style="margin-bottom:8px;">
                <div class="row">
                  <div class="field" style="max-width:180px;">
                    <label>Ng√†y</label>
                    <input type="text" value="${dateStr}" readonly>
                  </div>
                  <div class="field">
                    <label>Kh√°ch h√†ng</label>
                    <input type="text" value="${customerStr}" readonly>
                  </div>
                </div>
                <div class="row">
                  <div class="field">
                    <label>ƒê·ªãa ch·ªâ</label>
                    <input type="text" value="${addrStr}" readonly>
                  </div>
                </div>
                <div class="row">
                  <div class="field" style="max-width:160px;">
                    <label>S·ªë m√¢m</label>
                    <input type="text" value="${h.soMam || ""}" readonly>
                  </div>
                  <div class="field" style="max-width:180px;">
                    <label>ƒê∆°n gi√°/m√¢m</label>
                    <input type="text" value="${formatMoney(h.donGiaMam || 0)}" readonly>
                  </div>
                  <div class="field">
                    <label>T·ªïng ƒë∆°n</label>
                    <input type="text" value="${formatMoney(h.tongDon || 0)}" readonly>
                  </div>
                </div>
                <div class="row">
                  <div class="field">
                    <label>Khuy·∫øn m√£i</label>
                    <input type="text" value="${kmNoteStr}" readonly>
                  </div>
                  <div class="field" style="max-width:180px;">
                    <label>S·ªë ti·ªÅn KM</label>
                    <input type="text" value="${formatMoney(h.kmSoTien || 0)}" readonly>
                  </div>
                  <div class="field" style="max-width:180px;">
                    <label>Doanh s·ªë</label>
                    <input type="text" value="${formatMoney(h.doanhSo || 0)}" readonly>
                  </div>
                </div>
                <div class="row">
                  <div class="field" style="max-width:180px;">
                    <label>C√¥ng n·ª£</label>
                    <input type="text" value="${formatMoney(h.congNo || 0)}" readonly>
                  </div>
                  <div class="field" style="max-width:180px;">
                    <label>Tr·∫°ng th√°i</label>
                    <input type="text" value="${statusStr}" readonly>
                  </div>
                  <div class="field" style="max-width:180px;">
                    <label>Ng√†y thanh to√°n</label>
                    <input type="text" value="${payDateStr}" readonly>
                  </div>
                </div>
              </div>
            `;

            html += `<div class="card">
                       <h2 style="margin-top:0;">Chi ti·∫øt m√≥n (ch·ªâ ƒë·ªçc)</h2>`;

            if (!items.length) {
              html += `<div>Kh√¥ng t√¨m th·∫•y chi ti·∫øt m√≥n trong sheet "Th√¥ng tin ƒë·∫∑t h√†ng".</div>`;
            } else {
              html += `
                <table style="margin-top:4px; width:100%; border-collapse:collapse;">
                  <thead>
                    <tr>
                      <th>M√≥n</th>
                      <th>ƒêVT</th>
                      <th style="text-align:right;">SL</th>
                      <th style="text-align:right;">ƒê∆°n gi√°</th>
                      <th style="text-align:right;">Th√†nh ti·ªÅn</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              items.forEach(it => {
                html += `
                  <tr>
                    <td>${escHtml(it.tenMon)}</td>
                    <td>${escHtml(it.dvt)}</td>
                    <td style="text-align:right;">${it.sl}</td>
                    <td style="text-align:right;">${formatMoney(it.donGia)}</td>
                    <td style="text-align:right;">${formatMoney(it.thanhTien)}</td>
                  </tr>
                `;
              });
              html += `</tbody></table>`;
            }

            html += `
              <div class="flex-between" style="margin-top:8px;">
                <div style="font-size:13px; color:#6b7280;">
                  ƒê√¢y l√† popup xem chi ti·∫øt ƒë∆°n. Kh√¥ng th·ªÉ ch·ªânh s·ª≠a t·∫°i ƒë√¢y.<br>
                  N·∫øu c·∫ßn thay ƒë·ªïi, h√£y xo√° ƒë∆°n trong b·∫£ng C√¥ng n·ª£ r·ªìi t·∫°o l·∫°i ƒë∆°n m·ªõi.
                </div>
                <div>
                  <button type="button" class="secondary" onclick="closeDetailPopup()">ƒê√≥ng</button>
                </div>
              </div>
            </div>
            `;

            contentBox.innerHTML = html;
            setDisplay_("detailPopupOverlay","flex");
          })
          .withFailureHandler(err => {
            hideLoading();
            alert("L·ªói h·ªá th·ªëng khi xem chi ti·∫øt: " + (err && err.message ? err.message : err));
          })
          .getOrderDetailByDebtRow(rowIndex);
      }

      function closeDetailPopup() {
        setDisplay_("detailPopupOverlay","none");
        document.getElementById("detailPopupContent").innerHTML = "";
      }

      /*********** POPUP THU N·ª¢ ************/
      function openPaymentPopup(rowIndex) {
        if (!rowIndex) return;
        showLoading();
        google.script.run
          .withSuccessHandler(res => {
            hideLoading();
            res = coerceGsResponse_(res);
            if (!res || res.ok === false) {
              alert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c th√¥ng tin ƒë∆°n ƒë·ªÉ thu n·ª£: " +
                (res && res.error ? res.error : "Kh√¥ng x√°c ƒë·ªãnh"));
              return;
            }
            const h = res.header || {};
            CURRENT_PAYMENT_ROW = rowIndex;
            CURRENT_PAYMENT_PHONE = h.sdt || "";
            CURRENT_PAYMENT_OLD_STATUS = h.trangThai || "";
            CURRENT_PAYMENT_OLD_DEBT   = Number(h.congNo || 0);

            document.getElementById("payInfoDate").textContent = h.date || "";
            document.getElementById("payInfoCustomer").textContent =
              (h.tenKH || "") + (h.sdt ? " - " + h.sdt : "");
            document.getElementById("payInfoTotal").textContent =
              formatMoney(h.tongDon || 0) + " ƒë";
            document.getElementById("payInfoDebt").textContent =
              formatMoney(h.congNo || 0) + " ƒë";
            document.getElementById("payInfoStatus").textContent =
              h.trangThai || "";

                        document.getElementById("payAmountInput").value =
              formatMoney(h.congNo || 0);
            document.getElementById("payPromoInput").value = "";

            // Ng√†y thu n·ª£ m·∫∑c ƒë·ªãnh = h√¥m nay (ho·∫∑c ng√†y thanh to√°n c≈© n·∫øu c√≥)
            const payDateEl = document.getElementById("payDateInput");
            if (payDateEl) {
              if (h.ngayThanhToan) {
                // h.ngayThanhToan d·∫°ng dd/MM/yyyy ho·∫∑c yyyy-MM-dd => b·∫°n chu·∫©n ho√° theo format ƒëang d√πng
                const s = String(h.ngayThanhToan);
                // n·∫øu ƒë√£ l√† yyyy-MM-dd th√¨ d√πng lu√¥n, c√≤n kh√¥ng th√¨ fallback h√¥m nay
                if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                  payDateEl.value = s;
                } else {
                  const todayStr = new Date().toISOString().slice(0,10);
                  payDateEl.value = todayStr;
                }
              } else {
                const todayStr = new Date().toISOString().slice(0,10);
                payDateEl.value = todayStr;
              }
            }

            // NEW: set select tr·∫°ng th√°i m·ªõi, m·∫∑c ƒë·ªãnh = tr·∫°ng th√°i hi·ªán t·∫°i
            const sel = document.getElementById("payNewStatusSelect");
            if (sel) {
              sel.value = h.trangThai || "Ghi n·ª£";
            }

            document.getElementById("payError").textContent = "";

            setDisplay_("paymentPopupOverlay","flex");

          })
          .withFailureHandler(err => {
            hideLoading();
            alert("L·ªói h·ªá th·ªëng khi m·ªü popup thu n·ª£: " + (err && err.message ? err.message : err));
          })
          .getOrderDetailByDebtRow(rowIndex);
      }

      function closePaymentPopup() {
        CURRENT_PAYMENT_ROW = null;
        CURRENT_PAYMENT_PHONE = "";
        CURRENT_PAYMENT_OLD_STATUS = "";
        CURRENT_PAYMENT_OLD_DEBT   = 0;
        setDisplay_("paymentPopupOverlay","none");
        document.getElementById("payError").textContent = "";
      }

      function submitPayment() {
        const errEl = document.getElementById("payError");
        errEl.textContent = "";

        if (!CURRENT_PAYMENT_ROW) {
          errEl.textContent = "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c d√≤ng c√¥ng n·ª£.";
          return;
        }

                const payAmount   = parseMoney(document.getElementById("payAmountInput").value || 0);
        const promoAmount = parseMoney(document.getElementById("payPromoInput").value || 0);
        const payDateStr  = (document.getElementById("payDateInput")?.value || "").trim();

        const sel = document.getElementById("payNewStatusSelect");
        const newStatus = sel ? sel.value : CURRENT_PAYMENT_OLD_STATUS;

        if (!payDateStr) {
          errEl.textContent = "Vui l√≤ng ch·ªçn ng√†y thu n·ª£.";
          return;
        }


        if (payAmount < 0 || promoAmount < 0) {
          errEl.textContent = "S·ªë ti·ªÅn thanh to√°n / khuy·∫øn m√£i kh√¥ng ƒë∆∞·ª£c √¢m.";
          return;
        }
        if (payAmount === 0 && promoAmount === 0 && newStatus === CURRENT_PAYMENT_OLD_STATUS) {
          errEl.textContent = "Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë·ªÉ c·∫≠p nh·∫≠t.";
          return;
        }

        if (payAmount > CURRENT_PAYMENT_OLD_DEBT && CURRENT_PAYMENT_OLD_DEBT > 0) {
          const ok = confirm(
            "S·ªë ti·ªÅn thanh to√°n l·ªõn h∆°n c√¥ng n·ª£ hi·ªán t·∫°i.\n" +
            "B·∫°n v·∫´n mu·ªën ti·∫øp t·ª•c? (C√¥ng n·ª£ s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v·ªÅ 0 ho·∫∑c theo tr·∫°ng th√°i m·ªõi)"
          );
          if (!ok) return;
        }

        showLoading();
        google.script.run
          .withSuccessHandler(res => {
            hideLoading();
            res = coerceGsResponse_(res);
            if (!res || res.ok === false) {
              errEl.textContent =
                "L·ªói c·∫≠p nh·∫≠t thu n·ª£: " + (res && res.error ? res.error : "Kh√¥ng x√°c ƒë·ªãnh");
              return;
            }
            alert(res.message || "ƒê√£ c·∫≠p nh·∫≠t c√¥ng n·ª£.");
            const sdt = CURRENT_PAYMENT_PHONE;
            closePaymentPopup();
            loadDebtFull();
            loadCustomersFull();
            if (sdt) loadCustomerHistory(sdt);
          })
          .withFailureHandler(err => {
            hideLoading();
            errEl.textContent =
              "L·ªói h·ªá th·ªëng khi thu n·ª£: " + (err && err.message ? err.message : err);
          })
                    .processDebtPayment(
            CURRENT_PAYMENT_ROW,
            payAmount,
            promoAmount,
            newStatus,
            payDateStr,
            "<?= username ?>"
          );

      }

      function openCustomerFullPayment(phone) {
        const errEl = document.getElementById("payError");
        if (errEl) errEl.textContent = "";

        phone = (phone || "").trim();
        if (!phone) {
          alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c SƒêT kh√°ch h√†ng.");
          return;
        }

        const confirmMsg =
          "B·∫°n mu·ªën THU N·ª¢ TO√ÄN B·ªò cho kh√°ch h√†ng:\n\n" +
          `SƒêT: ${phone}\n` +
          "H·ªá th·ªëng s·∫Ω ƒë∆∞a to√†n b·ªô c√¥ng n·ª£ c·ªßa kh√°ch n√†y v·ªÅ 0 v√† ƒë√°nh d·∫•u c√°c ƒë∆°n l√† 'ƒê√£ thanh to√°n'.\n\n" +
          "B·∫°n ch·∫Øc ch·∫Øn ch·ª©?";
        const ok = confirm(confirmMsg);
        if (!ok) return;

        showLoading();
        google.script.run
          .withSuccessHandler(res => {
            hideLoading();
            res = coerceGsResponse_(res);
            if (!res || res.ok === false) {
              alert(
                "L·ªói thu n·ª£ to√†n b·ªô: " +
                (res && res.error ? res.error : "Kh√¥ng x√°c ƒë·ªãnh")
              );
              return;
            }

            alert(
              (res.message || "ƒê√£ thu n·ª£ to√†n b·ªô cho kh√°ch h√†ng.") +
              (res.totalOrders != null
                ? `\nS·ªë ƒë∆°n ƒë∆∞·ª£c c·∫≠p nh·∫≠t: ${res.totalOrders}`
                : "")
            );

            // Reload l·∫°i data cho s·∫°ch
            const sdt = phone;
            loadDebtFull();
            loadCustomersFull();
            if (sdt) {
              loadCustomerHistory(sdt);
              loadInlineHistory(sdt);
            }
          })
          .withFailureHandler(err => {
            hideLoading();
            alert(
              "L·ªói h·ªá th·ªëng khi thu n·ª£ to√†n b·ªô: " +
              (err && err.message ? err.message : err)
            );
          })
          .processAllDebtPaymentForCustomer(phone, "<?= username ?>");
      }

      /*********** POPUP L·ªäCH S·ª¨ C√îNG N·ª¢ KH√ÅCH H√ÄNG (THEO TH·ªúI GIAN) ************/
      // ====== POPUP CHI TI·∫æT C√îNG N·ª¢ KH√ÅCH H√ÄNG (L·ªäCH S·ª¨ THEO TH·ªúI GIAN) ======
let CURRENT_HISTORY_PHONE = '';

function openCustomerHistoryDetail(phone, name) {
  CURRENT_HISTORY_PHONE = (phone || '').trim();
  if (!CURRENT_HISTORY_PHONE) return;

  const modal = document.getElementById('customerHistoryDetailModal');
  const title = document.getElementById('chd-title');
  const info  = document.getElementById('chd-customer');
  const tbody = document.getElementById('chd-tbody');

  if (title) title.textContent = 'CHI TI·∫æT C√îNG N·ª¢ KH√ÅCH H√ÄNG';
  if (info)  info.textContent  = `Kh√°ch: ${name || ''} - ${phone}`;
  if (tbody) tbody.innerHTML   = '';   // xo√° s·∫°ch n·ªôi dung c≈© ngay l·∫≠p t·ª©c

  // Kho·∫£ng th·ªùi gian m·∫∑c ƒë·ªãnh: 1 th√°ng g·∫ßn nh·∫•t
  const today  = new Date();
  const toStr  = today.toISOString().slice(0, 10);
  const from   = new Date(today);
  from.setMonth(from.getMonth() - 1);
  const fromStr = from.toISOString().slice(0, 10);

  document.getElementById('chd-from').value = fromStr;
  document.getElementById('chd-to').value   = toStr;

  if (modal) modal.style.display = 'flex';

  // g·ªçi load d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
  reloadCustomerHistoryDetail();
}

function closeCustomerHistoryDetail() {
  const modal = document.getElementById('customerHistoryDetailModal');
  if (modal) modal.style.display = 'none';
}

function setCustomerHistoryDetailLoading(isLoading) {
  const loadingEl = document.getElementById('chd-loading');
  const tbody     = document.getElementById('chd-tbody');

  if (loadingEl) loadingEl.style.display = isLoading ? 'flex' : 'none';
  if (tbody)     tbody.style.opacity     = isLoading ? '0.0' : '1';

  // d√πng overlay t·ªïng cho ch·∫Øc ‚Äì t·ªõi khi render xong m·ªõi t·∫Øt
  if (isLoading) {
    showLoading();
  } else {
    hideLoading();
  }
}

function reloadCustomerHistoryDetail() {
  if (!CURRENT_HISTORY_PHONE) return;

  const tbody = document.getElementById('chd-tbody');
  if (tbody) tbody.innerHTML = '';   // xo√° n·ªôi dung c≈© ngay khi b·∫Øt ƒë·∫ßu load

  const fromDate = document.getElementById('chd-from').value || '';
  const toDate   = document.getElementById('chd-to').value   || '';

  setCustomerHistoryDetailLoading(true);

  google.script.run
    .withSuccessHandler(function(res) {
      try {
        renderCustomerHistoryDetailTimeline(res);
      } finally {
        setCustomerHistoryDetailLoading(false);
      }
    })
    .withFailureHandler(function(err) {
      setCustomerHistoryDetailLoading(false);
      alert('L·ªói t·∫£i l·ªãch s·ª≠ c√¥ng n·ª£: ' + (err && err.message ? err.message : err));
    })
    .getDebtTimelineByPhone(CURRENT_HISTORY_PHONE, fromDate, toDate);
}

function renderCustomerHistoryDetailTimeline(res) {
  const tbody = document.getElementById('chd-tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (!res || !res.ok) {
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td colspan="6" style="color:#b91c1c;">${
        res && res.error ? res.error : 'Kh√¥ng c√≥ d·ªØ li·ªáu.'
      }</td>`;
    tbody.appendChild(tr);
    return;
  }

  // C·∫≠p nh·∫≠t info kh√°ch
  if (res.customer) {
    const c = res.customer;
    const info = document.getElementById('chd-customer');
    if (info) {
      info.textContent =
        `Kh√°ch: ${(c.tenKhach || '')} - ${(c.phone || '')}` +
        (c.maKhach ? ` (M√£: ${c.maKhach})` : '');
    }
  }

  if (!res.rows || !res.rows.length) {
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td colspan="6">Kh√¥ng c√≥ ph√°t sinh trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</td>`;
    tbody.appendChild(tr);
    return;
  }

  res.rows.forEach(function(r) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date || ''}</td>
      <td>${r.soChungTu || ''}</td>
      <td>${r.dienGiai || ''}</td>
      <td style="text-align:right;">${r.tang ? r.tang.toLocaleString('vi-VN') : ''}</td>
      <td style="text-align:right;">${r.giam ? r.giam.toLocaleString('vi-VN') : ''}</td>
      <td style="text-align:right;">${
        typeof r.conNo === 'number' ? r.conNo.toLocaleString('vi-VN') : ''
      }</td>
    `;
    tbody.appendChild(tr);
  });
}

  function dmShowMsg(msg, isErr) {
  const box = document.getElementById("dmMsg");
  if (!box) return;
  box.style.color = isErr ? "#b91c1c" : "#065f46";
  box.textContent = msg || "";
}

function dmReload() {
  showLoading();
  google.script.run
    .withSuccessHandler(list => {
      try {
        const tbody = document.querySelector("#tblMenu tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
              DM_LOAI_OPTIONS = Array.from(new Set((list || [])
        .map(it => (it.loaiMon || it.loai || it.category || "").trim())
        .filter(Boolean)
      ));

        (list || []).forEach(it => {
          const tr = document.createElement("tr");
          tr.dataset.row = it.rowIndex;

          tr.innerHTML = `
            <td style="text-align:center;">${it.rowIndex -1}</td>
            <td><input class="dm-ten" value="${escHtml(it.ten)}" style="width:100%"></td>
            <td><input class="dm-dvt" value="${escHtml(it.dvt || "ƒêƒ©a")}" style="width:100%"></td>
            <td style="text-align:right;"><input class="dm-gia money-input" value="${formatMoney(it.gia || 0)}" style="width:100%"></td>

            <td>${buildLoaiSelectHtml(it.loaiMon || it.loai || it.category || "")}</td>

            <td style="text-align:center; display:flex; justify-content: center">
              <button type="button" class="secondary" onclick="dmSave(this)"> L∆∞u</button>
              <button type="button" class="danger" onclick="dmDel(this)"> X√≥a</button>
            </td>
          `;


          const giaEl = tr.querySelector(".dm-gia");
          if (giaEl) {
            giaEl.addEventListener("blur", () => {
              giaEl.value = formatMoney(parseMoney(giaEl.value));
            });
          }

          tbody.appendChild(tr);
        });

        dmShowMsg(`ƒê√£ t·∫£i ${list.length || 0} m√≥n.`, false);
      } finally {
        hideLoading();
      }
    })
    .withFailureHandler(err => {
      hideLoading();
      dmShowMsg("L·ªói t·∫£i danh m·ª•c: " + (err && err.message ? err.message : err), true);
    })
    .dm_list();
}

function dmAddRow() {
  const tbody = document.querySelector("#tblMenu tbody");
  if (!tbody) return;

  const tr = document.createElement("tr");
  tr.dataset.row = ""; // row m·ªõi

  tr.innerHTML = `
  <td style="text-align:center;">(new)</td>
  <td><input class="dm-ten" value="" placeholder="T√™n m√≥n..." style="width:100%"></td>
  <td><input class="dm-dvt" value="ƒêƒ©a" style="width:100%"></td>
  <td style="text-align:right;"><input class="dm-gia money-input" value="0" style="width:100%"></td>
  <td>${buildLoaiSelectHtml("")}</td>
  <td style="text-align:center; display:flex;justify-content:center">
    <button type="button" class="secondary" onclick="dmSave(this)">L∆∞u</button>
    <button type="button" class="danger" onclick="dmDel(this)">X√≥a</button>
  </td>
`;

  tbody.insertBefore(tr, tbody.firstChild);

  const giaEl = tr.querySelector(".dm-gia");
  if (giaEl) giaEl.addEventListener("blur", () => giaEl.value = formatMoney(parseMoney(giaEl.value)));
}

function dmSave(btn) {
  const tr = btn.closest("tr");
  if (!tr) return;

  const payload = {
  rowIndex: tr.dataset.row ? Number(tr.dataset.row) : null,
  ten: tr.querySelector(".dm-ten")?.value || "",
  dvt: tr.querySelector(".dm-dvt")?.value || "ƒêƒ©a",
  gia: parseMoney(tr.querySelector(".dm-gia")?.value || 0),
  loaiMon: tr.querySelector(".dm-loai")?.value || ""
};



  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if (!res || !res.ok) {
        dmShowMsg("L·ªói l∆∞u: " + (res && res.error ? res.error : "Kh√¥ng x√°c ƒë·ªãnh"), true);
        return;
      }
      dmShowMsg("ƒê√£ l∆∞u danh m·ª•c.", false);

      // reload danh m·ª•c + reload MENU ƒë·ªÉ tab phi·∫øu nh·∫≠p d√πng ngay
      dmReload();
      reloadMenuForOrderForm();
    })
    .withFailureHandler(err => {
      hideLoading();
      dmShowMsg("L·ªói h·ªá th·ªëng khi l∆∞u: " + (err && err.message ? err.message : err), true);
    })
    .dm_upsert(payload);
}

function dmDel(btn) {
  const tr = btn.closest("tr");
  if (!tr) return;

  const rowIndex = Number(tr.dataset.row || 0);
  if (!rowIndex) {
    tr.remove();
    return;
  }

  if (!confirmDelete("X√≥a m√≥n n√†y kh·ªèi danh m·ª•c?")) return;

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if (!res || !res.ok) {
        dmShowMsg("L·ªói x√≥a: " + (res && res.error ? res.error : "Kh√¥ng x√°c ƒë·ªãnh"), true);
        return;
      }
      dmShowMsg("ƒê√£ x√≥a m√≥n.", false);

      dmReload();
      reloadMenuForOrderForm();
    })
    .withFailureHandler(err => {
      hideLoading();
      dmShowMsg("L·ªói h·ªá th·ªëng khi x√≥a: " + (err && err.message ? err.message : err), true);
    })
    .dm_delete(rowIndex);
}
function deleteMon(code) {
  if (!confirmDelete("Xo√° m√≥n n√†y? (soft delete)")) return;

  google.script.run
    .withSuccessHandler(function(res){
      if (!res || !res.ok) {
        alert(res?.message || "Xo√° th·∫•t b·∫°i");
        return;
      }
      loadDanhMucHang(); // reload l·∫°i danh m·ª•c
    })
    .withFailureHandler(function(err){
      alert(err.message || err);
    })
    .dm_softDeleteItem(code);
}
// Reload MENU (phi·∫øu nh·∫≠p) sau khi DM thay ƒë·ªïi
function reloadMenuForOrderForm() {
  google.script.run
    .withSuccessHandler(data => {
      if (!data) return;
      MENU = (data.menu || []).map(m => Object.assign({}, m, { name: menuName_(m), unit: menuUnit_(m), price: menuPrice_(m), type: menuType_(m) }));
      buildMenuIndex_();
        initOrderMenuSearch();

      // rebuild selectMon
      const sel = document.getElementById("selectMon");
      if (sel) sel.innerHTML = '<option value="">-- Ch·ªçn m√≥n --</option>';
      MENU.forEach((m, idx) => {
        if (!sel) return;
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = `${m.ten} (${m.dvt || "ƒêƒ©a"}) - ${formatMoney(m.gia)} ƒë`;
        sel.appendChild(opt);
      });

      // rebuild datalist
      const dl = document.getElementById("menuDatalist");
      if (dl) {
        dl.innerHTML = "";
        MENU.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.ten;
          dl.appendChild(opt);
        });
      }
    })
    .getInitData();
}

      /*********** GPT SLIDER ************/
      let gptMessages = [];

      function resetGptConversation() {
        gptMessages = [{
          role: 'system',
          content: 'B·∫°n l√† tr·ª£ l√Ω gi√∫p ph√¢n t√≠ch d·ªØ li·ªáu c√¥ng n·ª£ v√† doanh s·ªë. ' +
                   'Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, ng·∫Øn g·ªçn, r√µ r√†ng.'
        }];
        const box = document.getElementById('gptChatHistory');
        if (box) box.innerHTML = '';
        const qEl = document.getElementById('gptQuestion');
        if (qEl) qEl.value = '';
        const errEl = document.getElementById('gptError');
        if (errEl) errEl.textContent = '';
      }

      function openGptSlider() {
        const overlay = document.getElementById('gptSliderOverlay');
        if (!overlay) return;
        if (!gptMessages.length) {
          resetGptConversation();
        }
        overlay.style.display = 'flex';
        requestAnimationFrame(() => {
          overlay.classList.add('open');
        });
      }

      function closeGptSlider() {
        const overlay = document.getElementById('gptSliderOverlay');
        if (!overlay) return;
        overlay.classList.remove('open');
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 250);
      }

      function appendGptMessage(role, text) {
        const box = document.getElementById('gptChatHistory');
        if (!box) return;
        const div = document.createElement('div');
        div.style.marginBottom = '6px';

        if (role === 'user') {
          div.style.textAlign = 'right';
          div.innerHTML = `
            <div style="display:inline-block; max-width:80%;
                        background:#e5f3ff; color:#111827;
                        padding:6px 8px; border-radius:10px;">
              <b>B·∫°n:</b> ${text.replace(/\n/g, '<br>')}
            </div>`;
        } else {
          div.style.textAlign = 'left';
          div.innerHTML = `
            <div style="display:inline-block; max-width:80%;
                        background:#f3f4f6; color:#111827;
                        padding:6px 8px; border-radius:10px;">
              <b>GPT:</b> ${text.replace(/\n/g, '<br>')}
            </div>`;
        }

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      }

      function sendGptQuestion() {
        const qEl   = document.getElementById('gptQuestion');
        const errEl = document.getElementById('gptError');
        if (!qEl || !errEl) return;

        const text = (qEl.value || '').trim();
        if (!text) {
          errEl.textContent = 'B·∫°n ch∆∞a nh·∫≠p c√¢u h·ªèi.';
          return;
        }
        errEl.textContent = '';

        gptMessages.push({ role: 'user', content: text });
        appendGptMessage('user', text);
        qEl.value = '';

        if (typeof showLoading === 'function') showLoading();

        google.script.run
          .withSuccessHandler(function(res) {
            if (typeof hideLoading === 'function') hideLoading();

            if (!res || !res.ok) {
              errEl.textContent =
                'L·ªói GPT: ' + (res && res.error ? res.error : 'Kh√¥ng x√°c ƒë·ªãnh');
              return;
            }
            const answer = res.answer || '';
            gptMessages.push({ role: 'assistant', content: answer });
            appendGptMessage('assistant', answer);
          })
          .withFailureHandler(function(err) {
            if (typeof hideLoading === 'function') hideLoading();
            errEl.textContent =
              'L·ªói h·ªá th·ªëng: ' + (err && err.message ? err.message : err);
          })
          .chatWithDebtData(gptMessages);
      }

      function logout() {
        window.location.href = '<?= ScriptApp.getService().getUrl() ?>';
      }

      window.addEventListener("load", () => {
        init();
        if (typeof initDashboard === "function") {
          initDashboard();
        }
      });
        function reloadCustomerHistory() {
    if (!currentHistoryPhone) return;

    const fromDate = document.getElementById('kh-history-from').value || '';
    const toDate   = document.getElementById('kh-history-to').value   || '';

    showCustomerHistoryLoading(true);

    google.script.run
      .withSuccessHandler(function(res) {
        showCustomerHistoryLoading(false);
        renderDebtTimeline(res);
      })
      .withFailureHandler(function(err) {
        showCustomerHistoryLoading(false);
        alert('L·ªói t·∫£i l·ªãch s·ª≠ c√¥ng n·ª£: ' + (err && err.message ? err.message : err));
      })
      .getDebtTimelineByPhone(currentHistoryPhone, fromDate, toDate);
  }
      function showChangePasswordOverlay() {
        const el = document.getElementById("changePasswordOverlay");
        if (!el) return;
        el.style.display = "flex";
      }

      function hideChangePasswordOverlay() {
        const el = document.getElementById("changePasswordOverlay");
        if (!el) return;
        el.style.display = "none";
      }
let __mustChangeLock = false;

function initMustChangeGate_() {
  const raw = (typeof MUST_CHANGE_PASSWORD !== "undefined") ? MUST_CHANGE_PASSWORD : (window.MUST_CHANGE_PASSWORD || false);
  const must = (raw === true) || (String(raw).toLowerCase() === "true") || (String(raw) === "1");

  if (!must) {
    if (typeof lockAppForMustChange_ === "function") lockAppForMustChange_(false);
    return;
  }

  if (typeof lockAppForMustChange_ === "function") lockAppForMustChange_(true);
  if (typeof showChangePasswordOverlay === "function") showChangePasswordOverlay();

  // focus input ƒë·∫ßu
  setTimeout(() => {
    const el = document.getElementById("cp-old");
    if (el) el.focus();
  }, 50);
}

function ensureAdminAccountBtn_() {
  const role =
    (typeof ROLE !== "undefined" && ROLE ? String(ROLE) : "") ||
    (window.USER_ROLE ? String(window.USER_ROLE) : "");
  if (String(role).toLowerCase() !== "admin") return;

  if (document.getElementById("btnAccAdmin")) return;

  const gptBtn =
    document.getElementById("btnChatgpt") ||
    document.querySelector("button[onclick*='openGptSlider']") ||
    document.querySelector("button[onclick*='openGpt']");

  const btn = document.createElement("button");
  btn.id = "btnAccAdmin";
  btn.className = "btn btn-sm";
  btn.textContent = "T√†i kho·∫£n";
  btn.style.marginLeft = "8px";
  btn.onclick = () => {
    if (typeof openAccountsAdminOverlay === "function") return openAccountsAdminOverlay();
    if (typeof openAccountAdminOverlay === "function") return openAccountAdminOverlay();
    if (typeof openAccountManagerOverlay === "function") return openAccountManagerOverlay();
    alert("Ch∆∞a t√¨m th·∫•y h√†m m·ªü qu·∫£n l√Ω t√†i kho·∫£n (openAccountsAdminOverlay).");
  };

  // ===== config button (admin) =====
  let cfgBtn = document.getElementById("btnConfigAdmin");
  if (!cfgBtn) {
    cfgBtn = document.createElement("button");
    cfgBtn.id = "btnConfigAdmin";
    cfgBtn.className = "btn btn-sm";
    cfgBtn.textContent = "C·∫•u h√¨nh";
    cfgBtn.style.marginLeft = "8px";
    cfgBtn.onclick = () => {
      if (typeof openTaxConfigOverlay_ === "function") return openTaxConfigOverlay_();
      alert("Ch∆∞a t√¨m th·∫•y h√†m m·ªü c·∫•u h√¨nh (openTaxConfigOverlay_).");
    };
  }


  if (gptBtn && gptBtn.parentElement) {
    gptBtn.insertAdjacentElement("afterend", btn);
    btn.insertAdjacentElement("afterend", cfgBtn);
  } else {
    // fallback: g·∫Øn v√†o top bar b·∫•t k·ª≥
    const top = document.querySelector(".top-actions") || document.querySelector(".tab-bar") || document.body;
    top.appendChild(btn);
    top.appendChild(cfgBtn);
  }
}
function openTaxConfigOverlay_(){
  // n√∫t ƒëang g·ªçi t√™n n√†y
  return openConfigPopup();
}

function closeTaxConfigOverlay_(){
  return closeConfigPopup();
}



  // Aliases for account admin overlay (backward compatibility)
  function openAccountsAdminOverlay(){ return openAccountManager(); }
  function openAccountAdminOverlay(){ return openAccountManager(); }
  function openAccountManagerOverlay(){ return openAccountManager(); }

  function openAccountManager() {
    if ((ROLE || "").toLowerCase() !== "admin") return alert("Kh√¥ng c√≥ quy·ªÅn admin.");

    let ov = document.getElementById("accAdminOverlay");
    if (!ov) {
      ov = document.createElement("div");
      ov.id = "accAdminOverlay";
      ov.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:999999";
      ov.innerHTML = `
        <div id="accAdminCard" style="width:min(980px,96vw);background:#fff;border-radius:12px;padding:12px;max-height:88vh;overflow:auto">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div style="font-weight:700">Qu·∫£n l√Ω t√†i kho·∫£n</div>
            <div style="display:flex;gap:8px">
              <input id="accImportFile" type="file" accept=".csv" style="display:none" />
              <button class="btn btn-sm" onclick="addEmptyAccountRow_()">Th√™m</button>
              <button class="btn btn-sm" onclick="closeAccountManager()">ƒê√≥ng</button>
            </div>
          </div>
          <div style="height:10px"></div>
          <div id="accAdminBody"></div>
        </div>
      `;
      document.body.appendChild(ov);

      const inp = ov.querySelector("#accImportFile");
      inp.addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const rd = new FileReader();
        rd.onload = () => importAccountsCsv_(String(rd.result || ""));
        rd.readAsText(f);
        inp.value = "";
      });
    }

    if (ov && ov.style) ov.style.display = "flex";
    loadAccountsAdmin_();
  }

  function closeAccountManager() {
    const ov = document.getElementById("accAdminOverlay");
    if (ov) if (ov && ov.style) ov.style.display = "none";
  }

  let __ACC_ROWS = [];

  function loadAccountsAdmin_() {
    const card = document.getElementById("accAdminCard");
    setSectionLoading_(card, true, "ƒêang t·∫£i t√†i kho·∫£n...");
    google.script.run
      .withSuccessHandler(res => {
        setSectionLoading_(card, false);
        if (!res || !res.ok) return alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c account.");
        __ACC_ROWS = res.rows || [];
        renderAccountsAdmin_();
      })
      .withFailureHandler(err => {
        setSectionLoading_(card, false);
        alert("L·ªói t·∫£i account: " + (err && err.message ? err.message : err));
      })
      .ui_listAccounts(CURRENT_USERNAME);
  }

  function renderAccountsAdmin_() {
    const box = document.getElementById("accAdminBody");
    if (!box) return;

    const rows = __ACC_ROWS || [];
    let html = `
      <table class="table" style="width:100%">
        <thead>
          <tr>
            <th>Username</th>
            <th>Password</th>
            <th>Quy·ªÅn</th>
            <th>K√≠ch ho·∫°t</th>
            <th>ƒê·ªïi m·∫≠t kh·∫©u khi ƒëƒÉng nh·∫≠p</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
    `;

    rows.forEach((r, i) => {
      const role = (r.role || "").toLowerCase();
      const status = (r.status || "").toLowerCase();
      html += `
        <tr>
          <td><input id="acc_u_${i}" value="${escHtml(r.username || "")}" ${r.username ? "readonly" : ""}></td>
          <td><input id="acc_pw_${i}" value="" placeholder="${r.username ? "(ƒë·ªÉ tr·ªëng = gi·ªØ nguy√™n)" : ""}"></td>
          <td>
            <select id="acc_role_${i}">
              <option value="admin" ${role==="admin"?"selected":""}>admin</option>
              <option value="manager" ${role==="manager"?"selected":""}>T·ªïng h·ª£p</option>
              <option value="cashier" ${role==="cashier"?"selected":""}>Thu ng√¢n</option>
            </select>
          </td>
          <td>
            <select id="acc_st_${i}">
              <option value="active" ${status!=="inactive"?"selected":""}>K√≠ch ho·∫°t</option>
              <option value="inactive" ${status==="inactive"?"selected":""}>Kh√≥a</option>
            </select>
          </td>
          <td style="text-align:center">
            <input id="acc_mc_${i}" type="checkbox" ${r.mustChangePassword ? "checked" : ""}>
          </td>
          <td style="text-align:right">
            <button class="btn btn-sm" onclick="saveAccountRow_(${i})">L∆∞u</button>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    box.innerHTML = html;
  }

  function addEmptyAccountRow_() {
    __ACC_ROWS = __ACC_ROWS || [];
    __ACC_ROWS.unshift({ username: "", displayName: "", role: "cashier", status: "on", mustChangePassword: true });
    renderAccountsAdmin_();
  }

  function saveAccountRow_(i) {
    const u = (document.getElementById(`acc_u_${i}`) || {}).value || "";
    const dn = (document.getElementById(`acc_dn_${i}`) || {}).value || "";
    const pw = (document.getElementById(`acc_pw_${i}`) || {}).value || "";
    const role = (document.getElementById(`acc_role_${i}`) || {}).value || "";
    const st = (document.getElementById(`acc_st_${i}`) || {}).value || "on";
    const mc = !!(document.getElementById(`acc_mc_${i}`) || {}).checked;

    if (!String(u).trim()) return alert("Thi·∫øu username.");

    const card = document.getElementById("accAdminCard");
    setSectionLoading_(card, true, "ƒêang l∆∞u...");
    google.script.run
      .withSuccessHandler(res => {
        setSectionLoading_(card, false);
        if (!res || !res.ok) return alert("L∆∞u th·∫•t b·∫°i.");
        loadAccountsAdmin_();
      })
      .withFailureHandler(err => {
        setSectionLoading_(card, false);
        alert("L·ªói l∆∞u: " + (err && err.message ? err.message : err));
      })
      .ui_upsertAccount(CURRENT_USERNAME, {
        username: String(u).trim(),
        displayName: String(dn || "").trim(),
        password: String(pw || ""),
        role: String(role || "").trim(),
        status: String(st || "").trim(),
        mustChangePassword: mc
      });
  }

  function importAccountsCsv_(csvText) {
    const text = String(csvText || "").trim();
    if (!text) return;

    const lines = text.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    if (!lines.length) return;

    const header = lines[0].split(",").map(x => x.trim().toLowerCase());
    const idx = (k) => header.indexOf(k);

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split(",").map(x => x.trim());
      const o = {
        username: parts[idx("username")] || "",
        password: parts[idx("password")] || "",
        displayName: parts[idx("display_name")] || parts[idx("displayname")] || "",
        role: parts[idx("role")] || "cashier",
        status: parts[idx("status")] || "on",
        mustChangePassword: String(parts[idx("must_change_password")] || "false").toLowerCase() === "true" ||
                            String(parts[idx("must_change_password")] || "0") === "1"
      };
      if (String(o.username).trim()) rows.push(o);
    }

    if (!rows.length) return alert("CSV kh√¥ng c√≥ d√≤ng h·ª£p l·ªá.");

    const card = document.getElementById("accAdminCard");
    setSectionLoading_(card, true, "ƒêang import...");
    google.script.run
      .withSuccessHandler(res => {
        setSectionLoading_(card, false);
        if (!res || !res.ok) return alert("Import th·∫•t b·∫°i.");
        loadAccountsAdmin_();
      })
      .withFailureHandler(err => {
        setSectionLoading_(card, false);
        alert("L·ªói import: " + (err && err.message ? err.message : err));
      })
      .ui_bulkUpsertAccounts(CURRENT_USERNAME, rows);
  }

  document.addEventListener("DOMContentLoaded", () => {
    initMustChangeGate_();
    ensureAdminAccountBtn_();
    loadTaxConfig_();
  });
function submitChangePassword() {
  const curEl = document.getElementById("cp-old");
  const newEl = document.getElementById("cp-new");
  const repEl = document.getElementById("cp-new2");
  const errEl = document.getElementById("changePwdError");

  if (!curEl || !newEl || !repEl || !errEl) return;

  const cur = String(curEl.value || "").trim();
  const pw1 = String(newEl.value || "").trim();
  const pw2 = String(repEl.value || "").trim();
  errEl.textContent = "";

  if (!cur || !pw1 || !pw2) {
    errEl.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß 3 √¥ m·∫≠t kh·∫©u.";
    return;
  }
  if (pw1.length < 6) {
    errEl.textContent = "M·∫≠t kh·∫©u m·ªõi ph·∫£i √≠t nh·∫•t 6 k√Ω t·ª±.";
    return;
  }
  if (pw1 !== pw2) {
    errEl.textContent = "M·∫≠t kh·∫©u m·ªõi nh·∫≠p l·∫°i kh√¥ng kh·ªõp.";
    return;
  }

  // loading ch·ªâ tr√™n popup (kh√¥ng che c·∫£ app)
  const popupCard = document.querySelector("#changePasswordOverlay .edit-popup");
  if (typeof setSectionLoading_ === "function") setSectionLoading_(popupCard, true, "ƒêang ƒë·ªïi m·∫≠t kh·∫©u...");

  google.script.run
    .withSuccessHandler((res) => {
      if (typeof setSectionLoading_ === "function") setSectionLoading_(popupCard, false);

      if (!res || res.ok !== true) {
        // Code.gs tr·∫£ message :contentReference[oaicite:3]{index=3}
        errEl.textContent = "ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i: " + (res && (res.message || res.error) ? (res.message || res.error) : "Kh√¥ng x√°c ƒë·ªãnh");
        return;
      }

      // ƒë·ªïi ok => m·ªü kh√≥a app, t·∫Øt overlay
      try { window.MUST_CHANGE_PASSWORD = false; } catch(e) {}
      alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng. L·∫ßn ƒëƒÉng nh·∫≠p sau h√£y d√πng m·∫≠t kh·∫©u m·ªõi.");

      if (typeof hideChangePasswordOverlay === "function") hideChangePasswordOverlay();
      if (typeof lockAppForMustChange_ === "function") lockAppForMustChange_(false);
    })
    .withFailureHandler((err) => {
      if (typeof setSectionLoading_ === "function") setSectionLoading_(popupCard, false);
      errEl.textContent = "L·ªói h·ªá th·ªëng khi ƒë·ªïi m·∫≠t kh·∫©u: " + (err && err.message ? err.message : err);
    })
    .updateUserPassword(CURRENT_USERNAME, cur, pw1);
}

      let __histMode = 'pending';
  let __selectedDebtRow = null;

  
/* =========================
   RIGHT PANEL: ƒê∆†N CH·ªú + L·ªäCH S·ª¨ ƒê∆†N
   - ƒê∆°n ch·ªù: lu√¥n hi·ªÉn th·ªã to√†n b·ªô, KH√îNG l·ªçc theo SƒêT
   - L·ªãch s·ª≠ ƒë∆°n: l·ªçc theo SƒêT, click d√≤ng ƒë·ªÉ xem chi ti·∫øt b√™n d∆∞·ªõi + n√∫t In (kh√¥ng popup)
   ========================= */

let __RIGHT_TAB = "pending";
let __PENDING_CACHE = [];
let __HISTORY_CACHE = [];
let __HISTORY_PHONE = "";

function switchRightTab(tab) {
  tab = tab || "pending";
  __RIGHT_TAB = tab;

  const b1 = document.getElementById("rightTabPendingBtn");
  const b2 = document.getElementById("rightTabHistoryBtn");
  const w1 = document.getElementById("rightPendingWrap");
  const w2 = document.getElementById("rightHistoryWrap");

  if (b1) b1.classList.toggle("active", tab === "pending");
  if (b2) b2.classList.toggle("active", tab === "history");

  if (w1) w1.style.display = (tab === "pending") ? "" : "none";
  if (w2) w2.style.display = (tab === "history") ? "" : "none";
}

function loadPendingAllRight() {
  const wrap =
    document.getElementById("rightPendingWrap") ||
    document.getElementById("pendingRightWrap") ||
    document.getElementById("pendingWrap");

  const tbody =
    document.querySelector("#tblPendingRight tbody") ||
    document.querySelector("#tblPending tbody");

  if (!wrap || !tbody) {
    return;
  }

  setSectionLoading_(wrap, true, "ƒêang t·∫£i ƒë∆°n ch·ªù...");
  tbody.innerHTML = "";

  if (!(typeof google !== "undefined" && google.script && google.script.run)) {
    setSectionLoading_(wrap, false);
    alert("google.script.run kh√¥ng kh·∫£ d·ª•ng.");
    return;
  }

  google.script.run
    .withSuccessHandler((res) => {
      setSectionLoading_(wrap, false);
      const rows = _normRows_(res);

      // render chu·∫©n c·ªßa b·∫°n
      if (typeof renderPendingRight === "function") {
        renderPendingRight(rows);
        return;
      }

      // fallback
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#6b7280;padding:10px">Kh√¥ng c√≥ ƒë∆°n ch·ªù.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.dateStr || ""}</td>
          <td>${escapeHtml_(r.info || "")}</td>
          <td style="text-align:right">${r.soMam || ""}</td>
          <td style="text-align:right">${formatMoney_(r.tongDon || r.tong || 0)}</td>
          <td>${escapeHtml_(r.status || "")}</td>
          <td></td>
        </tr>
      `).join("");
    })
    .withFailureHandler((err) => {
      setSectionLoading_(wrap, false);
      alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c ƒë∆°n ch·ªù: " + (err && err.message ? err.message : err));
    })
    .ui_listPendingAll();
}

function renderPendingRight(rows) {
  const tbody = document.querySelector("#tblPendingRight tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  if (!rows || !rows.length) {
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Kh√¥ng c√≥ ƒë∆°n ch·ªù</td></tr>";
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.dataset.row = String(r.row || "");
    tr.dataset.orderId = String(r.orderId || "");
    
    const dateStr = formatDateDMY_(r.dateRaw || r.date || r.dateStr || "");
    const info = r.info || "";
    const soMam = Number(r.soMam || 0) || 0;
    const soMon = Number(r.soMon || 0) || 0;
    
    const datCoc = Number(r.datCoc || 0);
    const isOnlyDeposit = (Number(r.soMon || 0) === 0 && datCoc > 0);
    const status = isOnlyDeposit ? "ƒê·∫∑t c·ªçc" : (r.status || "ƒê∆°n ch·ªù");
    const mamText = `${soMam}${soMon ? ` (${soMon} m√≥n)` : ""}`;
    const tong = isOnlyDeposit ? datCoc : (r.tongDon || 0);
    const actionBtns = `
      <button type="button" class="icon-btn" title="In" onclick="openPrintInvoicePending(${r.row})">üñ®Ô∏è</button>
      ${CAN_EDIT ? `<button type="button" class="icon-btn" title="S·ª≠a" onclick="openPendingEditPopup(${r.row})">‚úèÔ∏è</button>` : ``}
      ${CAN_EDIT ? `<button type="button" class="icon-btn" title="Xo√°" onclick="deletePendingRight(${r.row})">üóëÔ∏è</button>` : ``}
    `;

    const btnEdit = (typeof CAN_EDIT !== "undefined" && CAN_EDIT) ? `<button type="button" class="icon-btn" title="S·ª≠a" onclick="openPendingEditPopup(${r.row})">‚úèÔ∏è</button>` : "";
    const btnDel  = (typeof CAN_EDIT !== "undefined" && CAN_EDIT) ? `<button type="button" class="icon-btn" title="Xo√°" onclick="deletePendingRight(${r.row})">üóëÔ∏è</button>` : "";
    tr.innerHTML = `
      <td>${escapeHtml(dateStr)}</td>
      <td>${escapeHtml(info)}</td>
      <td style="text-align:center;">${escapeHtml(mamText)}</td>
      <td style="text-align:right;">${formatMoney(tong)} ƒë</td>
      <td><span class="status-pill status-pending">${escapeHtml(status)}</span></td>
      <td style="text-align:center; white-space:nowrap;">
        ${actionBtns}
      </td>
    `;
    tbody.appendChild(tr);

  });
}

function _pendingFindRowTr_(rowIndex){
  const tbody = document.querySelector("#tblPendingRight tbody");
  if (!tbody) return null;
  return tbody.querySelector(`tr[data-row="${Number(rowIndex||0)}"]`);
}

function _pendingShiftRowsAfterDelete_(deletedRow){
  deletedRow = Number(deletedRow||0);
  const tbody = document.querySelector("#tblPendingRight tbody");
  if (!tbody) return;

  const trs = Array.from(tbody.querySelectorAll("tr[data-row]"));
  trs.forEach(tr=>{
    const oldRow = Number(tr.dataset.row||0);
    if (!oldRow || oldRow <= deletedRow) return;
    const newRow = oldRow - 1;
    tr.dataset.row = String(newRow);

    // update onclick values in buttons
    tr.querySelectorAll("button[onclick]").forEach(btn=>{
      const oc = btn.getAttribute("onclick") || "";
      const updated = oc.replace(/\(\s*\d+\s*\)/, `(${newRow})`);
      btn.setAttribute("onclick", updated);
    });
  });
}

function _pendingRemoveRow_(rowIndex){
  const tr = _pendingFindRowTr_(rowIndex);
  if (tr) tr.remove();

  const tbody = document.querySelector("#tblPendingRight tbody");
  if (!tbody) return;
  const hasAny = tbody.querySelector("tr[data-row]") != null;
  if (!hasAny) {
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Kh√¥ng c√≥ ƒë∆°n ch·ªù</td></tr>";
  }
}

function _pendingUpdateRow_(row){
  if (!row || !row.row) return;
  const tr = _pendingFindRowTr_(row.row);
  if (!tr) return;

  const dateStr = row.dateStr || "";
  const info = row.info || "";
  const soMam = Number(row.soMam || 0) || 0;
  const soMon = Number(row.soMon || 0) || 0;
  const tong = Number(row.tongDon || 0) || 0;
  const status = row.trangThai || "ƒê∆°n ch·ªù";

  const mamText = soMam ? (soMam + (soMon ? (" ("+soMon+" m√≥n)") : "")) : "";

  // gi·ªØ nguy√™n n√∫t h√†nh ƒë·ªông (tr.innerHTML rebuild) ƒë·ªÉ c·∫≠p nh·∫≠t text
  const actionTd = tr.querySelector("td:last-child");
  const actionHtml = actionTd ? actionTd.innerHTML : "";

  tr.innerHTML = `
      <td>${escapeHtml(dateStr)}</td>
      <td>${escapeHtml(info)}</td>
      <td style="text-align:center;">${escapeHtml(mamText)}</td>
      <td style="text-align:right;">${formatMoney(tong)} ƒë</td>
      <td><span class="status-pill status-pending">${escapeHtml(status)}</span></td>
      <td style="text-align:center; white-space:nowrap;">${actionHtml}</td>
  `;
}


function openPrintInvoicePending(rowIndex){
  if (!rowIndex) return;

  const ov = document.getElementById("printInvoiceOverlay");
  const content = document.getElementById("printInvoiceContent");
  const inp = document.getElementById("invoiceNoInput");
  if (!ov || !content || !inp) return;

  const cb = document.getElementById("printIncludeTax");
  if (cb) cb.checked = !!ENABLE_TAX;
  const includeTax = cb ? !!cb.checked : !!ENABLE_TAX;

  content.innerHTML = "";
  inp.value = "";
  inp.style.display = "inline-block";

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      res = coerceGsResponse_(res);
      if (!res || !res.ok) {
        alert((res && res.error) ? res.error : "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu in.");
        return;
      }
      const invoiceNo = String(res.invoiceNo || "").trim();
      inp.value = invoiceNo;

      if (cb && typeof res.includeTax !== "undefined") cb.checked = !!res.includeTax;

      CURRENT_PRINT_TAGROW = "P:" + String(rowIndex);
      CURRENT_PRINT_ROWINDEX = rowIndex;
      CURRENT_PRINT_HEADER = { ok: true, header: res.header || {}, items: res.items || [] };

      const tax = (cb ? !!cb.checked : includeTax);

      content.innerHTML = buildInvoiceHtml(res.header || {}, res.items || [], invoiceNo, tax);

      ov.style.display = "flex";
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói in ƒë∆°n ch·ªù: " + (err && err.message ? err.message : err));
    })
    .getInvoiceHtmlByPendingRow(rowIndex, CURRENT_USERNAME, includeTax);
}



function deletePendingRight(rowIndex) {
  if (!rowIndex) return;
  if (!confirmDelete("Xo√° ƒë∆°n ch·ªù n√†y?")) return;

  const delRow = Number(rowIndex || 0);

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if (res && res.ok === false) {
        alert(res.error || "Xo√° th·∫•t b·∫°i.");
        return;
      }
      const deletedRow = (res && res.deletedRow) ? Number(res.deletedRow) : delRow;
      _pendingRemoveRow_(deletedRow);
      _pendingShiftRowsAfterDelete_(deletedRow);
      // v·∫´n refresh dashboard nh·∫π n·∫øu c·∫ßn
      scheduleRefreshAll_({ debt:false, customers:false, dashboard:true });
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói xo√° ƒë∆°n ch·ªù: " + (err && err.message ? err.message : err));
    })
    .ui_deletePending(delRow, CURRENT_USERNAME);
}

/* ---------- POPUP S·ª¨A ƒê∆†N CH·ªú ---------- */

function openPendingEditPopup(rowIndex) {
    if (!rowIndex) return;
    showLoading("ƒêang m·ªü ƒë∆°n...");
    google.script.run
      .withSuccessHandler(res => {
        hideLoading();
        if (!res || !res.ok) {
          alert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c ƒë∆°n ch·ªù: " + ((res && res.error) || "Kh√¥ng x√°c ƒë·ªãnh"));
          return;
        }
        ST.PENDING_EDIT_ROW = rowIndex;
        // set hidden row index for payload
        try { const el = document.getElementById("peRowIndex"); if (el) el.value = String(rowIndex); } catch(e) {}


        const h = res.header || {};
        try { const oidEl=document.getElementById("peOrderId"); if(oidEl) oidEl.value=String(h.orderId||""); } catch(e) {}
        setVal_("peNgay", ymdFromAnyDate_(h.ngay || h.date || h.dateStr || h.ngayStr));
        setVal_("peTenKH", h.tenKH || h.tenKh || "");
        setVal_("peSdt", h.sdt || "");
        setVal_("peDiaChi", h.diaChi || "");
        setVal_("peSoMam", h.soMam || "");
        setVal_("peKmNoiDung", h.kmNoiDung || "");
        setVal_("peKmSoTien", formatMoney(h.kmSoTien || 0));
        setVal_("peDatCoc", formatMoney(h.datCoc || 0)); 
        renderPendingEditItems_(res.items || []);

        const ov = document.getElementById("editPopupOverlay") || document.getElementById("pendingEditOverlay");
        if (ov) { if (ov && ov.style) ov.style.display = "flex"; setModalOpen_(true); }

        // init menu suggest + watchers (once)
        try { peInitMenuSearchOnce_(); } catch(e) {}
        try { peBindTotalsWatchers_(); } catch(e) {}
        try { peRecalcAllTotals_(); } catch(e) {}

      })
      .withFailureHandler(err => {
        hideLoading();
        alert("L·ªói m·ªü ƒë∆°n ch·ªù: " + (err && err.message ? err.message : err));
      })
      .ui_getPendingDetail(rowIndex);
  }


function fillPendingEditPopup(rowIndex, h, items) {
  document.getElementById("peRowIndex").value = String(rowIndex || "");

  const ymd = String(h.ngay || "").trim(); // server tr·∫£ ngay = yyyy-MM-dd
  document.getElementById("peNgay").value = ymd || "";

  document.getElementById("peNguoiLap").value = h.nguoiLap || "";
  document.getElementById("peTrangThai").value = (h.trangThai || "");
  document.getElementById("peSdt").value = h.sdt || "";
  document.getElementById("peTenKH").value = h.tenKH || "";
  document.getElementById("peDiaChi").value = h.diaChi || "";

  document.getElementById("peSoMam").value = (Number(h.soMam || 0) || 0);
  document.getElementById("peKmNoiDung").value = h.kmNoiDung || "";
  document.getElementById("peKmSoTien").value = formatMoney(Number(h.kmSoTien || 0) || 0);

  // 3 field readonly (c√≥ th·ªÉ server c√≥, nh∆∞ng UI s·∫Ω t·ª± t√≠nh l·∫°i)
  const peDonGiaMam = document.getElementById("peDonGiaMam");
  const peTongDon = document.getElementById("peTongDon");
  const peDoanhSo = document.getElementById("peDoanhSo");
  if (peDonGiaMam) peDonGiaMam.value = formatMoney(Number(h.donGiaMam || 0) || 0);
  if (peTongDon) peTongDon.value = formatMoney(Number(h.tongDon || 0) || 0);
  if (peDoanhSo) peDoanhSo.value = ""; // s·∫Ω ·∫©n kh·ªëi doanh s·ªë

  peRenderItems(items || []);
  peInitMenuSearchOnce_();
}
function peArrangePendingEditLayout_() {
  injectPendingPopupStyles_();

  const ov = document.getElementById("editPopupOverlay");
  const popup = ov ? ov.querySelector(".edit-popup") : null;
  if (!popup) return;

  // Field wrappers
  const fKmNote = document.getElementById("peKmNoiDung")?.closest(".field");
  const fKmAmt  = document.getElementById("peKmSoTien")?.closest(".field");
  const fSoMam  = document.getElementById("peSoMam")?.closest(".field");
  const fDonGia = document.getElementById("peDonGiaMam")?.closest(".field");
  const fTong   = document.getElementById("peTongDon")?.closest(".field");
  const fDoanhSo= document.getElementById("peDoanhSo")?.closest(".field");

  // ·∫®n doanh s·ªë
  if (fDoanhSo) fDoanhSo.style.display = "none";

  // Khu m√≥n (card)
  const cardMon = popup.querySelector(".card.allow-overflow");

  // Footer actions (n√∫t L∆∞u/Hu·ª∑) -> ƒë∆∞a xu·ªëng d∆∞·ªõi c√πng
  let footer = popup.querySelector(".footer-actions");
  if (!footer) {
    footer = document.createElement("div");
    footer.className = "footer-actions";

    const btnCancel = popup.querySelector("button.secondary[onclick*='closePendingEditPopup']") || popup.querySelector("button.secondary");
    const btnSave   = popup.querySelector("button.primary[onclick*='savePendingEditPopup']") || popup.querySelector("button.primary");
    if (btnCancel) footer.appendChild(btnCancel);
    if (btnSave) footer.appendChild(btnSave);
    popup.appendChild(footer);
  } else {
    popup.appendChild(footer);
  }

  // Row KM: n·ªôi dung + s·ªë ti·ªÅn (1 d√≤ng)
  const rowKm = document.createElement("div");
  rowKm.className = "row";
  if (fKmNote) { fKmNote.style.flex="2"; rowKm.appendChild(fKmNote); }
  if (fKmAmt)  { fKmAmt.style.flex="1"; rowKm.appendChild(fKmAmt); }

  // Row T·ªïng: s·ªë m√¢m + ƒë∆°n gi√°/m√¢m + t·ªïng ƒë∆°n (1 d√≤ng)
  const rowTotal = document.createElement("div");
  rowTotal.className = "row";
  if (fSoMam)  rowTotal.appendChild(fSoMam);
  if (fDonGia) rowTotal.appendChild(fDonGia);
  if (fTong)   rowTotal.appendChild(fTong);

  // Xo√° c√°c row c≈© ch·ª©a c√°c field n√†y (tr√°nh l·∫∑p)
  [fKmNote,fKmAmt,fSoMam,fDonGia,fTong].forEach(f=>{
    const r = f ? f.closest(".row") : null;
    if (r && r.parentNode === popup) r.remove();
  });

  // Ch√®n ngay tr∆∞·ªõc card m√≥n
  if (cardMon) {
    popup.insertBefore(rowKm, cardMon);
    popup.insertBefore(rowTotal, cardMon);
  } else {
    popup.appendChild(rowKm);
    popup.appendChild(rowTotal);
  }
}



function closePendingEditPopup() {
  const ov = document.getElementById("editPopupOverlay") || document.getElementById("pendingEditOverlay");
  if (ov && ov.style) ov.style.display = "none";
  try { if (typeof ST !== "undefined" && ST) ST.PENDING_EDIT_ROW = null; } catch(e) {}
  try { const el = document.getElementById("peRowIndex"); if (el) el.value = ""; } catch(e) {}
  try { const el = document.getElementById("peOrderId"); if (el) el.value = ""; } catch(e) {}
  refreshModalOpenState_();
}

function fillPendingEditPopup(rowIndex, h, items) {
  document.getElementById("peRowIndex").value = String(rowIndex || "");
  document.getElementById("peNgay").value = (h.ngay || "");
  document.getElementById("peNguoiLap").value = h.nguoiLap || "";
  document.getElementById("peTrangThai").value = (h.trangThai || "");
  document.getElementById("peSdt").value = h.sdt || "";
  document.getElementById("peTenKH").value = h.tenKH || "";
  document.getElementById("peDiaChi").value = h.diaChi || "";
  document.getElementById("peSoMam").value = (Number(h.soMam || 0) || 0);
  document.getElementById("peKmNoiDung").value = h.kmNoiDung || "";
  document.getElementById("peKmSoTien").value = formatMoney(Number(h.kmSoTien || 0) || 0);

  peRenderItems(items || []);
  peInitMenuSearchOnce_();
  peRecalcAllTotals_();
  const el = document.getElementById("peTenKH"); if (el) el.focus();
}

function peRenderItems(items) {
  const tbody = document.querySelector("#peTblMon tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  (items || []).forEach((it, i) => {
    peAddRow_(i + 1, {
      tenMon: it.tenMon || it.ten || "",
      dvt: it.dvt || "",
      sl: Number(it.sl || 0) || 0,
      donGia: Number(it.donGia || it.gia || 0) || 0,
      loaiMon: String(it.loaiMon || "").trim()
    });
  });

  if (!items || !items.length) {
    peAddRow_(1, { tenMon:"", dvt:"", sl:0, donGia:0 });
  }
  peReindex_();
}

function peAddEmptyRow(prefill) {
  peAddRow_(null, prefill || { tenMon:"", dvt:"", sl:1, donGia:0 });
  peReindex_();
}

function peAddRow_(idx, it) {
  const tbody = document.querySelector("#peTblMon tbody");
  if (!tbody) return;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="pe-idx" style="text-align:center;">${idx || ""}</td>
    <td><input class="pe-tenMon" type="text" value="${escapeHtmlAttr(it.tenMon || "")}"></td>
    <td><input class="pe-dvt" type="text" value="${escapeHtmlAttr(it.dvt || "")}"></td>
    <td><input class="pe-sl" type="number" min="0" step="1" value="${Number(it.sl || 0) || 0}"></td>
    <td><input class="pe-gia money-input" type="text" value="${formatMoney(Number(it.donGia || 0) || 0)}"></td>
    <td class="pe-tt" style="text-align:right;"></td>
    <td style="text-align:center;"><button type="button" class="icon-btn" title="Xo√° d√≤ng" onclick="peRemoveRow_(this)">‚úñ</button></td>
  `;
  tr.dataset.loaiMon = String(it.loaiMon || "");
  tbody.appendChild(tr);

  const slEl = tr.querySelector(".pe-sl");
  const giaEl = tr.querySelector(".pe-gia");
  if (slEl) slEl.addEventListener("input", peRecalcAllTotals_);
  if (giaEl) giaEl.addEventListener("input", peRecalcAllTotals_);

  peRecalcAllTotals_();
}

function peRemoveRow_(btn) {
  const tr = btn.closest("tr");
  if (tr) tr.remove();
  peReindex_();
  peRecalcAllTotals_();
}

function peReindex_() {
  const rows = document.querySelectorAll("#peTblMon tbody tr");
  rows.forEach((tr, i) => {
    const idx = tr.querySelector(".pe-idx");
    if (idx) idx.textContent = String(i + 1);
  });
}


function peBindTotalsWatchers_() {
  if (window.__PE_WATCHERS_BINDED) return;
  window.__PE_WATCHERS_BINDED = true;
  const soMamEl = document.getElementById("peSoMam");
  const kmEl = document.getElementById("peKmSoTien");
  if (soMamEl) soMamEl.addEventListener("input", peRecalcAllTotals_);
  if (kmEl) kmEl.addEventListener("input", peRecalcAllTotals_);
}

function peRecalcAllTotals_() {
  // line totals
  peRecalcTotals_();

  const soMam = Number(document.getElementById("peSoMam")?.value || 0) || 0;
  const km = Math.max(0, parseMoney(document.getElementById("peKmSoTien")?.value || "0"));

  let donGiaMam = 0;
  document.querySelectorAll("#peTblMon tbody tr").forEach(tr => {
    const sl = Number(tr.querySelector(".pe-sl")?.value || 0) || 0;
    const gia = parseMoney(tr.querySelector(".pe-gia")?.value || "0");
    if (sl > 0 && gia >= 0) donGiaMam += sl * gia;
  });

  const tongDon = donGiaMam * Math.max(0, soMam);
  const doanhSo = Math.max(0, tongDon - km);

  const peDonGiaMam = document.getElementById("peDonGiaMam");
  const peTongDon = document.getElementById("peTongDon");
  const peDoanhSo = document.getElementById("peDoanhSo");
  if (peDonGiaMam) peDonGiaMam.value = formatMoney(donGiaMam);
  if (peTongDon) peTongDon.value = formatMoney(tongDon);
  if (peDoanhSo) peDoanhSo.value = formatMoney(doanhSo);
}

function peRecalcTotals_() {
  const rows = document.querySelectorAll("#peTblMon tbody tr");
  rows.forEach(tr => {
    const sl = Number(tr.querySelector(".pe-sl")?.value || 0) || 0;
    const gia = parseMoney(tr.querySelector(".pe-gia")?.value || "0");
    const tt = sl * gia;
    const cell = tr.querySelector(".pe-tt");
    if (cell) cell.textContent = formatMoney(tt) + " ƒë";
  });
}

function peInitMenuSearchOnce_() {
  const inp = document.getElementById("peMenuSearch");
  const listEl = document.getElementById("peMenuList");
  if (!inp || !listEl) return;

  // ‚úÖ element m·ªõi (popup edit render l·∫°i) s·∫Ω ch∆∞a c√≥ flag -> bind l·∫°i ƒë∆∞·ª£c
  if (inp.dataset.menuInited === "1") return;
  inp.dataset.menuInited = "1";

  function hide() {
    listEl.style.display = "none";
    listEl.innerHTML = "";
  }

  function render() {
    const qRaw = inp.value || "";
    const q = normalizeTextClient(qRaw);
    if (!q) return hide();

    const hits = (MENU || [])
      .filter(x => normalizeTextClient(menuName_(x)).includes(q))
      .slice(0, 30);

    if (!hits.length) return hide();

    listEl.innerHTML = "";
    hits.forEach((m) => {
      const div = document.createElement("div");
      div.className = "ac-item";
      div.innerHTML = `
        <div class="ac-left">
          <div class="ac-name">${escHtml(menuName_(m))}</div>
          <div class="ac-sub">${escHtml(menuUnit_(m) || "")}</div>
        </div>
        <div class="ac-price">${formatMoney(menuPrice_(m) || 0)} ƒë</div>
      `;
      div.addEventListener("mouseenter", () => {
        try {
          listEl.querySelectorAll(".ac-item.active").forEach(x => x.classList.remove("active"));
          div.classList.add("active");
        } catch(e) {}
      });
            div.addEventListener("mousedown", (e) => {
        e.preventDefault();
        peAddMenuToPendingEdit_(m);   // gi·ªØ nguy√™n h√†m add m√≥n c·ªßa b·∫°n
        inp.value = "";
        hide();
      });
      listEl.appendChild(div);
    });
    listEl.style.display = "block";
  }

  inp.addEventListener("input", render);
  inp.addEventListener("focus", render);
  inp.addEventListener("keydown", (e) => { if (e.key === "Escape") hide(); });
  inp.addEventListener("blur", () => setTimeout(hide, 150));
}




function peAddMenuToPendingEdit_(m){
  const tenMon = menuName_(m);
  if (!tenMon) return;
  const dvt = menuUnit_(m);
  const gia = menuPrice_(m);
  const loaiMon = menuType_(m);

  // ∆∞u ti√™n fill v√†o d√≤ng tr·ªëng ƒë·∫ßu ti√™n
  const trs = document.querySelectorAll("#peTblMon tbody tr");
  let filled = false;
  trs.forEach(tr => {
    if (filled) return;
    const tenEl = tr.querySelector(".pe-tenMon");
    if (tenEl && !String(tenEl.value || "").trim()) {
      tenEl.value = tenMon;
      const dvtEl = tr.querySelector(".pe-dvt");
      const slEl  = tr.querySelector(".pe-sl");
      const giaEl = tr.querySelector(".pe-gia");
      if (dvtEl) dvtEl.value = dvt || "";
      if (slEl && (Number(slEl.value||0) || 0) === 0) slEl.value = 1;
      if (giaEl) giaEl.value = formatMoney(gia);
      tr.dataset.loaiMon = loaiMon || "";
      filled = true;
    }
  });

  if (!filled) {
    peAddRow_(null, { tenMon: tenMon, dvt: dvt || "", sl: 1, donGia: gia, loaiMon: loaiMon || "" });
    peReindex_();
  }

  peRecalcAllTotals_();
}

function collectPendingEditPayload_() {
  const rowIndex = Number(document.getElementById("peRowIndex").value || 0);
  const orderId = String(document.getElementById("peOrderId").value || "").trim();
  const ngay = document.getElementById("peNgay").value;
  const nguoiLap = String((window.CURRENT_USERNAME || document.getElementById("peNguoiLap").value || "")).trim();
  const trangThai = document.getElementById("peTrangThai").value;
  const sdt = document.getElementById("peSdt").value.trim();
  const tenKH = document.getElementById("peTenKH").value.trim();
  const diaChi = document.getElementById("peDiaChi").value.trim();
  const soMam = Number(document.getElementById("peSoMam").value || 0) || 0;
  const kmNoiDung = document.getElementById("peKmNoiDung").value.trim();
  const kmSoTien = parseMoney(document.getElementById("peKmSoTien").value || "0");
  const datCoc = parseMoney(document.getElementById("peDatCoc")?.value || "0");
  const rows = Array.from(document.querySelectorAll("#peTblMon tbody tr"));
  const items = [];
  rows.forEach(tr => {
    const tenMon = (tr.querySelector(".pe-tenMon")?.value || "").trim();
    const dvt = (tr.querySelector(".pe-dvt")?.value || "").trim();
    const sl = Number(tr.querySelector(".pe-sl")?.value || 0) || 0;
    const gia = parseMoney(tr.querySelector(".pe-gia")?.value || "0");
    if (!tenMon && !sl && !gia) return;
    const key = normalizeTextClient(tenMon);
    const menuHit = MENU_INDEX[key];
    const loaiMon = (tr.dataset.loaiMon || "") || (menuHit && menuHit.loaiMon ? menuHit.loaiMon : "");
    items.push({ tenMon, dvt: dvt || "ƒêƒ©a", sl, donGia: gia, loaiMon });
  });

  return {
    meta: { row: rowIndex, orderId: orderId },
    header: { ngay, nguoiLap, trangThai, sdt, tenKH, diaChi, soMam, kmNoiDung, kmSoTien,datCoc: datCoc},
    items
  };
}

function savePendingEditPopup() {
    const rowIndex = ST.PENDING_EDIT_ROW;
    if (!rowIndex) return;

    const payload = collectPendingEditPayload_();
    payload.meta = payload.meta || {};
    payload.meta.row = Number(rowIndex || 0);
    payload.meta.rowIndex = Number(rowIndex || 0);
    payload.meta.username = String(window.CURRENT_USERNAME || "").trim();
    payload.meta.displayName = String("<?= displayName ?>" || "").trim();

    const overlay = document.getElementById("editPopupOverlay") || document.getElementById("pendingEditOverlay");

    const sdt = String(payload.header && payload.header.sdt ? payload.header.sdt : (payload.sdt || "")).trim();

    showLoading("ƒêang l∆∞u...");
    google.script.run
      .withSuccessHandler(async res => {
        hideLoading();

        if (!res || res.ok === false) {
          alert((res && res.error) ? res.error : "L∆∞u th·∫•t b·∫°i.");
          return;
        }

        // DEBUG: Hi·ªÉn th·ªã debug info t·ª´ server
        if (res.debug) {
          console.log('SERVER DEBUG:', res.debug);
          alert('DEBUG: itemCount=' + res.debug.itemCount +
                ', itemStart=' + res.debug.itemStart +
                ', itemEnd=' + res.debug.itemEnd +
                ', datCoc=' + res.debug.datCoc +
                ', lastRow=' + res.debug.lastRow);
        }

        // ƒë√≥ng popup
        if (overlay && overlay.style) overlay.style.display = "none";
        closePendingEditPopup();

        if (res.moved) {
          const deletedRow = Number(res.deletedRow || rowIndex);
          _pendingRemoveRow_(deletedRow);
          _pendingShiftRowsAfterDelete_(deletedRow);
        } else if (res.updatedRow) {
          _pendingUpdateRow_(res.updatedRow);
        } else {
          // fallback
          await loadPendingAllRight();
        }

        // history theo SƒêT v·∫´n n√™n reload (nh·∫π h∆°n pending list)
        try { if (sdt) await loadHistoryByPhoneRight(sdt); } catch(e) {}

        scheduleRefreshAll_({ debt:true, customers:true, dashboard:true });
      })
      .withFailureHandler(err => {
        hideLoading();
        alert("L·ªói l∆∞u ƒë∆°n ch·ªù: " + (err && err.message ? err.message : err));
      })
      .ui_savePendingEdit(payload);
  }


/* ---------- HISTORY (l·ªçc theo SƒêT) ---------- */

function loadHistoryByPhoneRight(phone) {
  const p = String(phone || "").trim();

  try { __HISTORY_PHONE = p; } catch(e) {}

  const wrap = document.getElementById("rightHistoryWrap");
  const tbody = document.querySelector("#tblHistoryRight tbody");
  const detail = document.getElementById("historyDetailRight");
  const hint = document.getElementById("rightHistoryHint");

  if (!wrap || !tbody) return Promise.resolve([]);

  if (detail) detail.innerHTML = "";
  tbody.innerHTML = "";

  if (!p) {
    if (hint) hint.style.display = "";
    return Promise.resolve([]);
  }
  if (hint) hint.style.display = "none";

  if (typeof setSectionLoading_ === "function") setSectionLoading_(wrap, true, "ƒêang t·∫£i l·ªãch s·ª≠...");

  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler((res) => {
        if (typeof setSectionLoading_ === "function") setSectionLoading_(wrap, false);

        const rows = _normRows_(res);
        try { __HISTORY_CACHE = rows || []; } catch(e) {}

        if (typeof renderHistoryRight === "function") renderHistoryRight(rows || []);

        // auto ch·ªçn d√≤ng ƒë·∫ßu ƒë·ªÉ hi·ªán chi ti·∫øt + n√∫t In
        try {
          const first = rows && rows.length ? (rows[0].row || rows[0].rowIndex) : null;
          if (first) selectHistoryRowRight(first);
        } catch (e) {}

        resolve(rows || []);
      })
      .withFailureHandler((err) => {
        if (typeof setSectionLoading_ === "function") setSectionLoading_(wrap, false);
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠: " + (err && err.message ? err.message : err));
        reject(err);
      })
      .listDebtByPhone(p);
  });
}

function renderHistoryRight(rows) {
  const tbody = document.querySelector("#tblHistoryRight tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  if (!rows || !rows.length) {
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Kh√¥ng c√≥ l·ªãch s·ª≠</td></tr>";
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = "hist-row";
    tr.dataset.row = String(r.row || "");
    tr.style.cursor = "pointer";

    const dateStr = r.dateStr || r.date || "";
    const info = r.info || "";
    const soMam = Number(r.soMam || 0) || 0;
    const soMon = Number(r.soMon || 0) || 0;
    const tong = Number(r.tongDon || 0) || 0;
    const status = String(r.trangThai || r.status || "").trim();

    const mamText = `${soMam}${soMon ? ` (${soMon} m√≥n)` : ""}`;

    tr.innerHTML = `
      <td>${escapeHtml(dateStr)}</td>
      <td>${escapeHtml(info)}</td>
      <td style="text-align:center;">${escapeHtml(mamText)}</td>
      <td style="text-align:right;">${formatMoney(tong)} ƒë</td>
      <td><span class="status-pill ${status === "ƒê√£ thanh to√°n" ? "status-paid" : (status === "Ghi n·ª£" ? "status-debt" : "status-unpaid")}">${escapeHtml(status || "")}</span></td>
    `;

    tr.addEventListener("click", () => selectHistoryRowRight(r.row));
    tbody.appendChild(tr);
  });
}

function peArrangeLayoutLikeOrder_() {
  const ov = document.getElementById("editPopupOverlay");
  if (!ov) return;

  // 1) B·ªè kh·ªëi doanh s·ªë
  const doanhSoField = document.getElementById("peDoanhSo")?.closest(".field");
  if (doanhSoField) doanhSoField.style.display = "none";

  // 2) Move kh·ªëi "S·ªë m√¢m + KM" v√† kh·ªëi "T·ªïng" xu·ªëng d∆∞·ªõi card Chi ti·∫øt m√≥n (gi·ªëng phi·∫øu nh·∫≠p)
  const card = ov.querySelector(".card.allow-overflow");
  if (!card) return;

  const rowSoMamKm = document.getElementById("peSoMam")?.closest(".row");
  const rowTotals = document.getElementById("peDonGiaMam")?.closest(".row");
  if (rowSoMamKm && rowTotals) {
    // insert after card
    card.parentNode.insertBefore(rowSoMamKm, card.nextSibling);
    card.parentNode.insertBefore(rowTotals, rowSoMamKm.nextSibling);
  }
}

function selectHistoryRowRight(rowIndex) {
  if (!rowIndex) return;

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if (!res || res.ok === false) return alert(res && res.error ? res.error : "Kh√¥ng l·∫•y ƒë∆∞·ª£c chi ti·∫øt l·ªãch s·ª≠.");

      renderHistoryDetailRight(rowIndex, res.header || {}, res.items || []);
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói m·ªü chi ti·∫øt l·ªãch s·ª≠: " + (err && err.message ? err.message : err));
    })
    .ui_getDebtDetail(rowIndex);
}
function applyRolePermissions_() {
  const role = String(window.USER_ROLE || "").toLowerCase();

  // tab buttons
  const btnOrder = document.querySelector(".tab-button[data-tab='tab-order']");
  const btnDebt  = document.querySelector(".tab-button[data-tab='tab-debt']");
  const btnCus   = document.querySelector(".tab-button[data-tab='tab-customer']");
  const btnMenu  = document.querySelector(".tab-button[data-tab='tab-menu']");
  const btnDash  = document.querySelector(".tab-button[data-tab='tab-dashboard']");

  const paneOrder = document.getElementById("tab-order");
  const paneDebt  = document.getElementById("tab-debt");
  const paneCus   = document.getElementById("tab-customer");
  const paneMenu  = document.getElementById("tab-menu");
  const paneDash  = document.getElementById("tab-dashboard");

  // gpt button/slider
  const gptBtn = document.getElementById("gptBtn") || document.querySelector("[onclick*='openGptSlider']");

  const hide = (btn, pane) => {
    if (btn) btn.style.display = "none";
    if (pane) pane.style.display = "none";
  };
  const show = (btn, pane) => {
    if (btn) btn.style.display = "";
    if (pane) pane.style.display = "";
  };

  // default: admin th·∫•y t·∫•t
  show(btnOrder,paneOrder); show(btnDebt,paneDebt); show(btnCus,paneCus); show(btnMenu,paneMenu); show(btnDash,paneDash);
  if (gptBtn) gptBtn.style.display = "";

  if (role === "cashier") {
    // cashier: Phi·∫øu nh·∫≠p + C√¥ng n·ª£ (tab-customer). Kh√¥ng c√≥ GPT. Kh√¥ng th·ª±c ƒë∆°n/dashboard/doanh s·ªë
    show(btnOrder,paneOrder);
    show(btnCus,paneCus);
    hide(btnDebt,paneDebt);
    hide(btnMenu,paneMenu);
    hide(btnDash,paneDash);
    if (gptBtn) gptBtn.style.display = "none";
    switchTab("tab-order");
    return;
  }

  if (role === "manager") {
    // manager: tr·ª´ phi·∫øu nh·∫≠p xem h·∫øt
    hide(btnOrder,paneOrder);
    show(btnDebt,paneDebt);
    show(btnCus,paneCus);
    show(btnMenu,paneMenu);
    show(btnDash,paneDash);
    // manager c√≥ GPT hay kh√¥ng? b·∫°n kh√¥ng c·∫•m -> gi·ªØ
    switchTab("tab-debt");
    return;
  }

  // admin ho·∫∑c role kh√°c -> gi·ªØ m·∫∑c ƒë·ªãnh
}


function renderHistoryDetailRight(rowIndex, h, items) {
  const box = document.getElementById("historyDetailRight");
  if (!box) return;

  const orderId = h.orderId || "";

  let itemsHtml = "";
  if (items && items.length) {
    itemsHtml = items.map((it, i) => {
      const ten = it.tenMon || it.ten || "";
      const dvt = it.dvt || "";
      const sl = Number(it.sl || 0) || 0;
      const gia = Number(it.donGia || it.gia || 0) || 0;
      const tt = Number(it.thanhTien || (sl * gia) || 0) || 0;
      return `
        <tr>
          <td style="text-align:center;">${i + 1}</td>
          <td>${escapeHtml(ten)}</td>
          <td style="text-align:center;">${escapeHtml(dvt)}</td>
          <td style="text-align:right;">${sl}</td>
          <td style="text-align:right;">${formatMoney(gia)} ƒë</td>
          <td style="text-align:right;">${formatMoney(tt)} ƒë</td>
        </tr>
      `;
    }).join("");
  } else {
    itemsHtml = `<tr><td colspan="6" style="text-align:center;">(Kh√¥ng c√≥ chi ti·∫øt m√≥n)</td></tr>`;
  }

  const ngay = String(h.ngay || h.date || "").trim();
  const kmNote = String(h.kmNoiDung || "").trim();
  const kmAmt = Number(h.kmSoTien || 0) || 0;
  const donGiaMam = Number(h.donGiaMam || 0) || 0;
  const soMam = Number(h.soMam || 0) || 0;
  const tongDon = Number(h.tongDon || 0) || 0;
  const status = String(h.trangThai || "").trim();

  box.innerHTML = `
    <div class="card" style="margin-top:0;">
      <div class="flex-between" style="margin-top:0;">
        <div>
          <h2 style="margin:0;">Chi ti·∫øt ƒë∆°n</h2>
          <div style="margin-top:4px; font-size:15px; color:#567a67;">
            M√£ ƒë∆°n: <b>${escapeHtml(orderId || "")}</b>
          </div>
        </div>
        <div>
          <button type="button" class="primary" onclick="openPrintInvoice(${rowIndex})">üñ®Ô∏è In</button>
        </div>
      </div>

      <div style="margin-top:8px; font-size:16px;">
        <div><b>Ng√†y:</b> ${escapeHtml(ngay)}</div>
        <div><b>Kh√°ch:</b> ${escapeHtml(h.tenKH || "")} - ${escapeHtml(h.sdt || "")}</div>
        <div><b>ƒê·ªãa ch·ªâ:</b> ${escapeHtml(h.diaChi || "")}</div>

        <div style="margin-top:6px;">
          <b>KM:</b> ${escapeHtml(kmNote || "(kh√¥ng)")}${kmAmt ? ` | <b>${formatMoney(kmAmt)} ƒë</b>` : ""}
        </div>

        <div style="margin-top:6px;">
          <b>S·ªë m√¢m:</b> ${soMam}
          &nbsp; | &nbsp; <b>ƒê∆°n gi√°/m√¢m:</b> ${formatMoney(donGiaMam)} ƒë
          &nbsp; | &nbsp; <b>T·ªïng ƒë∆°n:</b> ${formatMoney(tongDon)} ƒë
          &nbsp; | &nbsp; <b>Tr·∫°ng th√°i:</b> ${escapeHtml(status)}
        </div>
      </div>

      <div class="table-wrap" style="margin-top:10px;">
        <table class="table table-compact">
          <thead>
            <tr>
              <th style="width:36px;">#</th>
              <th>T√™n m√≥n</th>
              <th style="width:80px;">ƒêVT</th>
              <th style="width:70px;">SL</th>
              <th style="width:110px;">ƒê∆°n gi√°</th>
              <th style="width:130px;">Th√†nh ti·ªÅn</th>
            </tr>
          </thead>
          <tbody>${itemsHtml}</tbody>
        </table>
      </div>
    </div>
  `;
}

function printDebtInvoiceRight(rowIndex) {
  rowIndex = Number(rowIndex || 0);
  if (!rowIndex) return;

  showLoading();
  google.script.run
    .withSuccessHandler(html => {
      hideLoading();
      doPrintHtml_(html || "");
    })
    .withFailureHandler(err => {
      hideLoading();
      alert("L·ªói t·∫°o phi·∫øu in: " + (err && err.message ? err.message : err));
    })
    .ui_getInvoiceHtmlByDebtRow(rowIndex);
}

function doPrintHtml_(html) {
  const frame = document.getElementById("printFrame");
  if (!frame || !frame.contentWindow) {
    alert("Thi·∫øu printFrame.");
    return;
  }
  const doc = frame.contentWindow.document;
  doc.open();
  doc.write("<!doctype html><html><head><meta charset='utf-8'><title>Print</title></head><body>" + html + "</body></html>");
  doc.close();
  setTimeout(() => {
    frame.contentWindow.focus();
    frame.contentWindow.print();
  }, 120);
}

/* ---------- Helpers ---------- */

function toInputDate_(ms) {
  try {
    const d = new Date(Number(ms || 0));
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${dd}`;
  } catch(e) { return ""; }
}

function toInputDateStr_(ddmmyyyy) {
  const s = String(ddmmyyyy || "").trim();
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (!m) return "";
  return `${m[3]}-${String(m[2]).padStart(2,"0")}-${String(m[1]).padStart(2,"0")}`;
}

function escapeHtml(s) {
  s = String(s === undefined || s === null ? "" : s);
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function escapeHtmlAttr(s) {
  return escapeHtml(s).replace(/`/g, "");
}

/* Init: load ƒë∆°n ch·ªù ngay khi v√†o app */
document.addEventListener("DOMContentLoaded", () => {
  try {
    bindPhoneAutofill_();
    loadPendingAllRight();
    switchRightTab("pending");
  } catch(e) {}
});

</script>

    <!-- GPT SLIDER -->
    <div id="gptSliderOverlay"
         style="display:none; position:fixed; inset:0;
                background:rgba(0,0,0,0.25); z-index:12000;
                justify-content:flex-end; align-items:stretch;">
      <div id="gptSliderBackdrop" style="flex:1;" onclick="closeGptSlider()"></div>

      <div class="gpt-slider" onclick="event.stopPropagation();">
        <div class="gpt-slider-header">
          <div class="gpt-slider-title">ü§ñ Chat GPT </div>
          <button type="button" class="gpt-close-btn" onclick="closeGptSlider()">√ó</button>
        </div>

        <div id="gptChatHistory" class="gpt-chat-history"></div>

        <textarea id="gptQuestion"
                  class="gpt-input"
                  placeholder="Nh·∫≠p c√¢u h·ªèi v√† nh·∫•n G·ª≠i ƒë·ªÉ ti·∫øp t·ª•c cu·ªôc tr√≤ chuy·ªán..."></textarea>

        <div class="gpt-footer">
          <button type="button" class="gpt-reset-btn" onclick="resetGptConversation()">üîÑ B·∫Øt ƒë·∫ßu l·∫°i</button>
          <button type="button" class="gpt-send-btn" onclick="sendGptQuestion()">G·ª≠i c√¢u h·ªèi</button>
        </div>

        <div id="gptError" class="gpt-error"></div>
      </div>
    </div>
  
  <iframe id="printFrame" style="display:none;"></iframe>
</body>
</html>
